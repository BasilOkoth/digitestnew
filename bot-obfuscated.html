<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Deriv DigitMatchStar Bot - OAuth Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        #log-area::-webkit-scrollbar { width: 4px; }
        #log-area::-webkit-scrollbar-thumb { background: #4ade80; border-radius: 2px; }
        #log-area::-webkit-scrollbar-track { background: #374151; }
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        @keyframes pulse-once { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.03); opacity: 0.9; } 100% { transform: scale(1); opacity: 1; } }
        .tick-flash { animation: pulse-once 0.1s ease-out; }
        @keyframes win-pulse { 
            0% { 
                box-shadow: 0 0 5px #10B981, 0 0 10px rgba(16, 185, 129, 0.5); 
                border-color: #10B981;
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2)) !important;
            } 
            50% { 
                box-shadow: 0 0 30px #10B981, 0 0 50px rgba(16, 185, 129, 0.8); 
                border-color: #34d399;
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.4)) !important;
            } 
            100% { 
                box-shadow: 0 0 5px #10B981, 0 0 10px rgba(16, 185, 129, 0.5); 
                border-color: #10B981;
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2)) !important;
            } 
        }
        .win-glow { animation: win-pulse 1s infinite; }
        .pnl-update-animation { animation: pnl-pulse 0.5s ease-in-out; }
        @keyframes pnl-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .contract-type-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; margin-left: 5px; }
        .stop-button-active { background-color: #dc2626 !important; border: 2px solid #fca5a5 !important; animation: pulse-once 0.5s infinite; }
        .start-button-active { background-color: #16a34a !important; border: 2px solid #86efac !important; animation: pulse-once 0.5s; }
        .analysis-active { border: 2px solid #00ffea !important; box-shadow: 0 0 10px rgba(0, 255, 234, 0.3) !important; }
        .analysis-complete { border: 2px solid #10b981 !important; background-color: #064e3b20 !important; }
        .connection-badge-connected { background: linear-gradient(90deg, #10b981, #059669) !important; }
        .connection-badge-disconnected { background: linear-gradient(90deg, #dc2626, #b91c1c) !important; }
        .connection-badge-connecting { background: linear-gradient(90deg, #f59e0b, #d97706) !important; }
        .account-toggle-container { display: inline-flex; align-items: center; margin-left: 15px; background: rgba(0, 0, 0, 0.3); padding: 2px 10px; border-radius: 20px; }
        .account-toggle { position: relative; display: inline-block; width: 44px; height: 22px; margin: 0 8px; }
        .account-toggle input { opacity: 0; width: 0; height: 0; }
        .account-toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #1e40af; border-radius: 34px; transition: .4s; }
        .account-toggle-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .4s; }
        input:checked + .account-toggle-slider { background-color: #059669; }
        input:checked + .account-toggle-slider:before { transform: translateX(22px); }
        .account-label { font-size: 12px; font-weight: 600; }
        .account-label-demo { color: #3b82f6; }
        .account-label-real { color: #10b981; }
        .profit-positive { color: #10b981 !important; font-weight: bold !important; }
        .profit-negative { color: #ef4444 !important; font-weight: bold !important; }
        .profit-neutral { color: #d1d5db !important; font-weight: bold !important; }
        .session-digit-locked { background: linear-gradient(135deg, #1e3a8a, #1e40af) !important; border: 2px solid #3b82f6 !important; color: white !important; }
        .status-win { color: #10b981 !important; font-weight: bold !important; text-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
        .status-loss { color: #ef4444 !important; font-weight: bold !important; }
        .status-trade { color: #f59e0b !important; font-weight: bold !important; }
        .calculator-highlight { background: linear-gradient(135deg, #7c3aed, #8b5cf6) !important; border: 1px solid #a78bfa !important; color: white !important; }
        .calculator-warning { background: linear-gradient(135deg, #dc2626, #ef4444) !important; border: 1px solid #f87171 !important; color: white !important; }
        .calculator-safe { background: linear-gradient(135deg, #059669, #10b981) !important; border: 1px solid #34d399 !important; color: white !important; }
        @keyframes calculator-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        .calculator-pulse { animation: calculator-pulse 0.5s ease-out; }
        .balance-green { color: #10b981 !important; font-weight: bold !important; }
        .network-recovery-badge { background: linear-gradient(90deg, #f59e0b, #d97706) !important; animation: pulse-once 0.8s infinite; }
        .digit-hot { background: linear-gradient(135deg, #ef4444, #dc2626) !important; color: white !important; border: 1px solid #f87171 !important; }
        .digit-warm { background: linear-gradient(135deg, #f59e0b, #d97706) !important; color: white !important; border: 1px solid #fbbf24 !important; }
        .digit-normal { background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important; color: white !important; border: 1px solid #60a5fa !important; }
        .digit-cold { background: linear-gradient(135deg, #10b981, #059669) !important; color: white !important; border: 1px solid #34d399 !important; }
        .digit-avoid { background: linear-gradient(135deg, #6b7280, #4b5563) !important; color: white !important; border: 1px solid #9ca3af !important; opacity: 0.7; }
        .gap-critical { background: linear-gradient(135deg, #7c3aed, #6d28d9) !important; color: white !important; border: 2px solid #a78bfa !important; animation: pulse-once 1s infinite; }
        .analysis-recommended { background: linear-gradient(135deg, #06b6d4, #0891b2) !important; color: white !important; border: 2px solid #22d3ee !important; }
        @keyframes analysis-pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.9; } 100% { transform: scale(1); opacity: 1; } }
        .analysis-pulse { animation: analysis-pulse 2s infinite; }
        .auth-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.95); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .auth-box { background: linear-gradient(135deg, #1e293b, #0f172a); padding: 2.5rem; border-radius: 1rem; border: 2px solid #3b82f6; width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7); }
        .oauth-btn { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s; width: 100%; margin: 10px 0; }
        .oauth-btn:hover { background: linear-gradient(135deg, #1d4ed8, #1e40af); transform: translateY(-2px); }
        .oauth-btn.demo { background: linear-gradient(135deg, #10b981, #059669); }
        .oauth-btn.demo:hover { background: linear-gradient(135deg, #059669, #047857); }
        .oauth-btn.logout { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .oauth-btn.logout:hover { background: linear-gradient(135deg, #dc2626, #b91c1c); }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <div id="authOverlay" class="auth-overlay hidden">
        <div class="auth-box">
            <h2 class="text-2xl font-bold text-blue-400 mb-2">üîê Deriv Authentication</h2>
            <p class="text-gray-300 mb-6">Connect your Deriv account to start trading</p>
            
            <div id="loginSection">
                <h3 class="text-lg font-semibold text-gray-200 mb-4">Choose Login Method:</h3>
                <button onclick="oauthLogin('demo')" class="oauth-btn demo">
                    Login with Demo Account
                </button>
                <button onclick="oauthLogin('real')" class="oauth-btn">
                    Login with Real Account
                </button>
            </div>
            
            <div id="accountInfo" class="hidden">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 rounded-full bg-blue-600 flex items-center justify-center mr-3">
                        <span class="text-white font-bold text-lg" id="accountAvatar">D</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-white" id="accountName">Demo Account</h3>
                        <p class="text-sm text-gray-300" id="accountId">VRTC123456</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-gray-800 rounded p-3">
                        <p class="text-xs text-gray-400">Balance</p>
                        <p class="text-lg font-bold text-green-400" id="accountBalance">$0.00</p>
                    </div>
                    <div class="bg-gray-800 rounded p-3">
                        <p class="text-xs text-gray-400">Account Type</p>
                        <p class="text-lg font-bold text-blue-400" id="accountType">-</p>
                    </div>
                </div>
                <button onclick="logout()" class="oauth-btn logout mt-4">Logout</button>
            </div>
            
            <div id="authStatus" class="mt-4 p-3 rounded text-sm hidden"></div>
        </div>
    </div>

    <div class="w-full max-w-6xl bg-gray-800 text-gray-100 shadow-2xl rounded-xl p-5 md:p-6">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-extrabold text-green-400 border-b border-gray-700 pb-2">
                DigitMatchStar Bot 
                <span id="status-badge" class="ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full connection-badge-disconnected text-white shadow-md">
                    üî¥ DISCONNECTED
                </span>
                <div class="account-toggle-container ml-3">
                    <span class="account-label account-label-demo">DEMO</span>
                    <label class="account-toggle">
                        <input type="checkbox" id="accTypeToggle" onchange="switchAccount()">
                        <span class="account-toggle-slider"></span>
                    </label>
                    <span class="account-label account-label-real">REAL</span>
                </div>
            </h1>
            <div class="flex items-center space-x-2">
                <button onclick="showAuth()" class="px-4 py-2 bg-purple-600 text-white font-bold rounded-lg shadow hover:bg-purple-700 transition">
                    üîë Account
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
             <div class="bg-gray-700 p-4 rounded-lg">
                <h3 class="text-lg font-bold mb-2">Metrics</h3>
                <p>Balance: <span id="metricAccountBalance">$0.00</span></p>
                <p>Status: <span id="metricTradeResult">IDLE</span></p>
             </div>
             <div id="log-area" class="bg-black text-green-500 h-40 overflow-y-auto p-2 font-mono text-xs rounded">
                [00:00:00] System Ready.
             </div>
        </div>

        <div class="flex justify-center">
            <button id="toggleButton" onclick="toggleBot()" class="w-full md:w-1/2 px-6 py-3 bg-green-600 text-white font-bold text-lg rounded-lg shadow-xl hover:bg-green-700">
                üöÄ START BOT
            </button>
        </div>
    </div>

    <script>
        const DERIV_CONFIG = {
            app_id: 120389,
            oauth_url: 'https://oauth.deriv.com/oauth2/authorize',
            redirect_uri: window.location.origin + window.location.pathname
        };

        window.oauthState = {
            isAuthenticated: false,
            currentToken: null,
            currentAccount: null,
            accounts: []
        };

        function log(msg, type = 'INFO') {
            const area = document.getElementById('log-area');
            const time = new Date().toLocaleTimeString();
            area.innerHTML += `[${time}] [${type}] ${msg}\n`;
            area.scrollTop = area.scrollHeight;
        }

        function showAuth() {
            document.getElementById('authOverlay').classList.remove('hidden');
        }

        function closeAuth() {
            document.getElementById('authOverlay').classList.add('hidden');
        }

        function oauthLogin(type) {
            const authUrl = `${DERIV_CONFIG.oauth_url}?app_id=${DERIV_CONFIG.app_id}&redirect_uri=${DERIV_CONFIG.redirect_uri}`;
            log(`Redirecting to Deriv for ${type} account...`, 'AUTH');
            window.location.href = authUrl;
        }

        function checkOAuthCallback() {
            const params = new URLSearchParams(window.location.search);
            const accounts = [];
            
            // Deriv returns acct1, token1, acct2, token2, etc.
            let i = 1;
            while (params.has(`acct${i}`)) {
                accounts.push({
                    account: params.get(`acct${i}`),
                    token: params.get(`token${i}`),
                    type: params.get(`acct${i}`).startsWith('VR') ? 'demo' : 'real'
                });
                i++;
            }

            if (accounts.length > 0) {
                window.oauthState.accounts = accounts;
                window.oauthState.currentAccount = accounts[0];
                window.oauthState.currentToken = accounts[0].token;
                window.oauthState.isAuthenticated = true;
                
                localStorage.setItem('deriv_accounts', JSON.stringify(accounts));
                
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
                updateAuthUI();
                log('‚úÖ Authenticated successfully', 'AUTH');
                return true;
            }

            // Fallback to local storage
            const stored = localStorage.getItem('deriv_accounts');
            if (stored) {
                const parsed = JSON.parse(stored);
                window.oauthState.accounts = parsed;
                window.oauthState.currentAccount = parsed[0];
                window.oauthState.currentToken = parsed[0].token;
                window.oauthState.isAuthenticated = true;
                updateAuthUI();
                return true;
            }
            return false;
        }

        function updateAuthUI() {
            if (window.oauthState.isAuthenticated && window.oauthState.currentAccount) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('accountInfo').classList.remove('hidden');
                document.getElementById('accountId').textContent = window.oauthState.currentAccount.account;
                document.getElementById('accountType').textContent = window.oauthState.currentAccount.type.toUpperCase();
                document.getElementById('accountAvatar').textContent = window.oauthState.currentAccount.account[0];
                
                const toggle = document.getElementById('accTypeToggle');
                toggle.checked = window.oauthState.currentAccount.type === 'real';
            } else {
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('accountInfo').classList.add('hidden');
            }
        }

        function logout() {
            localStorage.removeItem('deriv_accounts');
            window.oauthState.isAuthenticated = false;
            window.oauthState.currentToken = null;
            updateAuthUI();
            log('Logged out.', 'AUTH');
        }

        function switchAccount() {
            const isReal = document.getElementById('accTypeToggle').checked;
            const targetType = isReal ? 'real' : 'demo';
            const acc = window.oauthState.accounts.find(a => a.type === targetType);
            
            if (acc) {
                window.oauthState.currentAccount = acc;
                window.oauthState.currentToken = acc.token;
                updateAuthUI();
                log(`Switched to ${targetType} account.`, 'AUTH');
            } else {
                alert(`No ${targetType} account found. Please login again.`);
                document.getElementById('accTypeToggle').checked = !isReal;
            }
        }

        function toggleBot() {
            if (!window.oauthState.isAuthenticated) {
                alert('Please login first!');
                showAuth();
                return;
            }
            const btn = document.getElementById('toggleButton');
            if (btn.textContent.includes('START')) {
                btn.textContent = 'üõë STOP BOT';
                btn.classList.replace('bg-green-600', 'bg-red-600');
                log('Bot Starting...', 'SYSTEM');
            } else {
                btn.textContent = 'üöÄ START BOT';
                btn.classList.replace('bg-red-600', 'bg-green-600');
                log('Bot Stopped.', 'SYSTEM');
            }
        }

        window.onload = checkOAuthCallback;
    </script>
</body>
</html>
