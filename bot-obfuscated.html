<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Deriv DigitMatchStar Bot - OAuth Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        #log-area::-webkit-scrollbar { width: 4px; }
        #log-area::-webkit-scrollbar-thumb { background: #4ade80; border-radius: 2px; }
        #log-area::-webkit-scrollbar-track { background: #374151; }
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        @keyframes pulse-once { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.03); opacity: 0.9; } 100% { transform: scale(1); opacity: 1; } }
        .tick-flash { animation: pulse-once 0.1s ease-out; }
        @keyframes win-pulse { 
            0% { 
                box-shadow: 0 0 5px #10B981, 0 0 10px rgba(16, 185, 129, 0.5); 
                border-color: #10B981;
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2)) !important;
            } 
            50% { 
                box-shadow: 0 0 30px #10B981, 0 0 50px rgba(16, 185, 129, 0.8); 
                border-color: #34d399;
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.4)) !important;
            } 
            100% { 
                box-shadow: 0 0 5px #10B981, 0 0 10px rgba(16, 185, 129, 0.5); 
                border-color: #10B981;
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2)) !important;
            } 
        }
        .win-glow {
            animation: win-pulse 1s infinite;
        }
        .pnl-update-animation {
            animation: pnl-pulse 0.5s ease-in-out;
        }
        @keyframes pnl-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .contract-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        .stop-button-active {
            background-color: #dc2626 !important;
            border: 2px solid #fca5a5 !important;
            animation: pulse-once 0.5s infinite;
        }
        .start-button-active {
            background-color: #16a34a !important;
            border: 2px solid #86efac !important;
            animation: pulse-once 0.5s;
        }
        .analysis-active {
            border: 2px solid #00ffea !important;
            box-shadow: 0 0 10px rgba(0, 255, 234, 0.3) !important;
        }
        .analysis-complete {
            border: 2px solid #10b981 !important;
            background-color: #064e3b20 !important;
        }
        .connection-badge-connected {
            background: linear-gradient(90deg, #10b981, #059669) !important;
        }
        .connection-badge-disconnected {
            background: linear-gradient(90deg, #dc2626, #b91c1c) !important;
        }
        .connection-badge-connecting {
            background: linear-gradient(90deg, #f59e0b, #d97706) !important;
        }
        .account-toggle-container {
            display: inline-flex;
            align-items: center;
            margin-left: 15px;
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 10px;
            border-radius: 20px;
        }
        .account-toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
            margin: 0 8px;
        }
        .account-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .account-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #1e40af;
            border-radius: 34px;
            transition: .4s;
        }
        .account-toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: .4s;
        }
        input:checked + .account-toggle-slider {
            background-color: #059669;
        }
        input:checked + .account-toggle-slider:before {
            transform: translateX(22px);
        }
        .account-label {
            font-size: 12px;
            font-weight: 600;
        }
        .account-label-demo {
            color: #3b82f6;
        }
        .account-label-real {
            color: #10b981;
        }
        .profit-positive {
            color: #10b981 !important;
            font-weight: bold !important;
        }
        .profit-negative {
            color: #ef4444 !important;
            font-weight: bold !important;
        }
        .profit-neutral {
            color: #d1d5db !important;
            font-weight: bold !important;
        }
        .session-digit-locked {
            background: linear-gradient(135deg, #1e3a8a, #1e40af) !important;
            border: 2px solid #3b82f6 !important;
            color: white !important;
        }
        .status-win {
            color: #10b981 !important;
            font-weight: bold !important;
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        .status-loss {
            color: #ef4444 !important;
            font-weight: bold !important;
        }
        .status-trade {
            color: #f59e0b !important;
            font-weight: bold !important;
        }
        .calculator-highlight {
            background: linear-gradient(135deg, #7c3aed, #8b5cf6) !important;
            border: 1px solid #a78bfa !important;
            color: white !important;
        }
        .calculator-warning {
            background: linear-gradient(135deg, #dc2626, #ef4444) !important;
            border: 1px solid #f87171 !important;
            color: white !important;
        }
        .calculator-safe {
            background: linear-gradient(135deg, #059669, #10b981) !important;
            border: 1px solid #34d399 !important;
            color: white !important;
        }
        @keyframes calculator-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .calculator-pulse {
            animation: calculator-pulse 0.5s ease-out;
        }
        .balance-green {
            color: #10b981 !important;
            font-weight: bold !important;
        }
        .network-recovery-badge {
            background: linear-gradient(90deg, #f59e0b, #d97706) !important;
            animation: pulse-once 0.8s infinite;
        }
        .digit-hot {
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
            color: white !important;
            border: 1px solid #f87171 !important;
        }
        .digit-warm {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
            color: white !important;
            border: 1px solid #fbbf24 !important;
        }
        .digit-normal {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
            color: white !important;
            border: 1px solid #60a5fa !important;
        }
        .digit-cold {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            color: white !important;
            border: 1px solid #34d399 !important;
        }
        .digit-avoid {
            background: linear-gradient(135deg, #6b7280, #4b5563) !important;
            color: white !important;
            border: 1px solid #9ca3af !important;
            opacity: 0.7;
        }
        .gap-critical {
            background: linear-gradient(135deg, #7c3aed, #6d28d9) !important;
            color: white !important;
            border: 2px solid #a78bfa !important;
            animation: pulse-once 1s infinite;
        }
        .analysis-recommended {
            background: linear-gradient(135deg, #06b6d4, #0891b2) !important;
            color: white !important;
            border: 2px solid #22d3ee !important;
        }
        @keyframes analysis-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }
        .analysis-pulse {
            animation: analysis-pulse 2s infinite;
        }
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .auth-box {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            padding: 2.5rem;
            border-radius: 1rem;
            border: 2px solid #3b82f6;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
        }
        .oauth-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            width: 100%;
            margin: 10px 0;
        }
        .oauth-btn:hover {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            transform: translateY(-2px);
        }
        .oauth-btn.demo {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        .oauth-btn.demo:hover {
            background: linear-gradient(135deg, #059669, #047857);
        }
        .oauth-btn.logout {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        .oauth-btn.logout:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <!-- AUTH OVERLAY -->
    <div id="authOverlay" class="auth-overlay hidden">
        <div class="auth-box">
            <h2 class="text-2xl font-bold text-blue-400 mb-2">üîê Deriv Authentication</h2>
            <p class="text-gray-300 mb-6">Connect your Deriv account to start trading</p>
            
            <div id="loginSection">
                <h3 class="text-lg font-semibold text-gray-200 mb-4">Choose Login Method:</h3>
                
                <button onclick="oauthLogin('demo')" class="oauth-btn demo">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    Login with Demo Account
                </button>
                
                <button onclick="oauthLogin('real')" class="oauth-btn">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    Login with Real Account
                </button>
                
                <div class="mt-6 p-3 bg-blue-900/20 rounded border border-blue-500/30">
                    <h4 class="text-sm font-semibold text-blue-300 mb-2">üí° Quick Start:</h4>
                    <p class="text-xs text-gray-400">
                        ‚Ä¢ Demo Account: Practice with virtual funds<br>
                        ‚Ä¢ Real Account: Trade with real money<br>
                        ‚Ä¢ No password needed - secure OAuth login
                    </p>
                </div>
            </div>
            
            <div id="accountInfo" class="hidden">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 rounded-full bg-blue-600 flex items-center justify-center mr-3">
                        <span class="text-white font-bold text-lg" id="accountAvatar">D</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-white" id="accountName">Demo Account</h3>
                        <p class="text-sm text-gray-300" id="accountId">VRTC123456</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-gray-800 rounded p-3">
                        <p class="text-xs text-gray-400">Balance</p>
                        <p class="text-lg font-bold text-green-400" id="accountBalance">$10,000.00</p>
                    </div>
                    <div class="bg-gray-800 rounded p-3">
                        <p class="text-xs text-gray-400">Account Type</p>
                        <p class="text-lg font-bold text-blue-400" id="accountType">DEMO</p>
                    </div>
                </div>
                
                <button onclick="logout()" class="oauth-btn logout mt-4">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
                    </svg>
                    Logout
                </button>
                
                <button onclick="switchAccountType()" class="oauth-btn mt-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                    </svg>
                    Switch Account Type
                </button>
            </div>
            
            <div id="authStatus" class="mt-4 p-3 rounded text-sm hidden"></div>
            
            <div class="mt-6 pt-4 border-t border-gray-700">
                <p class="text-xs text-gray-500 text-center">
                    Secure OAuth 2.0 authentication powered by Deriv API
                </p>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="w-full max-w-6xl bg-gray-800 text-gray-100 shadow-2xl rounded-xl p-5 md:p-6">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-extrabold text-green-400 border-b border-gray-700 pb-2">
                DigitMatchStar Bot 
                <span id="status-badge" class="ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full connection-badge-disconnected text-white shadow-md">
                    üî¥ DISCONNECTED
                </span>
                <span id="contract-type-badge" class="contract-type-badge bg-purple-600 text-white">DIGITMATCH</span>
                <span id="network-recovery-badge" class="ml-2 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full hidden network-recovery-badge text-white shadow-md">
                    üîÑ AUTO-RECOVER
                </span>
                <div class="account-toggle-container ml-3">
                    <span class="account-label account-label-demo">DEMO</span>
                    <label class="account-toggle">
                        <input type="checkbox" id="accTypeToggle" onchange="switchAccount()">
                        <span class="account-toggle-slider"></span>
                    </label>
                    <span class="account-label account-label-real">REAL</span>
                </div>
            </h1>
            <div class="flex items-center space-x-2">
                <button id="soundToggle" onclick="toggleSound()" 
                    class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700 transition">
                    üîä Sound ON
                </button>
                <button id="networkRecoveryToggle" onclick="toggleNetworkRecovery()" 
                    class="px-4 py-2 bg-yellow-600 text-white font-bold rounded-lg shadow hover:bg-yellow-700 transition">
                    üîÑ Auto-Recovery: ON
                </button>
                <button onclick="showAuth()" 
                    class="px-4 py-2 bg-purple-600 text-white font-bold rounded-lg shadow hover:bg-purple-700 transition">
                    üîë Account
                </button>
                <div id="userInfo" class="hidden ml-2">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center">
                            <span class="text-white font-bold text-sm" id="userAvatar">U</span>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-white" id="userName">User</p>
                            <p class="text-xs text-gray-300" id="userBalance">$---</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- LEFT COLUMN: ENHANCED DIGIT ANALYSIS -->
            <div class="lg:col-span-1">
                <div class="bg-gray-900 border border-gray-700 rounded-xl p-4 shadow-lg">
                    <h2 class="text-lg font-bold text-cyan-400 mb-4 pb-2 border-b border-gray-700">
                        üîç ENHANCED DIGIT ANALYSIS
                    </h2>
                    
                    <!-- Analysis Controls -->
                    <div class="mb-4 p-3 bg-gray-800 rounded-lg border border-gray-600">
                        <h3 class="text-sm font-bold text-gray-300 mb-2">Analysis Controls</h3>
                        <div class="space-y-2">
                            <button id="analyzeDigits" onclick="startDigitAnalysis()" 
                                class="w-full px-3 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition text-sm">
                                üîç ANALYZE DIGITS
                            </button>
                            <button id="smartTrade" onclick="executeSmartTrade()" 
                                class="w-full px-3 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition text-sm">
                                üß† SMART TRADE
                            </button>
                            <div class="flex items-center justify-between mt-2">
                                <span class="text-xs text-gray-300">Analysis Samples:</span>
                                <input type="number" id="analysisSamples" value="50" min="20" max="200" 
                                    class="w-16 rounded-md bg-gray-700 border border-gray-600 text-white text-center text-xs py-1">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Analysis Results -->
                    <div class="mb-4 p-3 bg-gray-800 rounded-lg border border-cyan-500/30">
                        <h3 class="text-sm font-bold text-cyan-300 mb-3">Current Analysis</h3>
                        
                        <div id="analysis_status" class="mb-3 p-2 bg-gray-900 rounded text-xs">
                            <div class="flex justify-between">
                                <span class="text-gray-300">Status:</span>
                                <span id="analysis_status_text" class="text-yellow-400">Ready to analyze</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">Samples:</span>
                                <span id="analysis_samples" class="text-cyan-400">0/50</span>
                            </div>
                        </div>
                        
                        <!-- Digit Grid -->
                        <div class="mb-3">
                            <h4 class="text-xs font-bold text-gray-300 mb-2">Digit Frequency (0-9)</h4>
                            <div id="digit_grid" class="grid grid-cols-5 gap-1">
                                <!-- Digits will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Gap Detection -->
                        <div class="mb-3">
                            <h4 class="text-xs font-bold text-gray-300 mb-2">Critical Gaps Detected</h4>
                            <div id="gap_display" class="p-2 bg-gray-900 rounded text-xs text-gray-400">
                                No gaps detected yet
                            </div>
                        </div>
                        
                        <!-- Recommendations -->
                        <div>
                            <h4 class="text-xs font-bold text-gray-300 mb-2">Trading Recommendations</h4>
                            <div id="recommendations" class="p-2 bg-gray-900 rounded text-xs text-gray-400">
                                Complete analysis to see recommendations
                            </div>
                        </div>
                    </div>
                    
                    <!-- Smart Trade Info -->
                    <div id="smart_trade_info" class="mt-4 p-3 bg-gray-800 rounded border border-green-500/30 hidden">
                        <h3 class="text-sm font-bold text-green-300 mb-2">Smart Trade Active</h3>
                        <div class="text-xs space-y-1">
                            <div class="flex justify-between">
                                <span class="text-gray-300">Selected Digit:</span>
                                <span id="smart_digit" class="font-bold text-green-400">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">Confidence:</span>
                                <span id="smart_confidence" class="font-bold text-cyan-400">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">Reason:</span>
                                <span id="smart_reason" class="font-bold text-yellow-400">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- MIDDLE COLUMN: MAIN CONTROLS -->
            <div class="lg:col-span-2">
                <!-- MARTINGALE CALCULATOR -->
                <div class="mb-6 p-4 bg-gray-900 rounded-xl border border-purple-500/50 shadow-lg">
                    <h2 class="text-lg font-bold text-purple-400 mb-3 pb-2 border-b border-gray-700 flex items-center">
                        üßÆ MARTINGALE CALCULATOR
                        <button onclick="toggleCalculator()" class="ml-auto text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">
                            <span id="calcToggleIcon">‚àí</span>
                        </button>
                    </h2>
                    
                    <div id="calculatorContent" class="transition-all duration-300">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <!-- Left Column: Inputs -->
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-300 mb-1">Base Stake ($)</label>
                                    <input type="number" id="calc_base_stake" value="1.0" min="0.1" step="0.1" 
                                        class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm calculator-highlight">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-semibold text-gray-300 mb-1">Multiplier</label>
                                    <input type="number" id="calc_multiplier" value="1.15" min="1.0" step="0.01" 
                                        class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-semibold text-gray-300 mb-1">Max Trades</label>
                                    <input type="number" id="calc_max_trades" value="10" min="1" max="100" 
                                        class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-semibold text-gray-300 mb-1">Bankroll Limit ($)</label>
                                    <input type="number" id="calc_bankroll_limit" value="50.0" min="1.0" step="0.1" 
                                        class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm">
                                </div>
                                
                                <button onclick="calculateMartingale()" 
                                    class="w-full mt-2 px-4 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition">
                                    üßÆ CALCULATE
                                </button>
                            </div>
                            
                            <!-- Right Column: Results -->
                            <div class="space-y-3">
                                <div class="p-3 bg-gray-800 rounded-lg border border-green-500/50">
                                    <div class="text-xs font-semibold text-green-400 mb-1">Total Required</div>
                                    <div id="calc_total_required" class="text-xl font-bold text-white">$0.00</div>
                                    <div class="text-xs text-gray-400 mt-1">For all trades</div>
                                </div>
                                
                                <div class="p-3 bg-gray-800 rounded-lg border border-blue-500/50">
                                    <div class="text-xs font-semibold text-blue-400 mb-1">Final Stake</div>
                                    <div id="calc_final_stake" class="text-lg font-bold text-white">$0.00</div>
                                    <div class="text-xs text-gray-400 mt-1">Last trade amount</div>
                                </div>
                                
                                <div class="p-3 bg-gray-800 rounded-lg border border-yellow-500/50">
                                    <div class="text-xs font-semibold text-yellow-400 mb-1">Bankroll Status</div>
                                    <div id="calc_bankroll_status" class="text-lg font-bold text-white">-</div>
                                    <div class="text-xs text-gray-400 mt-1">vs. your limit</div>
                                </div>
                                
                                <div class="p-3 bg-gray-800 rounded-lg border border-cyan-500/50">
                                    <div class="text-xs font-semibold text-cyan-400 mb-1">Profit on Win</div>
                                    <div id="calc_profit_on_win" class="text-lg font-bold text-white">$0.00</div>
                                    <div class="text-xs text-gray-400 mt-1">9x payout minus investment</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Stake Progression Table -->
                        <div class="mt-4">
                            <div class="text-xs font-semibold text-gray-300 mb-2">Stake Progression</div>
                            <div id="calc_progression" class="text-xs text-gray-400 italic">Click CALCULATE to see stake progression</div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Trading Controls -->
                <div class="grid grid-cols-2 lg:grid-cols-3 gap-3 mb-6">
                    <!-- Symbol -->
                    <div>
                        <label for="symbol" class="block text-xs font-semibold text-gray-300 mb-1">Symbol</label>
                        <select id="symbol" class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                            <option value="R_10">Volatility 10 Index</option>
                            <option value="R_100">Volatility 100 Index</option>
                            <option value="R_25">Volatility 25 Index</option>
                            <option value="R_50">Volatility 50 Index</option>
                            <option value="R_75">Volatility 75 Index</option>
                        </select>
                    </div>
                    
                    <!-- Predicted Digit -->
                    <div>
                        <label for="predictedDigit" class="block text-xs font-semibold text-gray-300 mb-1">
                            Current Digit
                        </label>
                        <input type="number" id="predictedDigit" value="5" min="0" max="9" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm text-center">
                    </div>

                    <!-- Contract Type -->
                    <div>
                        <label for="contractType" class="block text-xs font-semibold text-gray-300 mb-1">Contract Type</label>
                        <select id="contractType" class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                            <option value="DIGITMATCH">DIGITMATCH</option>
                        </select>
                    </div>

                    <!-- Base Stake -->
                    <div>
                        <label for="baseStake" class="block text-xs font-semibold text-gray-300 mb-1">Base Stake</label>
                        <input type="number" id="baseStake" value="1.0" min="0.1" step="0.1" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                    </div>

                    <!-- Multiplier -->
                    <div>
                        <label for="multiplier" class="block text-xs font-semibold text-gray-300 mb-1">Multiplier</label>
                        <input type="number" id="multiplier" value="1.15" min="1.0" step="0.01" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                    </div>

                    <!-- Max Trades -->
                    <div>
                        <label for="maxTrades" class="block text-xs font-semibold text-gray-300 mb-1">Max Trades</label>
                        <input type="number" id="maxTrades" value="10" min="1" max="100" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                    </div>
                    
                    <!-- Mode Toggle -->
                    <div class="col-span-2 lg:col-span-3">
                        <label class="block text-xs font-semibold text-gray-300 mb-1">Execution Mode</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button id="mode_instant" onclick="switchMode('instant')" 
                                class="px-4 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition">
                                ‚ö° INSTANT
                            </button>
                            <button id="mode_smart" onclick="switchMode('smart')" 
                                class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition">
                                üß† SMART
                            </button>
                            <button id="mode_analysis" onclick="switchMode('analysis')" 
                                class="px-4 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition">
                                üîç ANALYSIS
                            </button>
                        </div>
                        <p id="mode_description" class="text-xs text-gray-400 mt-1">
                            ‚ö° INSTANT: Trade on each tick without analysis | üß† SMART: Use analyzed digits | üîç ANALYSIS: Analyze before trading
                        </p>
                    </div>
                </div>
                
                <!-- METRICS -->
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner border border-green-500/50 col-span-2">
                        <p class="text-[10px] font-semibold text-green-500 uppercase">Current Tick</p>
                        <p id="metricLiveTick" class="text-xl font-extrabold text-white">---</p>
                        <p id="metricLastDigit" class="text-lg font-bold text-green-300">Digit: ?</p>
                        <p id="metricTickRate" class="text-xs font-bold text-blue-400">Ticks/sec: --</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner border border-green-500/50">
                        <p class="text-[10px] font-semibold text-green-500 uppercase">Balance</p>
                        <p id="metricAccountBalance" class="text-lg font-bold balance-green">$---</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner">
                        <p class="text-[10px] font-semibold text-green-500 uppercase">Trade #</p>
                        <p id="metricTradeCount" class="text-lg font-bold text-white">0</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner">
                        <p class="text-[10px] font-semibold text-lime-400 uppercase">P/L</p>
                        <p id="metricTotalProfit" class="text-lg font-bold profit-neutral">$0.00</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner">
                        <p class="text-[10px] font-semibold text-green-500 uppercase">Stake</p>
                        <p id="metricCurrentStake" class="text-lg font-bold text-white">$0.00</p>
                    </div>
                    
                    <!-- TRADE STATUS SECTION -->
                    <div id="trade-result-container" class="bg-gray-900 rounded-lg p-3 shadow-inner border border-yellow-500/50 col-span-3">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-[10px] font-semibold text-yellow-500 uppercase">TRADE STATUS</p>
                            <p id="metricTradeResult" class="text-xs font-bold text-gray-400">READY</p>
                        </div>
                        <div class="mb-2">
                            <p class="text-[10px] font-semibold text-gray-400 uppercase mb-1">Status:</p>
                            <p id="metricPreviousResult" class="text-sm font-bold text-gray-300">Please login to start</p>
                        </div>
                        <div>
                            <p class="text-[10px] font-semibold text-gray-400 uppercase mb-1">Action:</p>
                            <p id="metricNextAction" class="text-sm font-bold text-yellow-400">Click "Account" button to login</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- START/STOP BUTTON -->
        <div class="flex justify-center mb-5">
            <button id="toggleButton" onclick="toggleBot()" 
                class="w-full md:w-1/2 px-6 py-3 bg-green-600 text-white font-bold text-lg rounded-lg shadow-xl hover:bg-green-700 transition duration-150">
                üöÄ START BOT
            </button>
        </div>

        <!-- LOG AREA -->
        <div id="log-column" class="w-full flex flex-col">
            <h2 class="text-lg font-bold text-gray-300 mb-2 border-b border-gray-700 pb-1">Live Log</h2>
            <div id="log-area" class="flex-grow h-80 bg-gray-900 text-lime-400 p-2.5 rounded-lg overflow-y-scroll text-xs whitespace-pre-wrap shadow-inner">
[00:00:00] ü§ñ Deriv Bot Initialized
[00:00:00] üìä Enhanced digit analysis system loaded
[00:00:00] üßÆ Martingale calculator ready
[00:00:00] üîÑ Auto-recovery system ready
[00:00:00] üîç Digit gap detection system active
[00:00:00] üîê Please login with your Deriv account to start trading
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // DERIV OAUTH AUTHENTICATION SYSTEM - COMPLETELY FIXED
        // ============================================================================
        
        // Deriv OAuth Configuration
        const DERIV_CONFIG = {
            app_id: 120389,
            oauth_url: 'https://oauth.deriv.com/oauth2/authorize',
            token_url: 'https://oauth.deriv.com/oauth2/token',
            api_url: 'wss://ws.binaryws.com/websockets/v3',
            redirect_uri: window.location.origin + window.location.pathname,
            scopes: ['read', 'trade', 'trading_information']
        };
        
        // OAuth State - SINGLE SOURCE OF TRUTH
        window.oauthState = {
            isAuthenticated: false,
            currentToken: null,
            currentAccount: null,
            accounts: [],
            tokenExpiry: null,
            initialized: false
        };
        
        // Initialize OAuth State
        function initializeOAuth() {
            if (window.oauthState.initialized) return;
            
            // Check URL for OAuth callback FIRST
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = hashParams.get('access_token');
            
            if (accessToken) {
                // We have a token in URL - process OAuth callback
                processOAuthCallback();
            } else {
                // Try to restore from localStorage
                restoreSessionFromStorage();
            }
            
            window.oauthState.initialized = true;
        }
        
        // Process OAuth callback from URL
        function processOAuthCallback() {
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = hashParams.get('access_token');
            const tokenType = hashParams.get('token_type');
            const expiresIn = hashParams.get('expires_in');
            const accountId = hashParams.get('account_id');
            const state = hashParams.get('state');
            
            if (!accessToken) {
                log('‚ùå No access token found in URL', 'AUTH');
                return false;
            }
            
            // Validate state if we have it stored
            const storedState = localStorage.getItem('oauth_state');
            if (state && storedState && state !== storedState) {
                log('‚ö†Ô∏è OAuth state mismatch - possible security issue', 'AUTH');
            }
            
            // Clear the state
            localStorage.removeItem('oauth_state');
            
            // Store token info
            const accountInfo = {
                token: accessToken,
                account: accountId || 'Unknown',
                type: accountId && accountId.startsWith('VR') ? 'demo' : 'real',
                loginTime: Date.now(),
                token_type: tokenType,
                expires_in: parseInt(expiresIn) || 3600
            };
            
            // Update OAuth state
            window.oauthState.currentToken = accessToken;
            window.oauthState.tokenExpiry = Date.now() + (accountInfo.expires_in * 1000);
            window.oauthState.currentAccount = accountInfo;
            window.oauthState.isAuthenticated = true;
            
            // Save to localStorage
            saveAccountToStorage(accountInfo);
            
            // Clear URL hash without reloading
            const cleanUrl = new URL(window.location);
            cleanUrl.hash = '';
            window.history.replaceState({}, document.title, cleanUrl.toString());
            
            // Update UI
            updateAuthUI();
            
            log('‚úÖ OAuth authentication successful!', 'AUTH');
            log(`üìù Account: ${accountInfo.account} (${accountInfo.type})`, 'AUTH');
            
            return true;
        }
        
        // Restore session from localStorage
        function restoreSessionFromStorage() {
            try {
                const storedAccounts = JSON.parse(localStorage.getItem('deriv_accounts') || '[]');
                const lastUsedToken = localStorage.getItem('last_used_token');
                
                if (lastUsedToken && storedAccounts.length > 0) {
                    const account = storedAccounts.find(acc => acc.token === lastUsedToken);
                    
                    if (account) {
                        // Check if token is expired
                        const expiryTime = account.loginTime + (account.expires_in * 1000);
                        const isExpired = Date.now() > expiryTime;
                        
                        if (!isExpired) {
                            window.oauthState.currentToken = account.token;
                            window.oauthState.currentAccount = account;
                            window.oauthState.isAuthenticated = true;
                            window.oauthState.tokenExpiry = expiryTime;
                            
                            log('‚úÖ Restored previous session', 'AUTH');
                            updateAuthUI();
                            return true;
                        } else {
                            log('‚ùå Token expired. Please login again.', 'AUTH');
                            localStorage.removeItem('last_used_token');
                            // Remove expired account
                            const updatedAccounts = storedAccounts.filter(acc => acc.token !== lastUsedToken);
                            localStorage.setItem('deriv_accounts', JSON.stringify(updatedAccounts));
                        }
                    }
                }
            } catch (error) {
                console.error('Error restoring session:', error);
            }
            
            return false;
        }
        
        // Save account to storage
        function saveAccountToStorage(accountInfo) {
            try {
                let accounts = JSON.parse(localStorage.getItem('deriv_accounts') || '[]');
                
                // Remove if exists
                accounts = accounts.filter(acc => acc.token !== accountInfo.token);
                
                // Add new account
                accounts.push(accountInfo);
                
                // Save to localStorage
                localStorage.setItem('deriv_accounts', JSON.stringify(accounts));
                localStorage.setItem('last_used_token', accountInfo.token);
                
                window.oauthState.accounts = accounts;
            } catch (error) {
                console.error('Error saving account:', error);
            }
        }
        
        // OAuth Login
        function oauthLogin(accountType = 'demo') {
            // Generate state for CSRF protection
            const state = generateRandomString(32);
            localStorage.setItem('oauth_state', state);
            
            // Clear any existing token from URL
            const cleanUrl = new URL(window.location);
            cleanUrl.hash = '';
            window.history.replaceState({}, document.title, cleanUrl.toString());
            
            // Build OAuth URL
            const params = {
                app_id: DERIV_CONFIG.app_id.toString(),
                response_type: 'token',
                redirect_uri: DERIV_CONFIG.redirect_uri,
                scope: DERIV_CONFIG.scopes.join(' '),
                state: state,
                brand: 'deriv',
                account_type: accountType === 'demo' ? 'demo' : 'real',
                language: 'EN'
            };
            
            const queryString = Object.keys(params)
                .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)
                .join('&');
            
            const authUrl = `${DERIV_CONFIG.oauth_url}?${queryString}`;
            
            log(`üîê Redirecting to Deriv OAuth for ${accountType.toUpperCase()} account...`, 'AUTH');
            
            // Show loading state
            document.getElementById('authStatus').classList.remove('hidden');
            document.getElementById('authStatus').textContent = 'Redirecting to Deriv...';
            document.getElementById('authStatus').className = 'mt-4 p-3 rounded text-sm bg-blue-900/30 text-blue-300';
            
            // Redirect to OAuth page
            setTimeout(() => {
                window.location.href = authUrl;
            }, 500);
        }
        
        // Logout
        function logout() {
            // Clear all auth data
            window.oauthState.isAuthenticated = false;
            window.oauthState.currentToken = null;
            window.oauthState.currentAccount = null;
            window.oauthState.tokenExpiry = null;
            
            // Remove current token from storage
            if (window.oauthState.currentToken) {
                let accounts = JSON.parse(localStorage.getItem('deriv_accounts') || '[]');
                accounts = accounts.filter(acc => acc.token !== window.oauthState.currentToken);
                localStorage.setItem('deriv_accounts', JSON.stringify(accounts));
                localStorage.removeItem('last_used_token');
            }
            
            // Clear OAuth state
            localStorage.removeItem('oauth_state');
            
            // Stop bot if running
            if (window.isBotRunning) {
                stopBot();
            }
            
            // Close WebSocket
            if (window.ws) {
                window.ws.close();
                window.ws = null;
            }
            
            // Update UI
            updateAuthUI();
            closeAuth();
            
            // Clear URL
            const url = new URL(window.location);
            url.hash = '';
            window.history.replaceState({}, document.title, url.toString());
            
            log('üëã Logged out successfully', 'AUTH');
        }
        
        // Switch account type
        function switchAccountType() {
            if (!window.oauthState.currentAccount) return;
            
            const newType = window.oauthState.currentAccount.type === 'demo' ? 'real' : 'demo';
            oauthLogin(newType);
        }
        
        // Update authentication UI
        function updateAuthUI() {
            const authOverlay = document.getElementById('authOverlay');
            const loginSection = document.getElementById('loginSection');
            const accountInfo = document.getElementById('accountInfo');
            const userInfo = document.getElementById('userInfo');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const userBalance = document.getElementById('userBalance');
            
            if (window.oauthState.isAuthenticated && window.oauthState.currentAccount) {
                // Hide login, show account info in modal
                loginSection.classList.add('hidden');
                accountInfo.classList.remove('hidden');
                
                // Update account info in modal
                document.getElementById('accountName').textContent = 
                    window.oauthState.currentAccount.type === 'demo' ? 'Demo Account' : 'Real Account';
                document.getElementById('accountId').textContent = window.oauthState.currentAccount.account;
                document.getElementById('accountType').textContent = window.oauthState.currentAccount.type.toUpperCase();
                document.getElementById('accountAvatar').textContent = window.oauthState.currentAccount.type === 'demo' ? 'D' : 'R';
                
                // Update user info in header
                userInfo.classList.remove('hidden');
                userAvatar.textContent = window.oauthState.currentAccount.type === 'demo' ? 'D' : 'R';
                userName.textContent = window.oauthState.currentAccount.type === 'demo' ? 'Demo Account' : 'Real Account';
                userBalance.textContent = window.currentBalance ? `$${window.currentBalance.toFixed(2)}` : '$---';
                
                // Update account toggle
                const toggle = document.getElementById('accTypeToggle');
                if (toggle) {
                    toggle.checked = window.oauthState.currentAccount.type === 'real';
                }
                
                // Update trade status
                updateTradeStatus('AUTHENTICATED', 'Account connected successfully', 'Ready to start trading', 'normal');
                
            } else {
                // Show login, hide account info
                loginSection.classList.remove('hidden');
                accountInfo.classList.add('hidden');
                userInfo.classList.add('hidden');
                
                // Update trade status
                updateTradeStatus('LOGIN REQUIRED', 'Please login with your Deriv account', 'Click "Account" button to login', 'normal');
            }
        }
        
        // Show auth modal
        function showAuth() {
            const authOverlay = document.getElementById('authOverlay');
            authOverlay.classList.remove('hidden');
            updateAuthUI();
        }
        
        // Close auth modal
        function closeAuth() {
            const authOverlay = document.getElementById('authOverlay');
            authOverlay.classList.add('hidden');
        }
        
        // Generate random string for state
        function generateRandomString(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // Check authentication before starting bot
        function checkAuthenticationBeforeStart() {
            if (!window.oauthState.isAuthenticated) {
                log('‚ùå Please login with your Deriv account first', 'CRITICAL');
                showAuth();
                return false;
            }
            
            if (!window.oauthState.currentToken) {
                log('‚ùå Authentication token not found', 'CRITICAL');
                showAuth();
                return false;
            }
            
            // Check if token is expired
            if (window.oauthState.tokenExpiry && Date.now() > window.oauthState.tokenExpiry) {
                log('‚ùå Authentication token has expired', 'CRITICAL');
                logout();
                showAuth();
                return false;
            }
            
            return true;
        }
        
        // ============================================================================
        // ENHANCED DIGIT ANALYSIS SYSTEM
        // ============================================================================
        
        window.digitAnalysis = {
            active: false,
            samplesCollected: 0,
            requiredSamples: 50,
            digitHistory: [],
            digitFrequency: Array(10).fill(0),
            gapAnalysis: Array(10).fill({ lastSeen: null, gap: 0, maxGap: 0 }),
            coldDigits: [],
            hotDigits: [],
            recommendations: [],
            analysisComplete: false,
            
            init: function() {
                this.digitHistory = [];
                this.digitFrequency = Array(10).fill(0);
                this.gapAnalysis = Array(10).fill({ lastSeen: null, gap: 0, maxGap: 0 });
                this.coldDigits = [];
                this.hotDigits = [];
                this.recommendations = [];
                this.samplesCollected = 0;
                this.analysisComplete = false;
                
                for (let i = 0; i < 10; i++) {
                    this.gapAnalysis[i] = {
                        lastSeen: null,
                        gap: 0,
                        maxGap: 0,
                        averageGap: 0,
                        gapHistory: []
                    };
                }
                
                this.updateDigitGrid();
                log('üîç Digit analysis system initialized', 'ANALYSIS');
            },
            
            addDigit: function(digit) {
                const digitNum = parseInt(digit);
                if (digitNum < 0 || digitNum > 9) return;
                
                const timestamp = Date.now();
                this.digitHistory.push({ digit: digitNum, timestamp: timestamp });
                
                this.digitFrequency[digitNum]++;
                this.samplesCollected++;
                
                this.updateGapAnalysis(digitNum, timestamp);
                
                if (this.digitHistory.length > 1000) {
                    this.digitHistory.shift();
                }
                
                if (this.samplesCollected % 5 === 0) {
                    this.updateAnalysisDisplay();
                }
                
                if (this.samplesCollected >= this.requiredSamples && !this.analysisComplete) {
                    this.completeAnalysis();
                }
                
                return this.samplesCollected;
            },
            
            updateGapAnalysis: function(digit, timestamp) {
                const digitData = this.gapAnalysis[digit];
                
                if (digitData.lastSeen !== null) {
                    const gap = timestamp - digitData.lastSeen;
                    digitData.gap = gap;
                    digitData.gapHistory.push(gap);
                    
                    if (digitData.gapHistory.length > 50) {
                        digitData.gapHistory.shift();
                    }
                    
                    digitData.maxGap = Math.max(digitData.maxGap, gap);
                    
                    if (digitData.gapHistory.length > 0) {
                        const sum = digitData.gapHistory.reduce((a, b) => a + b, 0);
                        digitData.averageGap = sum / digitData.gapHistory.length;
                    }
                }
                
                digitData.lastSeen = timestamp;
                
                this.checkCriticalGaps();
            },
            
            checkCriticalGaps: function() {
                const now = Date.now();
                const criticalGapThreshold = 30000;
                
                for (let i = 0; i < 10; i++) {
                    const digitData = this.gapAnalysis[i];
                    if (digitData.lastSeen !== null) {
                        const timeSinceLastSeen = now - digitData.lastSeen;
                        if (timeSinceLastSeen > criticalGapThreshold) {
                            if (!this.coldDigits.includes(i)) {
                                this.coldDigits.push(i);
                                log(`‚ö†Ô∏è Digit ${i} is overdue (${Math.round(timeSinceLastSeen/1000)}s since last appearance)`, 'ANALYSIS');
                            }
                        }
                    }
                }
                
                this.updateHotDigits();
            },
            
            updateHotDigits: function() {
                this.hotDigits = [];
                const totalSamples = Math.max(1, this.samplesCollected);
                const expectedFrequency = totalSamples / 10;
                
                for (let i = 0; i < 10; i++) {
                    const frequency = this.digitFrequency[i];
                    const relativeFrequency = frequency / totalSamples;
                    
                    if (relativeFrequency > (expectedFrequency * 1.5) / totalSamples) {
                        this.hotDigits.push({
                            digit: i,
                            frequency: frequency,
                            relativeFrequency: relativeFrequency
                        });
                    }
                }
                
                this.hotDigits.sort((a, b) => b.frequency - a.frequency);
            },
            
            completeAnalysis: function() {
                this.analysisComplete = true;
                
                const totalSamples = this.samplesCollected;
                const expectedFrequency = totalSamples / 10;
                
                let digitStats = [];
                for (let i = 0; i < 10; i++) {
                    const frequency = this.digitFrequency[i];
                    const relativeFreq = frequency / totalSamples;
                    const expectedFreq = 0.1;
                    
                    digitStats.push({
                        digit: i,
                        frequency: frequency,
                        relativeFrequency: relativeFreq,
                        deviation: Math.abs(relativeFreq - expectedFreq),
                        gapInfo: this.gapAnalysis[i]
                    });
                }
                
                digitStats.sort((a, b) => a.frequency - b.frequency);
                
                this.coldDigits = digitStats.slice(0, 3).map(d => d.digit);
                
                this.hotDigits = digitStats.slice(-3).reverse().map(d => ({
                    digit: d.digit,
                    frequency: d.frequency,
                    relativeFrequency: d.relativeFrequency
                }));
                
                this.generateRecommendations();
                
                this.updateAnalysisDisplay();
                
                log(`‚úÖ Analysis complete: ${this.samplesCollected} samples analyzed`, 'ANALYSIS');
                log(`üî¥ Cold digits to avoid: ${this.coldDigits.join(', ')}`, 'ANALYSIS');
                log(`üü¢ Hot digits (frequent): ${this.hotDigits.map(h => h.digit).join(', ')}`, 'ANALYSIS');
                
                this.highlightCriticalGaps();
                
                return true;
            },
            
            generateRecommendations: function() {
                this.recommendations = [];
                
                if (this.coldDigits.length > 0) {
                    this.recommendations.push({
                        type: 'warning',
                        message: `Avoid cold digits: ${this.coldDigits.join(', ')}`,
                        priority: 'high'
                    });
                }
                
                if (this.hotDigits.length > 0) {
                    const hotDigit = this.hotDigits[0].digit;
                    this.recommendations.push({
                        type: 'recommendation',
                        message: `Consider digit ${hotDigit} (most frequent)`,
                        priority: 'medium'
                    });
                }
                
                const now = Date.now();
                const overdueDigits = [];
                for (let i = 0; i < 10; i++) {
                    const digitData = this.gapAnalysis[i];
                    if (digitData.lastSeen && (now - digitData.lastSeen) > 20000) {
                        overdueDigits.push(i);
                    }
                }
                
                if (overdueDigits.length > 0) {
                    this.recommendations.push({
                        type: 'opportunity',
                        message: `Digits overdue: ${overdueDigits.join(', ')}`,
                        priority: 'high'
                    });
                }
                
                const balancedDigits = [];
                for (let i = 0; i < 10; i++) {
                    if (!this.coldDigits.includes(i) && !this.hotDigits.some(h => h.digit === i)) {
                        balancedDigits.push(i);
                    }
                }
                
                if (balancedDigits.length > 0) {
                    this.recommendations.push({
                        type: 'info',
                        message: `Balanced digits: ${balancedDigits.slice(0, 3).join(', ')}`,
                        priority: 'low'
                    });
                }
            },
            
            highlightCriticalGaps: function() {
                const now = Date.now();
                const gapDisplay = document.getElementById('gap_display');
                
                if (!gapDisplay) return;
                
                let gapHTML = '';
                let criticalGaps = [];
                
                for (let i = 0; i < 10; i++) {
                    const digitData = this.gapAnalysis[i];
                    if (digitData.lastSeen) {
                        const timeSinceLastSeen = now - digitData.lastSeen;
                        if (timeSinceLastSeen > 25000) {
                            criticalGaps.push({
                                digit: i,
                                seconds: Math.round(timeSinceLastSeen / 1000)
                            });
                        }
                    }
                }
                
                if (criticalGaps.length > 0) {
                    gapHTML = '<div class="space-y-1">';
                    criticalGaps.forEach(gap => {
                        gapHTML += `
                            <div class="flex justify-between items-center p-1 rounded gap-critical">
                                <span class="font-bold">Digit ${gap.digit}</span>
                                <span class="text-xs">${gap.seconds}s overdue</span>
                            </div>
                        `;
                    });
                    gapHTML += '</div>';
                } else {
                    gapHTML = '<div class="text-green-400">No critical gaps detected</div>';
                }
                
                gapDisplay.innerHTML = gapHTML;
            },
            
            updateDigitGrid: function() {
                const digitGrid = document.getElementById('digit_grid');
                if (!digitGrid) return;
                
                let gridHTML = '';
                const totalSamples = Math.max(1, this.samplesCollected);
                
                for (let i = 0; i < 10; i++) {
                    const frequency = this.digitFrequency[i];
                    const percentage = totalSamples > 0 ? (frequency / totalSamples * 100).toFixed(1) : 0;
                    
                    let digitClass = 'digit-normal';
                    if (this.coldDigits.includes(i)) {
                        digitClass = 'digit-cold';
                    } else if (this.hotDigits.some(h => h.digit === i)) {
                        digitClass = 'digit-hot';
                    } else if (frequency === 0 && totalSamples > 20) {
                        digitClass = 'digit-avoid';
                    }
                    
                    gridHTML += `
                        <div class="digit-cell ${digitClass} p-1 rounded text-center cursor-pointer" 
                             onclick="selectDigitFromAnalysis(${i})"
                             title="Digit ${i}: ${frequency} appearances (${percentage}%)">
                            <div class="font-bold text-lg">${i}</div>
                            <div class="text-xs">${frequency}</div>
                        </div>
                    `;
                }
                
                digitGrid.innerHTML = gridHTML;
                
                this.updateAnalysisStatus();
            },
            
            updateAnalysisStatus: function() {
                const statusText = document.getElementById('analysis_status_text');
                const samplesText = document.getElementById('analysis_samples');
                const recommendationsDiv = document.getElementById('recommendations');
                
                if (!statusText || !samplesText || !recommendationsDiv) return;
                
                if (this.analysisComplete) {
                    statusText.textContent = '‚úÖ Analysis Complete';
                    statusText.className = 'text-green-400';
                } else if (this.samplesCollected > 0) {
                    statusText.textContent = 'üîç Analyzing...';
                    statusText.className = 'text-yellow-400';
                } else {
                    statusText.textContent = 'Ready to analyze';
                    statusText.className = 'text-yellow-400';
                }
                
                samplesText.textContent = `${this.samplesCollected}/${this.requiredSamples}`;
                
                if (this.recommendations.length > 0) {
                    let recHTML = '<div class="space-y-1">';
                    this.recommendations.slice(0, 3).forEach(rec => {
                        let icon = '‚ÑπÔ∏è';
                        if (rec.type === 'warning') icon = '‚ö†Ô∏è';
                        if (rec.type === 'opportunity') icon = 'üéØ';
                        if (rec.type === 'recommendation') icon = 'üí°';
                        
                        recHTML += `
                            <div class="p-1 rounded ${rec.priority === 'high' ? 'bg-red-900/30' : rec.priority === 'medium' ? 'bg-yellow-900/30' : 'bg-blue-900/30'}">
                                <div class="flex items-center">
                                    <span class="mr-1">${icon}</span>
                                    <span class="text-xs">${rec.message}</span>
                                </div>
                            </div>
                        `;
                    });
                    recHTML += '</div>';
                    recommendationsDiv.innerHTML = recHTML;
                }
            },
            
            getSmartDigit: function() {
                if (!this.analysisComplete || this.samplesCollected < 30) {
                    return {
                        digit: null,
                        confidence: 0,
                        reason: 'Insufficient data'
                    };
                }
                
                const now = Date.now();
                let overdueCandidates = [];
                
                for (let i = 0; i < 10; i++) {
                    const digitData = this.gapAnalysis[i];
                    if (digitData.lastSeen) {
                        const timeSinceLastSeen = now - digitData.lastSeen;
                        if (timeSinceLastSeen > 20000) {
                            overdueCandidates.push({
                                digit: i,
                                overdueTime: timeSinceLastSeen,
                                frequency: this.digitFrequency[i]
                            });
                        }
                    }
                }
                
                if (overdueCandidates.length > 0) {
                    overdueCandidates.sort((a, b) => b.overdueTime - a.overdueTime);
                    const bestCandidate = overdueCandidates.find(c => !this.coldDigits.includes(c.digit)) || overdueCandidates[0];
                    
                    return {
                        digit: bestCandidate.digit,
                        confidence: Math.min(85, 50 + (bestCandidate.overdueTime / 1000)),
                        reason: `Overdue by ${Math.round(bestCandidate.overdueTime/1000)}s`
                    };
                }
                
                const balancedDigits = [];
                for (let i = 0; i < 10; i++) {
                    if (!this.coldDigits.includes(i) && !this.hotDigits.some(h => h.digit === i)) {
                        balancedDigits.push(i);
                    }
                }
                
                if (balancedDigits.length > 0) {
                    const randomDigit = balancedDigits[Math.floor(Math.random() * balancedDigits.length)];
                    return {
                        digit: randomDigit,
                        confidence: 65,
                        reason: 'Balanced frequency'
                    };
                }
                
                let digitStats = [];
                for (let i = 0; i < 10; i++) {
                    if (!this.coldDigits.includes(i)) {
                        digitStats.push({
                            digit: i,
                            frequency: this.digitFrequency[i]
                        });
                    }
                }
                
                if (digitStats.length > 0) {
                    digitStats.sort((a, b) => a.frequency - b.frequency);
                    return {
                        digit: digitStats[0].digit,
                        confidence: 60,
                        reason: 'Least frequent (not cold)'
                    };
                }
                
                const randomDigit = Math.floor(Math.random() * 10);
                return {
                    digit: randomDigit,
                    confidence: 50,
                    reason: 'Random selection'
                };
            },
            
            reset: function() {
                this.init();
                log('üîÑ Digit analysis reset', 'ANALYSIS');
            }
        };
        
        // ============================================================================
        // DIGIT ANALYSIS UI FUNCTIONS
        // ============================================================================
        
        function startDigitAnalysis() {
            if (!window.isBotRunning) {
                log('‚ùå Please start the bot first to collect tick data', 'ANALYSIS');
                return;
            }
            
            window.digitAnalysis.active = true;
            window.digitAnalysis.reset();
            window.digitAnalysis.requiredSamples = parseInt(document.getElementById('analysisSamples').value) || 50;
            
            log(`üîç Starting digit analysis (collecting ${window.digitAnalysis.requiredSamples} samples)`, 'ANALYSIS');
            document.getElementById('analyzeDigits').classList.add('analysis-pulse');
            
            if (sessionState.mode !== 'analysis') {
                switchMode('analysis');
            }
        }
        
        function executeSmartTrade() {
            if (!window.digitAnalysis.analysisComplete) {
                log('‚ùå Complete digit analysis first', 'ANALYSIS');
                startDigitAnalysis();
                return;
            }
            
            const smartRecommendation = window.digitAnalysis.getSmartDigit();
            
            if (!smartRecommendation.digit && smartRecommendation.digit !== 0) {
                log('‚ùå No smart digit recommendation available', 'ANALYSIS');
                return;
            }
            
            document.getElementById('predictedDigit').value = smartRecommendation.digit;
            
            sessionState.sessionDigit = smartRecommendation.digit;
            sessionState.sessionStarted = true;
            sessionState.manualOverride = true;
            
            const smartInfo = document.getElementById('smart_trade_info');
            smartInfo.classList.remove('hidden');
            document.getElementById('smart_digit').textContent = smartRecommendation.digit;
            document.getElementById('smart_confidence').textContent = `${smartRecommendation.confidence.toFixed(0)}%`;
            document.getElementById('smart_reason').textContent = smartRecommendation.reason;
            
            switchMode('smart');
            
            log(`üß† Smart trade activated: Digit ${smartRecommendation.digit} (${smartRecommendation.confidence.toFixed(0)}% confidence)`, 'ANALYSIS');
            log(`üìä Reason: ${smartRecommendation.reason}`, 'ANALYSIS');
            
            if (window.isBotRunning) {
                updateTradeStatus(
                    'SMART TRADE',
                    `Digit ${smartRecommendation.digit} selected (${smartRecommendation.confidence.toFixed(0)}% confidence)`,
                    'Ready to trade with analyzed digit',
                    'normal'
                );
            }
        }
        
        function selectDigitFromAnalysis(digit) {
            document.getElementById('predictedDigit').value = digit;
            
            if (sessionState.mode === 'smart' || sessionState.mode === 'analysis') {
                sessionState.sessionDigit = digit;
                sessionState.sessionStarted = true;
                sessionState.manualOverride = true;
                
                log(`üî¢ Digit ${digit} selected from analysis`, 'ANALYSIS');
                
                const digitData = window.digitAnalysis.digitFrequency[digit];
                const totalSamples = window.digitAnalysis.samplesCollected;
                const percentage = totalSamples > 0 ? (digitData / totalSamples * 100).toFixed(1) : 0;
                
                updateTradeStatus(
                    'ANALYSIS SELECT',
                    `Digit ${digit} selected (${digitData} appearances, ${percentage}%)`,
                    'Ready to trade',
                    'normal'
                );
            }
        }
        
        // ============================================================================
        // MARTINGALE CALCULATOR FUNCTIONS
        // ============================================================================
        
        let calculatorExpanded = true;
        
        function toggleCalculator() {
            calculatorExpanded = !calculatorExpanded;
            const calculatorContent = document.getElementById('calculatorContent');
            const toggleIcon = document.getElementById('calcToggleIcon');
            
            if (calculatorExpanded) {
                calculatorContent.classList.remove('hidden');
                toggleIcon.textContent = '‚àí';
            } else {
                calculatorContent.classList.add('hidden');
                toggleIcon.textContent = '+';
            }
        }
        
        function calculateMartingale() {
            try {
                const baseStake = parseFloat(document.getElementById('calc_base_stake').value) || 1.0;
                const multiplier = parseFloat(document.getElementById('calc_multiplier').value) || 1.15;
                const maxTrades = parseInt(document.getElementById('calc_max_trades').value) || 10;
                const bankrollLimit = parseFloat(document.getElementById('calc_bankroll_limit').value) || 50.0;
                
                if (baseStake <= 0 || multiplier <= 1.0 || maxTrades <= 0) {
                    alert('Please enter valid values for calculation.');
                    return;
                }
                
                let currentStake = baseStake;
                let totalRequired = 0;
                let progression = [];
                let finalStake = baseStake;
                
                for (let i = 1; i <= maxTrades; i++) {
                    if (i === 1) {
                        currentStake = baseStake;
                    } else {
                        currentStake *= multiplier;
                    }
                    
                    currentStake = Math.round(currentStake * 100) / 100;
                    totalRequired += currentStake;
                    finalStake = currentStake;
                    
                    progression.push({
                        trade: i,
                        stake: currentStake.toFixed(2),
                        cumulative: Math.round(totalRequired * 100) / 100
                    });
                }
                
                totalRequired = Math.round(totalRequired * 100) / 100;
                
                const profitOnWin = (finalStake * 9) - totalRequired;
                
                document.getElementById('baseStake').value = baseStake.toFixed(2);
                document.getElementById('multiplier').value = multiplier.toFixed(2);
                document.getElementById('maxTrades').value = maxTrades;
                
                document.getElementById('calc_total_required').textContent = `$${totalRequired.toFixed(2)}`;
                document.getElementById('calc_final_stake').textContent = `$${finalStake.toFixed(2)}`;
                document.getElementById('calc_profit_on_win').textContent = `$${profitOnWin.toFixed(2)}`;
                
                const bankrollStatusElem = document.getElementById('calc_bankroll_status');
                bankrollStatusElem.classList.remove('calculator-safe', 'calculator-warning', 'calculator-highlight');
                
                if (totalRequired <= bankrollLimit) {
                    bankrollStatusElem.textContent = '‚úÖ Within Limit';
                    bankrollStatusElem.classList.add('calculator-safe');
                } else if (totalRequired <= bankrollLimit * 1.5) {
                    bankrollStatusElem.textContent = '‚ö†Ô∏è Close to Limit';
                    bankrollStatusElem.classList.add('calculator-warning');
                } else {
                    bankrollStatusElem.textContent = '‚ùå Over Limit';
                    bankrollStatusElem.classList.add('calculator-warning');
                }
                
                const progressionElem = document.getElementById('calc_progression');
                let progressionHTML = '<div class="grid grid-cols-4 gap-1 text-xs mb-1 font-semibold text-gray-300">';
                progressionHTML += '<div>Trade #</div><div>Stake</div><div>Cumulative</div><div>Status</div>';
                progressionHTML += '</div>';
                
                progression.forEach(item => {
                    const status = item.cumulative <= bankrollLimit ? '‚úÖ' : '‚ùå';
                    progressionHTML += `
                        <div class="grid grid-cols-4 gap-1 text-xs py-1 ${item.trade % 2 === 0 ? 'bg-gray-800/50' : ''}">
                            <div class="text-gray-300">${item.trade}</div>
                            <div class="text-green-400">$${item.stake}</div>
                            <div class="text-blue-400">$${item.cumulative.toFixed(2)}</div>
                            <div class="${status === '‚úÖ' ? 'text-green-400' : 'text-red-400'}">${status}</div>
                        </div>
                    `;
                });
                
                progressionElem.innerHTML = progressionHTML;
                
                document.getElementById('calc_total_required').classList.add('calculator-pulse');
                setTimeout(() => {
                    document.getElementById('calc_total_required').classList.remove('calculator-pulse');
                }, 500);
                
                log(`üßÆ Calculator: Total required: $${totalRequired.toFixed(2)} for ${maxTrades} trades`, 'CALCULATOR');
                
            } catch (error) {
                console.error('Calculator error:', error);
                alert('Error in calculation. Please check your inputs.');
            }
        }
        
        function syncCalculatorWithMain() {
            const baseStake = parseFloat(document.getElementById('baseStake').value) || 1.0;
            const multiplier = parseFloat(document.getElementById('multiplier').value) || 1.15;
            const maxTrades = parseInt(document.getElementById('maxTrades').value) || 10;
            
            document.getElementById('calc_base_stake').value = baseStake.toFixed(2);
            document.getElementById('calc_multiplier').value = multiplier.toFixed(2);
            document.getElementById('calc_max_trades').value = maxTrades;
            
            calculateMartingale();
        }
        
        // ============================================================================
        // CORE BOT FUNCTIONS
        // ============================================================================
        
        window.ws = null;
        window.req_id = 0;
        window.isBotRunning = false;
        window.isConnecting = false;
        window.soundEnabled = true;
        window.ToneInitialized = false;
        window.synth = null;
        
        window.networkRecoveryEnabled = true;
        window.reconnectionAttempts = 0;
        window.maxReconnectionAttempts = 5;
        window.reconnectionDelay = 2000;
        window.lastDisconnectTime = 0;
        window.autoReconnectTimer = null;
        
        window.baseStake = 1.0;
        window.currentStake = 1.0;
        window.multiplier = 1.15;
        window.maxTrades = 20;
        window.tradeCount = 0;
        window.martingaleStep = 0;
        window.accountBalance = 0.0;
        window.startingBalance = 0.0;
        window.currentBalance = 0.0;
        window.netProfit = 0.0;
        
        window.pnlTracker = {
            totalInvestment: 0.0,
            totalPayout: 0.0,
            netProfit: 0.0,
            trades: []
        };
        
        window.pnlUpdateInterval = null;
        window.pnlUpdateStartTime = 0;
        window.pnlUpdateDuration = 10000;
        
        window.lastTick = null;
        window.nextTradeAllowed = true;
        window.stopAfterWin = false;
        window.pendingProposals = new Map();
        window.executionLock = false;
        
        window.stats = {
            totalTicks: 0,
            tradesExecuted: 0,
            wins: 0,
            losses: 0
        };
        
        window.botTickTimestamps = [];
        
        window.tickQueue = [];
        window.maxQueueSize = 30;
        
        let sessionState = {
            active: false,
            mode: 'instant',
            sessionDigit: null,
            sessionStarted: false,
            manualOverride: false
        };
        
        window.totalTicksReceived = 0;
        window.tickTimestamps = [];
        window.tickSubscriptionSent = false;
        
        const toggleButton = document.getElementById('toggleButton');
        const soundToggleButton = document.getElementById('soundToggle');
        const networkRecoveryToggle = document.getElementById('networkRecoveryToggle');
        const networkRecoveryBadge = document.getElementById('network-recovery-badge');
        const tradeResultContainer = document.getElementById('trade-result-container');
        const metricPreviousResult = document.getElementById('metricPreviousResult');
        const metricNextAction = document.getElementById('metricNextAction');
        const metricTradeResult = document.getElementById('metricTradeResult');
        const metricTotalProfit = document.getElementById('metricTotalProfit');
        
        // ============================================================================
        // NETWORK RECOVERY SYSTEM
        // ============================================================================
        
        function toggleNetworkRecovery() {
            window.networkRecoveryEnabled = !window.networkRecoveryEnabled;
            updateNetworkRecoveryButton();
            
            log(`üîÑ Network auto-recovery ${window.networkRecoveryEnabled ? 'ENABLED' : 'DISABLED'}`, 'SYSTEM');
            
            if (window.networkRecoveryEnabled) {
                networkRecoveryBadge.classList.remove('hidden');
            } else {
                networkRecoveryBadge.classList.add('hidden');
                if (window.autoReconnectTimer) {
                    clearTimeout(window.autoReconnectTimer);
                    window.autoReconnectTimer = null;
                }
            }
        }
        
        function updateNetworkRecoveryButton() {
            if (networkRecoveryToggle) {
                networkRecoveryToggle.textContent = window.networkRecoveryEnabled ? 
                    'üîÑ Auto-Recovery: ON' : 'üîå Auto-Recovery: OFF';
                networkRecoveryToggle.className = window.networkRecoveryEnabled ? 
                    'px-4 py-2 bg-yellow-600 text-white font-bold rounded-lg shadow hover:bg-yellow-700 transition' :
                    'px-4 py-2 bg-gray-600 text-white font-bold rounded-lg shadow hover:bg-gray-700 transition';
            }
        }
        
        function attemptNetworkRecovery() {
            if (!window.networkRecoveryEnabled || !window.isBotRunning) {
                return;
            }
            
            window.reconnectionAttempts++;
            
            if (window.reconnectionAttempts > window.maxReconnectionAttempts) {
                log(`‚ùå Max reconnection attempts (${window.maxReconnectionAttempts}) reached. Stopping bot.`, 'NETWORK');
                stopBot();
                return;
            }
            
            const delay = window.reconnectionDelay * Math.pow(1.5, window.reconnectionAttempts - 1);
            
            log(`üîÑ Network recovery attempt ${window.reconnectionAttempts}/${window.maxReconnectionAttempts} in ${delay/1000}s...`, 'NETWORK');
            
            updateTradeStatus('RECONNECTING', 
                `Network recovery attempt ${window.reconnectionAttempts}/${window.maxReconnectionAttempts}`,
                `Reconnecting in ${delay/1000}s...`,
                'normal');
            
            window.autoReconnectTimer = setTimeout(() => {
                if (window.isBotRunning) {
                    log('üîó Attempting to reconnect WebSocket...', 'NETWORK');
                    connectWebSocket();
                }
            }, delay);
        }
        
        function resetReconnectionAttempts() {
            window.reconnectionAttempts = 0;
            if (window.autoReconnectTimer) {
                clearTimeout(window.autoReconnectTimer);
                window.autoReconnectTimer = null;
            }
        }
        
        // ============================================================================
        // PnL UPDATE FUNCTIONS
        // ============================================================================
        
        function startExtendedPnlUpdate(payout) {
            window.pnlUpdateStartTime = Date.now();
            
            if (window.pnlUpdateInterval) {
                clearInterval(window.pnlUpdateInterval);
            }
            
            updatePnL();
            
            window.pnlUpdateInterval = setInterval(() => {
                const elapsed = Date.now() - window.pnlUpdateStartTime;
                
                if (elapsed >= window.pnlUpdateDuration) {
                    clearInterval(window.pnlUpdateInterval);
                    window.pnlUpdateInterval = null;
                    log('üí∞ PnL update sequence completed (10 seconds)', 'PNL');
                    
                    updatePnL();
                    
                    setTimeout(() => {
                        if (window.isBotRunning) {
                            stopBot();
                        }
                    }, 100);
                } else {
                    updatePnL();
                    
                    if (elapsed % 500 < 50) {
                        metricTotalProfit.classList.add('pnl-update-animation');
                        setTimeout(() => {
                            metricTotalProfit.classList.remove('pnl-update-animation');
                        }, 500);
                    }
                    
                    if (elapsed % 1000 < 50) {
                        const secondsLeft = Math.ceil((window.pnlUpdateDuration - elapsed) / 1000);
                        log(`üí∞ PnL updating... ${secondsLeft}s`, 'PNL');
                    }
                }
            }, 100);
        }
        
        function updatePnL() {
            const pnlElem = document.getElementById('metricTotalProfit');
            
            if (window.startingBalance > 0 && window.currentBalance > 0) {
                window.netProfit = window.currentBalance - window.startingBalance;
                const formattedProfit = window.netProfit.toFixed(2);
                const isPositive = window.netProfit > 0;
                const isNegative = window.netProfit < 0;
                
                pnlElem.textContent = `${isPositive ? '+' : ''}$${formattedProfit}`;
                pnlElem.classList.remove('profit-positive', 'profit-negative', 'profit-neutral');
                
                if (isPositive) pnlElem.classList.add('profit-positive');
                else if (isNegative) pnlElem.classList.add('profit-negative');
                else pnlElem.classList.add('profit-neutral');
                
                return window.netProfit;
            }
            
            if (window.pnlTracker.totalPayout > 0 || window.pnlTracker.totalInvestment > 0) {
                window.netProfit = window.pnlTracker.totalPayout - window.pnlTracker.totalInvestment;
                const formattedProfit = window.netProfit.toFixed(2);
                const isPositive = window.netProfit > 0;
                const isNegative = window.netProfit < 0;
                
                pnlElem.textContent = `${isPositive ? '+' : ''}$${formattedProfit}`;
                pnlElem.classList.remove('profit-positive', 'profit-negative', 'profit-neutral');
                
                if (isPositive) pnlElem.classList.add('profit-positive');
                else if (isNegative) pnlElem.classList.add('profit-negative');
                else pnlElem.classList.add('profit-neutral');
                
                return window.netProfit;
            }
            
            pnlElem.textContent = '$0.00';
            pnlElem.classList.remove('profit-positive', 'profit-negative');
            pnlElem.classList.add('profit-neutral');
            return 0;
        }
        
        function trackTradeInvestment(amount) {
            window.pnlTracker.totalInvestment += parseFloat(amount);
            window.pnlTracker.trades.push({
                type: 'investment',
                amount: parseFloat(amount),
                timestamp: Date.now()
            });
            updatePnL();
            log(`üí∞ Investment tracked: $${amount.toFixed(2)}`, 'PNL');
        }
        
        function trackTradePayout(amount) {
            window.pnlTracker.totalPayout += parseFloat(amount);
            window.pnlTracker.trades.push({
                type: 'payout',
                amount: parseFloat(amount),
                timestamp: Date.now()
            });
            updatePnL();
            log(`üí∞ Payout tracked: $${amount.toFixed(2)}`, 'PNL');
        }
        
        function resetPnL() {
            window.pnlTracker = { totalInvestment: 0.0, totalPayout: 0.0, netProfit: 0.0, trades: [] };
            window.startingBalance = 0.0;
            window.currentBalance = 0.0;
            window.netProfit = 0.0;
            
            if (window.pnlUpdateInterval) {
                clearInterval(window.pnlUpdateInterval);
                window.pnlUpdateInterval = null;
            }
            
            updatePnL();
            log('üí∞ PnL reset', 'PNL');
        }
        
        // ============================================================================
        // CORE BOT FUNCTIONS CONTINUED
        // ============================================================================
        
        function switchAccount() {
            const isRealRequested = document.getElementById('accTypeToggle').checked;
            
            if (!window.oauthState.isAuthenticated) {
                showAuth();
                return;
            }
            
            // Switch to different account type
            switchAccountType();
        }
        
        function updateTradeStatus(status, result, action, type = 'normal') {
            tradeResultContainer.classList.remove('win-glow');
            metricPreviousResult.textContent = result;
            metricNextAction.textContent = action;
            
            switch(type) {
                case 'win':
                    metricTradeResult.textContent = 'WIN üéØ';
                    metricTradeResult.className = 'text-xs font-bold status-win';
                    metricPreviousResult.className = 'text-sm font-bold status-win';
                    metricNextAction.className = 'text-sm font-bold text-green-400';
                    tradeResultContainer.classList.add('win-glow');
                    log(`üéØ Trade Status: ${result}`, 'WIN');
                    break;
                case 'loss':
                    metricTradeResult.textContent = 'LOSS ‚ùå';
                    metricTradeResult.className = 'text-xs font-bold status-loss';
                    metricPreviousResult.className = 'text-sm font-bold status-loss';
                    metricNextAction.className = 'text-sm font-bold text-red-400';
                    log(`‚ùå Trade Status: ${result}`, 'LOSS');
                    break;
                case 'trade':
                    metricTradeResult.textContent = 'TRADING ‚ö°';
                    metricTradeResult.className = 'text-xs font-bold status-trade';
                    metricPreviousResult.className = 'text-sm font-bold status-trade';
                    metricNextAction.className = 'text-sm font-bold text-yellow-400';
                    log(`‚ö° Trade Status: ${result}`, 'TRADE');
                    break;
                default:
                    metricTradeResult.textContent = status || 'READY';
                    metricTradeResult.className = 'text-xs font-bold text-gray-400';
                    metricPreviousResult.className = 'text-sm font-bold text-gray-300';
                    metricNextAction.className = 'text-sm font-bold text-yellow-400';
                    break;
            }
        }
        
        function resetTradeStatus() {
            if (!window.oauthState.isAuthenticated) {
                updateTradeStatus('LOGIN REQUIRED', 'Please login with your Deriv account', 'Click "Account" button to login', 'normal');
            } else {
                updateTradeStatus('READY', 'Waiting for connection...', 'Start bot to begin', 'normal');
            }
        }
        
        function lockSessionDigit(digit) {
            if (sessionState.sessionStarted && sessionState.sessionDigit !== null) {
                log(`üîí Digit ${digit} is already locked for this session`, 'SESSION');
                return sessionState.sessionDigit;
            }
            
            sessionState.sessionDigit = digit;
            sessionState.sessionStarted = true;
            sessionState.manualOverride = false;
            document.getElementById('predictedDigit').value = digit;
            log(`üîí Digit ${digit} locked for current session`, 'SESSION');
            return digit;
        }
        
        function updateConnectionStatus() {
            const isConnected = window.ws && window.ws.readyState === WebSocket.OPEN;
            const isConnecting = window.isConnecting || false;
            
            if (isConnected) {
                document.getElementById('status-badge').textContent = 'üü¢ CONNECTED';
                document.getElementById('status-badge').className = 'ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full connection-badge-connected text-white shadow-md';
                updateTradeStatus('CONNECTED', 'Market live - Ready to trade', 'Set parameters and start trading', 'normal');
            } else if (isConnecting) {
                document.getElementById('status-badge').textContent = 'üü° CONNECTING';
                document.getElementById('status-badge').className = 'ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full connection-badge-connecting text-white shadow-md';
                updateTradeStatus('CONNECTING', 'Connecting to market...', 'Please wait', 'normal');
            } else {
                document.getElementById('status-badge').textContent = 'üî¥ DISCONNECTED';
                document.getElementById('status-badge').className = 'ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full connection-badge-disconnected text-white shadow-md';
                updateTradeStatus('DISCONNECTED', 'Market offline', 'Start bot to connect', 'normal');
            }
        }
        
        function switchMode(mode) {
            sessionState.mode = mode;
            
            document.getElementById('mode_instant').classList.remove('bg-green-600', 'bg-blue-600', 'bg-purple-600');
            document.getElementById('mode_smart').classList.remove('bg-green-600', 'bg-blue-600', 'bg-purple-600');
            document.getElementById('mode_analysis').classList.remove('bg-green-600', 'bg-blue-600', 'bg-purple-600');
            
            if (mode === 'instant') {
                document.getElementById('mode_instant').classList.add('bg-green-600');
                document.getElementById('mode_smart').classList.add('bg-blue-600');
                document.getElementById('mode_analysis').classList.add('bg-purple-600');
                document.getElementById('mode_description').textContent = '‚ö° INSTANT: Trade on each tick without analysis';
                log('üîÑ Switched to INSTANT mode', 'SYSTEM');
                window.nextTradeAllowed = true;
                window.digitAnalysis.active = false;
                document.getElementById('analyzeDigits').classList.remove('analysis-pulse');
                
                if (window.isBotRunning && !sessionState.manualOverride) {
                    const manualDigit = parseInt(document.getElementById('predictedDigit').value);
                    if (!isNaN(manualDigit) && manualDigit >= 0 && manualDigit <= 9) {
                        sessionState.sessionDigit = manualDigit;
                        sessionState.sessionStarted = true;
                        sessionState.manualOverride = true;
                        log(`üîí Digit ${manualDigit} set manually for instant mode`, 'SESSION');
                    }
                }
            } else if (mode === 'smart') {
                document.getElementById('mode_smart').classList.add('bg-green-600');
                document.getElementById('mode_instant').classList.add('bg-blue-600');
                document.getElementById('mode_analysis').classList.add('bg-purple-600');
                document.getElementById('mode_description').textContent = 'üß† SMART: Use analyzed digits for trading';
                log('üîÑ Switched to SMART mode', 'SYSTEM');
                window.digitAnalysis.active = false;
                document.getElementById('analyzeDigits').classList.remove('analysis-pulse');
                
            } else if (mode === 'analysis') {
                document.getElementById('mode_analysis').classList.add('bg-green-600');
                document.getElementById('mode_instant').classList.add('bg-blue-600');
                document.getElementById('mode_smart').classList.add('bg-purple-600');
                document.getElementById('mode_description').textContent = 'üîç ANALYSIS: Analyze market before trading';
                log('üîÑ Switched to ANALYSIS mode', 'SYSTEM');
                window.nextTradeAllowed = false;
                window.digitAnalysis.active = true;
                
                if (window.digitAnalysis.samplesCollected === 0) {
                    startDigitAnalysis();
                }
            }
            
            updateExecutionLogic();
        }
        
        function updateExecutionLogic() {
            if (!window.oauthState.isAuthenticated) {
                updateTradeStatus('LOGIN REQUIRED', 'Please login with your Deriv account', 'Click "Account" button to login', 'normal');
                window.nextTradeAllowed = false;
                return;
            }
            
            if (sessionState.mode === 'analysis') {
                if (!window.digitAnalysis.analysisComplete) {
                    log('üîç Analysis mode: Collecting market data...', 'ANALYSIS');
                    updateTradeStatus('ANALYZING', 'Collecting market data for analysis', `Samples: ${window.digitAnalysis.samplesCollected}/${window.digitAnalysis.requiredSamples}`, 'normal');
                    window.nextTradeAllowed = false;
                } else {
                    log('‚úÖ Analysis complete. Ready for smart trading.', 'ANALYSIS');
                    updateTradeStatus('ANALYSIS READY', 'Market analysis complete', 'Switch to SMART mode or use SMART TRADE button', 'normal');
                }
            } else if (sessionState.mode === 'smart' && !sessionState.sessionDigit) {
                log('üß† SMART mode: No digit selected', 'SYSTEM');
                updateTradeStatus('WAITING', 'No digit selected for smart mode', 'Set a digit or use SMART TRADE button', 'normal');
                window.nextTradeAllowed = false;
            } else if (sessionState.mode === 'smart' && sessionState.sessionDigit !== null) {
                log(`üß† SMART mode: Using digit ${sessionState.sessionDigit}`, 'SESSION');
                updateTradeStatus('READY', `Digit ${sessionState.sessionDigit} selected`, 'Ready to trade with analyzed digit', 'normal');
                window.nextTradeAllowed = true;
            } else if (sessionState.mode === 'instant') {
                window.nextTradeAllowed = true;
                updateTradeStatus('READY', 'Instant mode active', 'Trading on each tick', 'normal');
            }
        }
        
        // DOM Ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ü§ñ Bot initialized with OAuth authentication');
            
            // Initialize OAuth FIRST
            initializeOAuth();
            
            // Initialize digit grid display
            function updateDigitGridDisplay() {
                const digitGrid = document.getElementById('digit_grid');
                if (!digitGrid) return;
                
                let gridHTML = '';
                for (let i = 0; i < 10; i++) {
                    gridHTML += `
                        <div class="digit-cell digit-normal p-1 rounded text-center cursor-pointer" 
                             onclick="selectDigitFromAnalysis(${i})"
                             title="Click to select digit ${i}">
                            <div class="font-bold text-lg">${i}</div>
                            <div class="text-xs">0</div>
                        </div>
                    `;
                }
                digitGrid.innerHTML = gridHTML;
            }
            
            updateNetworkRecoveryButton();
            
            window.digitAnalysis.init();
            updateDigitGridDisplay();
            
            setInterval(calculateRates, 1000);
            startQueueProcessor();
            
            calculateMartingale();
            
            // Event listeners
            document.getElementById('baseStake').addEventListener('change', syncCalculatorWithMain);
            document.getElementById('multiplier').addEventListener('change', syncCalculatorWithMain);
            document.getElementById('maxTrades').addEventListener('change', syncCalculatorWithMain);
            document.getElementById('calc_base_stake').addEventListener('change', () => {
                document.getElementById('baseStake').value = document.getElementById('calc_base_stake').value;
            });
            document.getElementById('calc_multiplier').addEventListener('change', () => {
                document.getElementById('multiplier').value = document.getElementById('calc_multiplier').value;
            });
            document.getElementById('calc_max_trades').addEventListener('change', () => {
                document.getElementById('maxTrades').value = document.getElementById('calc_max_trades').value;
            });
            
            document.getElementById('analysisSamples').addEventListener('change', function() {
                const samples = parseInt(this.value);
                if (samples < 20) this.value = 20;
                if (samples > 200) this.value = 200;
                window.digitAnalysis.requiredSamples = parseInt(this.value);
            });
            
            log('ü§ñ Enhanced digit analysis system ready', 'SYSTEM');
            switchMode('instant');
            updatePnL();
            resetTradeStatus();
            
            document.getElementById('predictedDigit').addEventListener('change', function() {
                const newDigit = parseInt(this.value);
                if (!isNaN(newDigit) && newDigit >= 0 && newDigit <= 9) {
                    
                    if (sessionState.sessionStarted) {
                        const confirmChange = confirm('‚ö†Ô∏è Changing digit will reset current session. Continue?');
                        if (!confirmChange) {
                            this.value = sessionState.sessionDigit || 5;
                            return;
                        }
                    }
                    
                    sessionState.sessionDigit = newDigit;
                    sessionState.sessionStarted = true;
                    sessionState.manualOverride = true;
                    log(`üî¢ Digit manually set to ${newDigit}`, 'SESSION');
                    
                    if (window.digitAnalysis.coldDigits.includes(newDigit)) {
                        log(`‚ö†Ô∏è Warning: Digit ${newDigit} is identified as COLD (infrequent)`, 'ANALYSIS');
                        updateTradeStatus('WARNING', `Digit ${newDigit} is COLD (infrequent)`, 'Consider changing digit', 'loss');
                    }
                    
                    updateTradeStatus('MANUAL', `Digit ${newDigit} manually set`, 'Ready to trade', 'normal');
                }
            });
        });
        
        // ============================================================================
        // WEBSOCKET CONNECTION WITH OAUTH
        // ============================================================================
        
        function connectWebSocket() {
            // Check authentication first
            if (!checkAuthenticationBeforeStart()) {
                return;
            }
            
            // Close existing connection if any
            if (window.ws) {
                try {
                    window.ws.close();
                } catch (e) {
                    console.log('Error closing previous connection:', e);
                }
                window.ws = null;
            }
            
            window.isConnecting = true;
            updateConnectionStatus();
            
            // Use OAuth token from state
            const token = window.oauthState.currentToken;
            
            if (!token) {
                log('‚ùå No authentication token available', 'ERROR');
                showAuth();
                stopBot();
                return;
            }
            
            // WebSocket URL
            const wsUrl = `${DERIV_CONFIG.api_url}?app_id=${DERIV_CONFIG.app_id}`;
            log('üîó Connecting to Deriv API with OAuth token...', 'SYSTEM');
            
            try {
                window.ws = new WebSocket(wsUrl);
                
                window.ws.onopen = () => {
                    window.isConnecting = false;
                    resetReconnectionAttempts();
                    log('‚úÖ WebSocket connected', 'SYSTEM');
                    updateConnectionStatus();
                    
                    // Send authorization with OAuth token
                    sendRequest({ 
                        authorize: token, 
                        req_id: getNextReqId() 
                    });
                };
                
                window.ws.onmessage = (msg) => {
                    try {
                        const data = JSON.parse(msg.data);
                        handleAPIResponse(data);
                    } catch (e) {
                        console.error('WebSocket message error:', e);
                        log('‚ùå Error parsing WebSocket message', 'ERROR');
                    }
                };
                
                window.ws.onclose = (event) => {
                    window.isConnecting = false;
                    updateConnectionStatus();
                    log(`üîå WebSocket disconnected (Code: ${event.code}, Reason: ${event.reason || 'No reason'})`, 'SYSTEM');
                    
                    if (window.isBotRunning) {
                        window.lastDisconnectTime = Date.now();
                        
                        if (window.networkRecoveryEnabled) {
                            attemptNetworkRecovery();
                        } else {
                            log('‚ö†Ô∏è Network recovery disabled. Manual restart required.', 'NETWORK');
                            updateTradeStatus('DISCONNECTED', 'WebSocket disconnected', 'Click START to reconnect', 'normal');
                        }
                    }
                };
                
                window.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    log('‚ùå WebSocket connection error', 'ERROR');
                    window.isConnecting = false;
                    updateConnectionStatus();
                    
                    if (window.isBotRunning && window.networkRecoveryEnabled) {
                        setTimeout(() => attemptNetworkRecovery(), 1000);
                    }
                };
                
                // Set timeout for connection
                setTimeout(() => {
                    if (window.ws && window.ws.readyState === WebSocket.CONNECTING) {
                        log('‚è∞ Connection timeout - trying alternative method...', 'WARNING');
                        window.ws.close();
                        window.isConnecting = false;
                        updateConnectionStatus();
                    }
                }, 10000);
                
            } catch (error) {
                console.error('Error creating WebSocket:', error);
                log('‚ùå Failed to create WebSocket connection', 'ERROR');
                window.isConnecting = false;
                updateConnectionStatus();
                
                if (window.isBotRunning && window.networkRecoveryEnabled) {
                    attemptNetworkRecovery();
                }
            }
        }
        
        function handleTick(tick) {
            if (!window.isBotRunning) return;
            
            const price = parseFloat(tick.quote);
            const symbol = document.getElementById('symbol').value;
            let decimalPlaces = 3;
            if (symbol === 'R_100') decimalPlaces = 2;
            const formattedPrice = price.toFixed(decimalPlaces);
            const digit = formattedPrice.charAt(formattedPrice.length - 1);
            
            const tickData = { 
                digit: digit, 
                price: price, 
                time: Date.now() 
            };
            
            window.lastTick = tickData;
            
            document.getElementById('metricLiveTick').textContent = price.toFixed(3);
            document.getElementById('metricLastDigit').textContent = `Digit: ${digit}`;
            document.getElementById('metricLiveTick').classList.add('tick-flash');
            setTimeout(() => document.getElementById('metricLiveTick').classList.remove('tick-flash'), 50);
            
            window.stats.totalTicks++;
            window.botTickTimestamps.push(Date.now());
            
            window.totalTicksReceived++;
            window.tickTimestamps.push(Date.now());
            const tenSecondsAgo = Date.now() - 10000;
            window.tickTimestamps = window.tickTimestamps.filter(ts => ts > tenSecondsAgo);
            
            if (window.digitAnalysis.active) {
                window.digitAnalysis.addDigit(digit);
                
                if (window.digitAnalysis.analysisComplete && sessionState.mode === 'analysis') {
                    log('‚úÖ Analysis complete. Switching to SMART mode...', 'ANALYSIS');
                    switchMode('smart');
                    
                    const smartRec = window.digitAnalysis.getSmartDigit();
                    if (smartRec.digit !== null) {
                        document.getElementById('predictedDigit').value = smartRec.digit;
                        sessionState.sessionDigit = smartRec.digit;
                        log(`üß† Auto-selected digit ${smartRec.digit} (${smartRec.confidence.toFixed(0)}% confidence)`, 'ANALYSIS');
                    }
                }
            }
            
            addTickToQueue(tickData);
            playAudioFeedback('TICK');
        }
        
        function addTickToQueue(tick) {
            window.tickQueue.push(tick);
            if (window.tickQueue.length > window.maxQueueSize) {
                window.tickQueue.shift();
            }
            
            return true;
        }
        
        function processTickImmediately(tick) {
            if (window.stopAfterWin) return;
            
            if (sessionState.mode === 'smart' && !sessionState.sessionDigit) {
                return;
            }
            
            if (checkForImmediateWin(tick)) {
                return;
            }
            
            if (window.tradeCount >= window.maxTrades) {
                log(`üõë Max trades reached (${window.maxTrades})`, 'CRITICAL');
                updateTradeStatus('MAX TRADES', `Maximum trades reached (${window.maxTrades})`, 'Bot stopped', 'loss');
                stopBot();
                return;
            }
            
            window.executionLock = true;
            window.nextTradeAllowed = false;
            
            try {
                window.stats.tradesExecuted++;
                window.tradeCount++;
                document.getElementById('metricTradeCount').textContent = window.tradeCount;
                
                log(`‚ö° Trade #${window.tradeCount}: ${tick.price.toFixed(3)} (Digit ${tick.digit})`, 'TRADE');
                
                updateTradeStatus(
                    'TRADING',
                    `Trade #${window.tradeCount}: $${window.currentStake.toFixed(2)} on digit ${parseInt(document.getElementById('predictedDigit').value)}`,
                    'Executing trade...',
                    'trade'
                );
                
                playAudioFeedback('EXECUTION');
                executeTrade(tick);
                
            } catch (error) {
                log(`‚ùå Error: ${error}`, 'ERROR');
                window.executionLock = false;
                window.nextTradeAllowed = true;
                updateTradeStatus('ERROR', `Trade failed: ${error}`, 'Retrying...', 'loss');
            }
        }
        
        function executeTrade(tick) {
            const contractType = document.getElementById('contractType').value;
            const symbol = document.getElementById('symbol').value;
            const predictedDigit = parseInt(document.getElementById('predictedDigit').value);
            
            let stake = window.currentStake;
            trackTradeInvestment(stake);
            
            const proposalRequest = {
                proposal: 1,
                amount: stake.toFixed(2),
                basis: "stake",
                contract_type: contractType,
                currency: "USD",
                duration: 1,
                duration_unit: "t",
                symbol: symbol,
                barrier: predictedDigit.toString(),
                req_id: getNextReqId()
            };
            
            window.pendingProposals.set(proposalRequest.req_id, {
                tick: tick,
                stake: stake,
                contractType: contractType,
                predictedDigit: predictedDigit,
                startTime: Date.now(),
                tradeNumber: window.tradeCount,
                martingaleStep: window.martingaleStep
            });
            
            sendRequest(proposalRequest);
        }
        
        function checkForImmediateWin(tick) {
            if (!window.isBotRunning || window.stopAfterWin) return false;
            
            const predictedDigit = parseInt(document.getElementById('predictedDigit').value);
            const tickDigit = parseInt(tick.digit);
            
            if (tickDigit === predictedDigit) {
                log(`üéØ IMMEDIATE WIN! Digit ${tickDigit} matches ${predictedDigit}`, 'WIN');
                
                window.lastTradeResult = 'win';
                window.stopAfterWin = true;
                window.stats.wins++;
                window.tradeCount++;
                
                playAudioFeedback('WIN');
                
                const payout = window.currentStake * 9;
                trackTradePayout(payout);
                log(`üí∞ Payout: $${payout.toFixed(2)}`, 'PNL');
                
                startExtendedPnlUpdate(payout);
                
                updateTradeStatus(
                    'IMMEDIATE WIN üéØ',
                    `Digit ${tickDigit} matched! Payout: $${payout.toFixed(2)}`,
                    'PnL updating for 10 seconds...',
                    'win'
                );
                
                updateStake('win');
                return true;
            }
            
            return false;
        }
        
        function updateStake(winOrLoss) {
            window.baseStake = parseFloat(document.getElementById('baseStake').value) || 1.0;
            window.multiplier = parseFloat(document.getElementById('multiplier').value) || 1.15;
            window.maxTrades = parseInt(document.getElementById('maxTrades').value) || 10;
            
            if (winOrLoss === 'win') {
                window.martingaleStep = 0;
                window.currentStake = window.baseStake;
                log(`‚úÖ WIN! Reset stake: $${window.currentStake.toFixed(2)}`, 'WIN');
                
                const payout = window.currentStake * 9;
                trackTradePayout(payout);
                log(`üí∞ Payout: $${payout.toFixed(2)}`, 'PNL');
                
                startExtendedPnlUpdate(payout);
                
                updateTradeStatus(
                    'WIN üéØ',
                    `WON! Digit matched - Payout: $${payout.toFixed(2)}`,
                    'PnL updating for 10 seconds...',
                    'win'
                );
                
            } else if (winOrLoss === 'loss') {
                window.martingaleStep++;
                
                if (window.martingaleStep >= window.maxTrades) {
                    log(`üõë MAX TRADES REACHED (${window.maxTrades})`, 'CRITICAL');
                    updateTradeStatus('MAX TRADES', `Maximum trades reached (${window.maxTrades})`, 'Bot stopped', 'loss');
                    stopBot();
                    return;
                }
                
                const newStake = window.currentStake * window.multiplier;
                window.currentStake = parseFloat(newStake.toFixed(2));
                log(`‚ùå LOSS. Next stake: $${window.currentStake.toFixed(2)} (Step: ${window.martingaleStep})`, 'LOSS');
                
                updateTradeStatus(
                    'LOSS ‚ùå',
                    `Lost - Next: $${window.currentStake.toFixed(2)}`,
                    'Increasing stake',
                    'loss'
                );
                
                updatePnL();
                
            } else {
                window.martingaleStep = 0;
                window.currentStake = window.baseStake;
                log(`Starting. Base stake: $${window.currentStake.toFixed(2)}`, 'SYSTEM');
                updateTradeStatus('STARTING', `Base stake: $${window.currentStake.toFixed(2)}`, 'Waiting for trades', 'normal');
            }
            
            const stakeElem = document.getElementById('metricCurrentStake');
            stakeElem.textContent = `$${window.currentStake.toFixed(2)}`;
            stakeElem.className = winOrLoss === 'win' ? 'text-lg font-bold text-green-400' : 'text-lg font-bold text-white';
        }
        
        function startBot() {
            // Check authentication FIRST
            if (!checkAuthenticationBeforeStart()) {
                return;
            }
            
            if (window.isBotRunning) {
                stopBot();
                return;
            }
            
            window.maxTrades = parseInt(document.getElementById('maxTrades').value) || 10;
            
            resetAllState();
            
            sessionState.sessionDigit = parseInt(document.getElementById('predictedDigit').value) || 5;
            sessionState.sessionStarted = true;
            sessionState.manualOverride = true;
            
            window.isBotRunning = true;
            updateButtonState();
            
            log('üöÄ Starting bot...', 'SYSTEM');
            log(`üìä Mode: ${sessionState.mode}`, 'SYSTEM');
            log(`üìä Max Trades: ${window.maxTrades}`, 'SYSTEM');
            log(`üåê Network auto-recovery: ${window.networkRecoveryEnabled ? 'ENABLED' : 'DISABLED'}`, 'SYSTEM');
            log(`üîê Account: ${window.oauthState.currentAccount.type.toUpperCase()}`, 'SYSTEM');
            
            updateTradeStatus('STARTING', 'Initializing bot...', 'Connecting to market', 'normal');
            updateStake('initial');
            initTone();
            connectWebSocket();
            
            document.querySelectorAll('#symbol, #predictedDigit, #contractType, #baseStake, #multiplier, #maxTrades').forEach(control => {
                control.disabled = true;
                control.classList.add('opacity-50', 'cursor-not-allowed');
            });
        }
        
        function stopBot() {
            if (!window.isBotRunning) return;
            
            window.isBotRunning = false;
            window.nextTradeAllowed = false;
            window.stopAfterWin = false;
            updateButtonState();
            
            log('‚èπÔ∏è Bot stopped', 'SYSTEM');
            
            if (window.pnlUpdateInterval) {
                clearInterval(window.pnlUpdateInterval);
                window.pnlUpdateInterval = null;
            }
            
            resetReconnectionAttempts();
            
            if (window.ws) {
                try {
                    window.ws.close();
                } catch (e) {}
                window.ws = null;
            }
            window.tickSubscriptionSent = false;
            window.pendingProposals.clear();
            window.executionLock = false;
            
            document.querySelectorAll('#symbol, #predictedDigit, #contractType, #baseStake, #multiplier, #maxTrades').forEach(control => {
                control.disabled = false;
                control.classList.remove('opacity-50', 'cursor-not-allowed');
            });
            
            updateConnectionStatus();
            
            const finalPnL = updatePnL();
            log(`üí∞ Final PnL: ${finalPnL >= 0 ? '+' : ''}$${finalPnL.toFixed(2)}`, 'PNL');
            
            updateTradeStatus(
                'STOPPED',
                `Final PnL: ${finalPnL >= 0 ? '+' : ''}$${finalPnL.toFixed(2)}`,
                'Bot stopped - Ready for new session',
                finalPnL > 0 ? 'win' : 'normal'
            );
            
            sessionState.sessionStarted = false;
        }
        
        function toggleBot() {
            if (window.isBotRunning) {
                stopBot();
            } else {
                startBot();
            }
        }
        
        function calculateRates() {
            const now = Date.now();
            window.botTickTimestamps = window.botTickTimestamps.filter(ts => now - ts < 5000);
            const tickRate = window.botTickTimestamps.length / 5;
            document.getElementById('metricTickRate').textContent = `Ticks/sec: ${tickRate.toFixed(1)}`;
        }
        
        function toggleSound() {
            window.soundEnabled = !window.soundEnabled;
            localStorage.setItem('soundEnabled', window.soundEnabled);
            updateSoundButton();
            log(`üîä Sound ${window.soundEnabled ? 'ON' : 'OFF'}`, 'SYSTEM');
        }
        
        function updateSoundButton() {
            if (soundToggleButton) {
                soundToggleButton.textContent = window.soundEnabled ? 'üîä Sound ON' : 'üîá Sound OFF';
                soundToggleButton.className = window.soundEnabled ? 
                    'px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700 transition' :
                    'px-4 py-2 bg-gray-600 text-white font-bold rounded-lg shadow hover:bg-gray-700 transition';
            }
        }
        
        async function initTone() {
            if (!window.soundEnabled) return;
            
            if (typeof Tone === 'undefined') {
                console.error("Tone.js not loaded");
                return;
            }
            
            try {
                await Tone.start();
                window.synth = new Tone.Synth().toDestination();
                window.ToneInitialized = true;
            } catch (e) {
                console.error("Audio init error:", e);
            }
        }
        
        function playAudioFeedback(type) {
            if (!window.soundEnabled || !window.ToneInitialized || !window.synth) return;
            
            try {
                if (type === 'WIN') {
                    window.synth.triggerAttackRelease("C5", "8n");
                    setTimeout(() => window.synth.triggerAttackRelease("E5", "8n"), 100);
                    setTimeout(() => window.synth.triggerAttackRelease("G5", "8n"), 200);
                } else if (type === 'TICK') {
                    window.synth.triggerAttackRelease("C4", "32n", Tone.now(), 0.3);
                } else if (type === 'EXECUTION') {
                    window.synth.triggerAttackRelease("E5", "16n", Tone.now(), 0.5);
                }
            } catch (e) {
                console.error("Audio error:", e);
            }
        }
        
        function log(message, type = 'INFO') {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            let color = 'text-lime-400';
            if (type === 'ERROR') color = 'text-red-500 font-bold'; 
            if (type === 'WARNING') color = 'text-yellow-400';
            if (type === 'TRADE') color = 'text-green-300';
            if (type === 'WIN') color = 'text-green-400 font-bold';
            if (type === 'LOSS') color = 'text-red-400 font-bold';
            if (type === 'TICK') color = 'text-cyan-300';
            if (type === 'SYSTEM') color = 'text-white';
            if (type === 'PNL') color = 'text-purple-300 font-bold';
            if (type === 'SESSION') color = 'text-blue-300 font-bold';
            if (type === 'CALCULATOR') color = 'text-purple-300 font-bold';
            if (type === 'NETWORK') color = 'text-yellow-300 font-bold';
            if (type === 'ANALYSIS') color = 'text-cyan-300 font-bold';
            if (type === 'AUTH') color = 'text-blue-300 font-bold';
            
            logArea.innerHTML += `\n[${timestamp}] <span class="${color}">${message}</span>`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function updateButtonState() {
            if (!toggleButton) return;
            
            if (window.isBotRunning) {
                toggleButton.innerHTML = '<span class="flex items-center justify-center"><span class="mr-2">‚èπÔ∏è</span> STOP BOT</span>';
                toggleButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'start-button-active');
                toggleButton.classList.add('stop-button-active', 'hover:bg-red-700');
            } else {
                toggleButton.innerHTML = '<span class="flex items-center justify-center"><span class="mr-2">üöÄ</span> START BOT</span>';
                toggleButton.classList.remove('stop-button-active', 'hover:bg-red-700');
                toggleButton.classList.add('bg-green-600', 'hover:bg-green-700', 'start-button-active');
            }
        }
        
        function startQueueProcessor() {
            setInterval(() => {
                if (!window.isBotRunning || window.stopAfterWin) return;
                
                while (window.tickQueue.length > 0 && !window.executionLock && window.nextTradeAllowed) {
                    const tick = window.tickQueue.shift();
                    processTickImmediately(tick);
                }
            }, 50);
        }
        
        function sendRequest(request) {
            if (window.ws && window.ws.readyState === WebSocket.OPEN) {
                const message = JSON.stringify(request);
                window.ws.send(message);
                return request.req_id;
            } else {
                log('‚ùå WebSocket not connected', 'ERROR');
                return null;
            }
        }
        
        function getNextReqId() {
            return ++window.req_id;
        }
        
        function handleAPIResponse(data) {
            if (data.error) {
                log(`API Error: ${data.error.message}`, 'ERROR');
                if (data.error.code === 'InvalidToken' || data.error.code === 'AuthorizationRequired') {
                    log('‚ùå Invalid or expired OAuth token. Please login again.', 'AUTH');
                    logout();
                    showAuth();
                }
                return;
            }
        
            if (data.msg_type === 'authorize') {
                if (data.authorize) {
                    log(`üîê Authorized as ${data.authorize.loginid}`, 'SYSTEM');
                    log(`üí∞ Balance: $${data.authorize.balance || '0.00'}`, 'SYSTEM');
                    
                    // Store last used token
                    localStorage.setItem('last_used_token', window.oauthState.currentToken);
                    
                    // Update balance display
                    document.getElementById('metricAccountBalance').textContent = `$${(data.authorize.balance || 0).toFixed(2)}`;
                    document.getElementById('accountBalance').textContent = `$${(data.authorize.balance || 0).toFixed(2)}`;
                    document.getElementById('userBalance').textContent = `$${(data.authorize.balance || 0).toFixed(2)}`;
                    
                    window.startingBalance = parseFloat(data.authorize.balance || 0);
                    window.currentBalance = window.startingBalance;
                    
                    subscribeToTicks(document.getElementById('symbol').value);
                }
            } else if (data.msg_type === 'tick') {
                handleTick(data.tick);
            } else if (data.msg_type === 'proposal') {
                handleProposalResponse(data.proposal, data.req_id);
            } else if (data.msg_type === 'buy') {
                handleBuyResponse(data.buy);
            } else if (data.msg_type === 'balance') {
                handleBalanceUpdate(data.balance);
            }
        }
        
        function subscribeToTicks(symbol) {
            if (window.tickSubscriptionSent) return;
            
            log(`üì° Subscribing to ${symbol} ticks...`, 'SYSTEM');
            sendRequest({ ticks: symbol, subscribe: 1, req_id: getNextReqId() });
            window.tickSubscriptionSent = true;
        }
        
        function handleBalanceUpdate(balanceData) {
            const newBalance = parseFloat(balanceData.balance);
            
            if (window.startingBalance === 0) {
                window.startingBalance = newBalance;
                log(`üí∞ Starting Balance: $${window.startingBalance.toFixed(2)}`, 'PNL');
            }
            
            window.currentBalance = newBalance;
            const balanceElem = document.getElementById('metricAccountBalance');
            balanceElem.textContent = `$${window.currentBalance.toFixed(2)}`;
            balanceElem.className = 'text-lg font-bold balance-green';
            updatePnL();
        }
        
        function handleProposalResponse(proposal, req_id) {
            if (!proposal || !proposal.id) {
                log(`‚ùå Proposal failed`, 'ERROR');
                updateTradeStatus('ERROR', 'Proposal failed', 'Retrying...', 'loss');
                return;
            }
        
            const pending = window.pendingProposals.get(req_id);
            if (!pending) return;
        
            window.pendingProposals.delete(req_id);
            executeBuy(proposal.id, proposal.ask_price, pending);
        }
        
        function executeBuy(proposal_id, ask_price, pending) {
            const buyRequest = {
                buy: proposal_id,
                price: ask_price,
                req_id: getNextReqId()
            };
            
            log(`‚úÖ Buying: $${pending.stake.toFixed(2)} on digit ${pending.predictedDigit}`, 'TRADE');
            
            window.pendingProposals.set(buyRequest.req_id, {
                ...pending,
                proposal_id: proposal_id,
                buyStartTime: Date.now()
            });
            
            sendRequest(buyRequest);
        }
        
        function handleBuyResponse(buyData) {
            if (buyData.contract_id) {
                log(`‚úÖ Trade executed successfully`, 'TRADE');
                
                const wasWin = buyData.longcode && buyData.longcode.includes("win");
                
                updateStake(wasWin ? 'win' : 'loss');
                onTradeComplete(true);
            } else {
                log(`‚ùå Trade failed`, 'ERROR');
                updateTradeStatus('ERROR', 'Trade execution failed', 'Retrying...', 'loss');
                onTradeComplete(false);
            }
        }
        
        function onTradeComplete(isSuccess = true) {
            window.executionLock = false;
            window.nextTradeAllowed = true;
            
            if (!isSuccess) {
                updateStake('loss');
            }
            
            if (window.stopAfterWin) {
                return;
            }
            
            if (window.tradeCount >= window.maxTrades) {
                log(`üõë Max trades reached (${window.maxTrades})`, 'CRITICAL');
                updateTradeStatus('MAX TRADES', `Maximum trades reached (${window.maxTrades})`, 'Bot stopped', 'loss');
                stopBot();
                return;
            }
        }
        
        function resetAllState() {
            window.maxTrades = parseInt(document.getElementById('maxTrades').value) || 10;
            
            updateStake('initial');
            resetPnL();
            resetTradeStatus();
            
            window.startingBalance = 0.0;
            window.currentBalance = 0.0;
            window.netProfit = 0.0;
            
            document.getElementById('metricTradeCount').textContent = '0';
            document.getElementById('metricAccountBalance').textContent = '$---';
            document.getElementById('metricLiveTick').textContent = '---';
            document.getElementById('metricLastDigit').textContent = 'Digit: ?';
            
            window.stats = { totalTicks: 0, tradesExecuted: 0, wins: 0, losses: 0 };
            window.tickQueue = [];
            window.lastTick = null;
            window.lastTradeResult = null;
            window.tradeCount = 0;
            window.martingaleStep = 0;
            window.pendingProposals.clear();
            window.botTickTimestamps = [];
            
            window.executionLock = false;
            window.waitingForTradeResult = false;
            window.nextTradeAllowed = true;
            window.stopAfterWin = false;
            window.tickSubscriptionSent = false;
            
            const logArea = document.getElementById('log-area');
            logArea.innerHTML = '[00:00:00] ü§ñ Bot reset. Ready.';
            
            log('üîÑ Bot reset', 'SYSTEM');
        }
    </script>
</body>
</html>
