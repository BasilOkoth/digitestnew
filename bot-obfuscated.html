<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deriv Dual Trade Bot (UNDER9 + OVER0) with 0/9 Risk Filter</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#111827; }
    #log::-webkit-scrollbar{ width:4px; }
    #log::-webkit-scrollbar-thumb{ background:#4ade80; border-radius:2px; }
    #log::-webkit-scrollbar-track{ background:#374151; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .badge-ok { background: linear-gradient(90deg, #10b981, #059669) !important; }
    .badge-bad { background: linear-gradient(90deg, #dc2626, #b91c1c) !important; }
    .badge-warn { background: linear-gradient(90deg, #f59e0b, #d97706) !important; }
  </style>
</head>

<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">
  <div class="w-full max-w-6xl bg-gray-800 text-gray-100 shadow-2xl rounded-xl p-5 md:p-6 space-y-5">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl sm:text-3xl font-extrabold text-blue-400">
        ðŸŽ¯ Dual Digit Bot: UNDER 9 + OVER 0
        <span id="badge" class="ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full badge-bad text-white shadow-md">
          DISCONNECTED
        </span>
      </h1>
    </div>

    <!-- TOKEN -->
    <div class="bg-gray-900 border border-gray-700 rounded-xl p-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
        <div class="md:col-span-2">
          <label class="block text-xs font-semibold text-gray-300 mb-1">Deriv API Token</label>
          <input id="token" type="password" placeholder="Paste token..."
                 class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-3 py-2 text-sm" />
          <div class="text-[11px] text-gray-400 mt-1">Stored locally only if you click Save.</div>
        </div>
        <div class="flex gap-2">
          <button id="saveToken" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold">Save</button>
          <button id="clearToken" class="w-full px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg font-bold">Clear</button>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- LEFT: METRICS -->
      <div class="bg-gray-900 border border-gray-700 rounded-xl p-4 space-y-3">
        <div class="grid grid-cols-2 gap-2 text-xs">
          <div class="p-2 bg-gray-800 rounded border border-gray-700">
            <div class="text-gray-400">Symbol</div>
            <div id="symLabel" class="font-bold text-cyan-300">R_100</div>
          </div>
          <div class="p-2 bg-gray-800 rounded border border-gray-700">
            <div class="text-gray-400">Balance</div>
            <div id="bal" class="font-bold text-green-400">$---</div>
          </div>
          <div class="p-2 bg-gray-800 rounded border border-gray-700">
            <div class="text-gray-400">Rounds</div>
            <div id="rounds" class="font-bold text-yellow-300">0/0</div>
          </div>
          <div class="p-2 bg-gray-800 rounded border border-gray-700">
            <div class="text-gray-400">Session P/L</div>
            <div id="pnl" class="font-bold text-white">$0.00</div>
          </div>
        </div>

        <div class="p-3 bg-gray-800 rounded border border-gray-700">
          <div class="text-xs text-gray-400">Last Tick</div>
          <div id="tick" class="text-lg font-bold text-white mono">---</div>
          <div id="digit" class="text-xs text-green-300">Digit: ?</div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div class="p-3 bg-gray-800 rounded border border-gray-700 text-center">
            <div class="text-xs text-gray-400">0/9 Rate</div>
            <div id="zRate" class="text-lg font-bold text-white mono">-</div>
            <div class="text-[11px] text-gray-400">last N ticks</div>
          </div>
          <div class="p-3 bg-gray-800 rounded border border-gray-700 text-center">
            <div class="text-xs text-gray-400">Gate</div>
            <div id="gate" class="text-lg font-bold text-white mono">-</div>
            <div class="text-[11px] text-gray-400">trade or skip</div>
          </div>
        </div>

        <div class="p-3 bg-gray-800 rounded border border-gray-700">
          <div class="text-xs text-gray-400">Strategy</div>
          <div class="text-sm font-bold text-gray-200">
            Place BOTH:
            <span class="text-blue-300">UNDER 9</span> +
            <span class="text-purple-300">OVER 0</span>
          </div>
          <div class="text-[11px] text-gray-400 mt-1">
            If digit is 1â€“8 â‡’ both win. If 0 or 9 â‡’ one loses.
          </div>
        </div>

        <div class="p-3 bg-gray-800 rounded border border-gray-700">
          <div class="text-xs text-gray-400">Status</div>
          <div id="status" class="text-sm font-bold text-gray-200">Ready</div>
          <div id="status2" class="text-xs text-gray-400">Paste token â†’ Start</div>
        </div>
      </div>

      <!-- RIGHT: CONTROLS + LOGS -->
      <div class="lg:col-span-2 bg-gray-900 border border-gray-700 rounded-xl p-4 space-y-3">
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">Symbol</label>
            <select id="symbol" class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-2 text-sm">
              <option value="R_10">V. 10 Index</option>
              <option value="R_25">V. 25 Index</option>
              <option value="R_50">V. 50 Index</option>
              <option value="R_75">V. 75 Index</option>
              <option value="R_100" selected>V. 100 Index</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">Risk Window (ticks)</label>
            <input id="window" type="number" min="20" max="500" value="100"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-2 text-sm" />
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">Min Ticks</label>
            <input id="minTicks" type="number" min="1" max="500" value="30"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-2 text-sm" />
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">0/9 Max Rate</label>
            <input id="zTh" type="number" min="0" max="1" step="0.01" value="0.12"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-2 text-sm" />
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">Stake per leg ($)</label>
            <input id="stake" type="number" min="0.35" step="0.01" value="1.00"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-2 text-sm" />
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">Multiplier</label>
            <input id="mult" type="number" min="1.0" step="0.1" value="1.5"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-2 text-sm" />
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">Max Steps</label>
            <input id="steps" type="number" min="0" max="20" value="3"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-2 text-sm" />
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">Max Rounds</label>
            <input id="maxRounds" type="number" min="1" max="500" value="10"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-2 text-sm" />
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">Stop Mode</label>
            <select id="stopMode" class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-2 text-sm">
              <option value="firstRoundWin" selected>Stop on first round WIN</option>
              <option value="breakEven">Stop at break-even (PnL â‰¥ 0)</option>
              <option value="targetProfit">Stop at target profit</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">Target Profit ($)</label>
            <input id="targetProfit" type="number" min="0" step="0.01" value="1.00"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-2 text-sm" />
          </div>
        </div>

        <div class="flex justify-center pt-2">
          <button id="toggle"
                  class="w-full md:w-2/3 px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-extrabold text-lg">
            START
          </button>
        </div>

        <div>
          <h2 class="text-sm font-bold text-gray-300 mb-2 border-b border-gray-700 pb-1">Logs</h2>
          <div id="log" class="h-80 bg-gray-950 border border-gray-800 rounded-lg p-3 text-xs text-lime-300 overflow-y-scroll whitespace-pre-wrap"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================================
    // Pseudocode
    // 1) Build a rolling window of digits. Compute zRate = (count(0)+count(9))/N.
    // 2) Only trade when:
    //    - digits.length >= minTicks
    //    - zRate <= zThreshold  (meaning 0/9 is "reduced")
    // 3) When trading, place TWO contracts concurrently (one round):
    //    A) DIGITUNDER barrier=9  (wins on 0..8)
    //    B) DIGITOVER  barrier=0  (wins on 1..9)
    //    If tick is 1..8 -> both win.
    //    If tick is 0 -> UNDER9 win, OVER0 loss.
    //    If tick is 9 -> OVER0 win, UNDER9 loss.
    // 4) Track both contract settlements. Round PnL = sum(legPnL).
    // 5) Martingale: increase stake per leg on round loss, reset on round win.
    // 6) Stop rules:
    //    - maxRounds
    //    - stopMode: firstRoundWin / breakEven / targetProfit
    // ============================================================

    const $ = (id) => document.getElementById(id);
    const logBox = $("log");

    const state = {
      ws: null,
      reqId: 0,
      running: false,

      token: "",
      symbol: "R_100",

      window: 100,
      minTicks: 30,
      zThreshold: 0.12,

      baseStake: 1.0,     // per leg
      mult: 1.5,
      maxSteps: 3,
      step: 0,
      stake: 1.0,         // per leg current

      maxRounds: 10,
      rounds: 0,

      stopMode: "firstRoundWin",
      targetProfit: 1.0,

      digits: [],

      // round state
      inRound: false,
      roundId: 0,
      liveContracts: new Set(), // contract ids for current round
      roundProfit: 0,
      roundLegsSettled: 0,

      lastBalance: null,
      pnl: 0,

      contracts: new Map(), // contract_id -> { buyPrice, stake, label, roundId }
    };

    const pending = {
      // we place 2 proposals -> 2 buys in a round
      legs: [], // { label, contractType, barrier, proposalReqId, buyReqId, stake }
      byProposalReqId: new Map(),
      byBuyReqId: new Map(),
    };

    function ts() {
      return new Date().toLocaleTimeString("en-US", { hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit" });
    }

    function log(msg) {
      logBox.textContent += `[${ts()}] ${msg}\n`;
      logBox.scrollTop = logBox.scrollHeight;
    }

    function setBadge(status) {
      const b = $("badge");
      if (status === "connected") {
        b.textContent = "CONNECTED";
        b.className = "ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full badge-ok text-white shadow-md";
      } else if (status === "connecting") {
        b.textContent = "CONNECTING";
        b.className = "ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full badge-warn text-white shadow-md";
      } else {
        b.textContent = "DISCONNECTED";
        b.className = "ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full badge-bad text-white shadow-md";
      }
    }

    function uiStatus(main, sub) {
      $("status").textContent = main;
      $("status2").textContent = sub || "";
    }

    function clampInt(v, min, max, fallback) {
      const n = parseInt(v, 10);
      if (!Number.isFinite(n)) return fallback;
      return Math.max(min, Math.min(max, n));
    }
    function clampNum(v, min, max, fallback) {
      const n = parseFloat(v);
      if (!Number.isFinite(n)) return fallback;
      return Math.max(min, Math.min(max, n));
    }
    function round2(n) { return Math.round(n * 100) / 100; }

    function renderPnL() {
      $("pnl").textContent = `$${state.pnl.toFixed(2)}`;
      $("pnl").className = state.pnl >= 0 ? "font-bold text-green-400" : "font-bold text-red-400";
    }

    function disableInputs(disabled) {
      ["token","symbol","window","minTicks","zTh","stake","mult","steps","maxRounds","stopMode","targetProfit","saveToken","clearToken"].forEach(id => {
        $(id).disabled = disabled;
        $(id).classList.toggle("opacity-60", disabled);
      });
    }

    function readInputs() {
      state.symbol = $("symbol").value;
      state.window = clampInt($("window").value, 20, 500, 100);
      state.minTicks = clampInt($("minTicks").value, 1, 500, 30);
      state.zThreshold = clampNum($("zTh").value, 0, 1, 0.12);

      state.baseStake = clampNum($("stake").value, 0.35, 100000, 1.0);
      state.mult = clampNum($("mult").value, 1.0, 10.0, 1.5);
      state.maxSteps = clampInt($("steps").value, 0, 20, 3);

      state.maxRounds = clampInt($("maxRounds").value, 1, 500, 10);
      state.stopMode = $("stopMode").value;
      state.targetProfit = clampNum($("targetProfit").value, 0, 100000, 1.0);

      state.stake = state.baseStake;

      $("symLabel").textContent = state.symbol;
      $("rounds").textContent = `${state.rounds}/${state.maxRounds}`;
      renderPnL();
    }

    function nextReqId() { state.reqId += 1; return state.reqId; }
    function send(msg) {
      if (!state.ws || state.ws.readyState !== WebSocket.OPEN) return;
      state.ws.send(JSON.stringify(msg));
    }

    function lastDigit(quote) {
      const s = String(quote);
      const d = parseInt(s[s.length - 1], 10);
      return Number.isFinite(d) ? d : null;
    }

    function pushDigit(d) {
      state.digits.push(d);
      while (state.digits.length > state.window) state.digits.shift();
    }

    function computeZeroNineRate() {
      if (!state.digits.length) return 1;
      let c = 0;
      for (const d of state.digits) if (d === 0 || d === 9) c += 1;
      return c / state.digits.length;
    }

    function gateDecision() {
      if (state.digits.length < state.minTicks) return { ok: false, reason: `Collecting ${state.digits.length}/${state.minTicks}` };
      const zRate = computeZeroNineRate();
      if (zRate > state.zThreshold) return { ok: false, reason: `Skip: 0/9 rate ${zRate.toFixed(3)} > ${state.zThreshold.toFixed(3)}`, zRate };
      return { ok: true, reason: `Trade: 0/9 rate ${zRate.toFixed(3)} â‰¤ ${state.zThreshold.toFixed(3)}`, zRate };
    }

    function applyAfterRoundLoss() {
      state.step += 1;
      if (state.step > state.maxSteps) {
        state.step = 0;
        state.stake = state.baseStake;
        return;
      }
      state.stake = round2(state.baseStake * Math.pow(state.mult, state.step));
    }

    function resetAfterRoundWin() {
      state.step = 0;
      state.stake = state.baseStake;
    }

    // -----------------------
    // WS connect + handlers
    // -----------------------
    function connect() {
      if (state.ws) { try { state.ws.close(); } catch {} }

      setBadge("connecting");
      uiStatus("Connectingâ€¦", "Authorizingâ€¦");

      state.ws = new WebSocket("wss://ws.binaryws.com/websockets/v3?app_id=120389");

      state.ws.onopen = () => {
        setBadge("connected");
        log("WS connected");
        if (!state.token) {
          log("ERROR: missing token");
          stop("Missing token");
          return;
        }
        send({ authorize: state.token, req_id: nextReqId() });
      };

      state.ws.onmessage = (ev) => {
        let data;
        try { data = JSON.parse(ev.data); } catch { return; }

        if (data.error) {
          log(`API ERROR: ${data.error.message}`);
          if (state.inRound) {
            state.inRound = false;
            state.liveContracts.clear();
          }
          return;
        }

        switch (data.msg_type) {
          case "authorize":
            log(`Authorized as ${data.authorize.loginid}`);
            uiStatus("Live", "Subscribed to ticks + balance");
            send({ ticks: state.symbol, subscribe: 1, req_id: nextReqId() });
            send({ balance: 1, subscribe: 1, req_id: nextReqId() });
            break;

          case "balance":
            state.lastBalance = Number(data.balance.balance);
            $("bal").textContent = `$${state.lastBalance.toFixed(2)}`;
            break;

          case "tick":
            onTick(data.tick);
            break;

          case "proposal":
            onProposal(data.proposal, data.req_id);
            break;

          case "buy":
            onBuy(data.buy, data.req_id);
            break;

          case "proposal_open_contract":
            onOpenContract(data.proposal_open_contract);
            break;

          default:
            break;
        }
      };

      state.ws.onerror = () => {
        log("WS error");
        setBadge("disconnected");
      };

      state.ws.onclose = () => {
        log("WS disconnected");
        setBadge("disconnected");
      };
    }

    function makeProposal(leg) {
      const reqId = nextReqId();
      leg.proposalReqId = reqId;
      pending.byProposalReqId.set(reqId, leg);

      send({
        proposal: 1,
        amount: leg.stake.toFixed(2),
        basis: "stake",
        contract_type: leg.contractType,
        currency: "USD",
        duration: 1,
        duration_unit: "t",
        symbol: state.symbol,
        barrier: leg.barrier,
        req_id: reqId,
      });
    }

    function onProposal(proposal, reqId) {
      const leg = pending.byProposalReqId.get(reqId);
      if (!leg) return;

      if (!proposal || !proposal.id) {
        log(`Proposal failed for ${leg.label}`);
        cancelRound("Proposal failed");
        return;
      }

      const buyReqId = nextReqId();
      leg.buyReqId = buyReqId;
      pending.byBuyReqId.set(buyReqId, leg);

      send({ buy: proposal.id, price: proposal.ask_price, req_id: buyReqId });
    }

    function onBuy(buy, reqId) {
      const leg = pending.byBuyReqId.get(reqId);
      if (!leg) return;

      if (!buy || !buy.contract_id) {
        log(`Buy failed for ${leg.label}`);
        cancelRound("Buy failed");
        return;
      }

      const cid = String(buy.contract_id);
      const buyPrice = Number(buy.buy_price ?? leg.stake ?? 0);

      state.liveContracts.add(cid);
      state.contracts.set(cid, { buyPrice, stake: leg.stake, label: leg.label, roundId: state.roundId });

      send({ proposal_open_contract: 1, contract_id: cid, subscribe: 1, req_id: nextReqId() });

      log(`BUY ${leg.label} contract=${cid} buy=$${buyPrice.toFixed(2)}`);
    }

    function onOpenContract(oc) {
      if (!oc || !oc.is_sold) return;

      const cid = String(oc.contract_id);
      const meta = state.contracts.get(cid);
      if (!meta) return;
      if (meta.roundId !== state.roundId) return;

      const buyPriceFromOC = Number(oc.buy_price ?? 0);
      const sellPrice = Number(oc.sell_price ?? 0);
      const buyPrice = buyPriceFromOC > 0 ? buyPriceFromOC : Number(meta.buyPrice ?? 0);

      let realized = 0;
      if (buyPrice > 0 && sellPrice > 0) realized = sellPrice - buyPrice;
      else if (typeof oc.profit !== "undefined") realized = Number(oc.profit) || 0;
      else realized = -Number(meta.stake ?? 0);

      state.roundProfit += realized;
      state.roundLegsSettled += 1;

      log(`SETTLE ${meta.label} contract=${cid} profit=$${realized.toFixed(2)} (round legs ${state.roundLegsSettled}/2)`);

      state.contracts.delete(cid);
      state.liveContracts.delete(cid);

      if (state.roundLegsSettled >= 2) finishRound();
    }

    function cancelRound(reason) {
      if (!state.inRound) return;
      log(`ROUND CANCEL: ${reason}`);

      // best effort: ignore old contracts; future settlements won't match current roundId once we increment.
      state.inRound = false;
      state.liveContracts.clear();
      pending.legs = [];
      pending.byProposalReqId.clear();
      pending.byBuyReqId.clear();

      uiStatus("Round cancelled", reason);
    }

    function finishRound() {
      const roundPnL = state.roundProfit;
      const roundWin = roundPnL > 0;

      state.pnl += roundPnL;
      state.rounds += 1;

      $("rounds").textContent = `${state.rounds}/${state.maxRounds}`;
      renderPnL();

      send({ balance: 1, req_id: nextReqId() });

      log(`ROUND #${state.rounds} DONE pnl=$${roundPnL.toFixed(2)} session=$${state.pnl.toFixed(2)}`);

      if (roundWin) {
        resetAfterRoundWin();
        uiStatus("Round WIN", `Round +$${roundPnL.toFixed(2)} | stake resets to $${state.stake.toFixed(2)}`);
      } else {
        applyAfterRoundLoss();
        uiStatus("Round LOSS", `Round $${roundPnL.toFixed(2)} | next stake/leg $${state.stake.toFixed(2)}`);
      }

      // reset round
      state.inRound = false;
      state.roundProfit = 0;
      state.roundLegsSettled = 0;
      pending.legs = [];
      pending.byProposalReqId.clear();
      pending.byBuyReqId.clear();

      // stops
      if (state.rounds >= state.maxRounds) return stop(`Max rounds reached (${state.maxRounds})`);
      if (state.stopMode === "firstRoundWin" && roundWin) return stop("Stopped on first round WIN");
      if (state.stopMode === "breakEven" && state.pnl >= 0) return stop("Stopped at break-even (PnL â‰¥ 0)");
      if (state.stopMode === "targetProfit" && state.pnl >= state.targetProfit) {
        return stop(`Target profit reached (+$${state.targetProfit.toFixed(2)})`);
      }
    }

    function startRound() {
      state.inRound = true;
      state.roundId += 1;
      state.roundProfit = 0;
      state.roundLegsSettled = 0;
      state.liveContracts.clear();
      pending.legs = [];
      pending.byProposalReqId.clear();
      pending.byBuyReqId.clear();

      const stake = state.stake;

      const legA = {
        label: "UNDER9",
        contractType: "DIGITUNDER",
        barrier: "9",
        stake,
        proposalReqId: null,
        buyReqId: null,
      };
      const legB = {
        label: "OVER0",
        contractType: "DIGITOVER",
        barrier: "0",
        stake,
        proposalReqId: null,
        buyReqId: null,
      };

      pending.legs.push(legA, legB);

      uiStatus("Placing dual tradesâ€¦", `Round stake/leg $${stake.toFixed(2)} (UNDER9 + OVER0)`);
      log(`ROUND START stake/leg=$${stake.toFixed(2)} => UNDER9 + OVER0`);

      makeProposal(legA);
      makeProposal(legB);
    }

    function onTick(tick) {
      if (!state.running) return;

      const d = lastDigit(tick.quote);
      if (d == null) return;

      $("tick").textContent = Number(tick.quote).toFixed(3);
      $("digit").textContent = `Digit: ${d}`;

      pushDigit(d);

      const zRate = computeZeroNineRate();
      $("zRate").textContent = state.digits.length ? zRate.toFixed(3) : "-";

      const gate = gateDecision();
      $("gate").textContent = gate.ok ? "TRADE" : "SKIP";
      $("gate").className = gate.ok ? "text-lg font-bold text-green-400 mono" : "text-lg font-bold text-red-400 mono";

      if (!gate.ok) {
        uiStatus("Waitingâ€¦", gate.reason);
        return;
      }

      if (state.rounds >= state.maxRounds) return stop(`Max rounds reached (${state.maxRounds})`);
      if (state.inRound) return;

      startRound();
    }

    // -----------------------
    // Start/Stop
    // -----------------------
    function start() {
      if (state.running) return;

      readInputs();

      state.token = ($("token").value || "").trim() || (localStorage.getItem("deriv_token") || "").trim();
      if (!state.token) {
        uiStatus("Missing token", "Paste token first");
        log("ERROR: token required");
        return;
      }

      state.rounds = 0;
      state.pnl = 0;
      state.step = 0;
      state.stake = state.baseStake;

      state.digits = [];

      state.inRound = false;
      state.roundId = 0;
      state.roundProfit = 0;
      state.roundLegsSettled = 0;
      state.liveContracts.clear();
      state.contracts.clear();
      pending.legs = [];
      pending.byProposalReqId.clear();
      pending.byBuyReqId.clear();

      $("rounds").textContent = `${state.rounds}/${state.maxRounds}`;
      renderPnL();
      $("zRate").textContent = "-";
      $("gate").textContent = "-";
      $("gate").className = "text-lg font-bold text-white mono";

      disableInputs(true);

      $("toggle").textContent = "STOP";
      $("toggle").classList.remove("bg-green-600","hover:bg-green-700");
      $("toggle").classList.add("bg-red-600","hover:bg-red-700");

      state.running = true;

      log(`START symbol=${state.symbol} window=${state.window} minTicks=${state.minTicks} zTh=${state.zThreshold} maxRounds=${state.maxRounds} stake/leg=$${state.baseStake.toFixed(2)}`);
      connect();
    }

    function stop(reason) {
      if (!state.running) return;

      state.running = false;
      disableInputs(false);

      $("toggle").textContent = "START";
      $("toggle").classList.remove("bg-red-600","hover:bg-red-700");
      $("toggle").classList.add("bg-green-600","hover:bg-green-700");

      uiStatus("Stopped", reason);
      log(`STOP: ${reason} | rounds=${state.rounds} pnl=$${state.pnl.toFixed(2)}`);

      try { if (state.ws) state.ws.close(); } catch {}
      state.ws = null;

      setBadge("disconnected");
    }

    // -----------------------
    // UI wiring
    // -----------------------
    $("saveToken").addEventListener("click", () => {
      const t = ($("token").value || "").trim();
      if (!t) return log("Token empty (not saved)");
      localStorage.setItem("deriv_token", t);
      state.token = t;
      log("Token saved locally");
    });

    $("clearToken").addEventListener("click", () => {
      localStorage.removeItem("deriv_token");
      $("token").value = "";
      state.token = "";
      log("Token cleared");
    });

    $("toggle").addEventListener("click", () => {
      if (state.running) stop("Manual stop");
      else start();
    });

    // Boot
    (function init() {
      const saved = (localStorage.getItem("deriv_token") || "").trim();
      if (saved) $("token").value = saved;

      readInputs();
      setBadge("disconnected");
      uiStatus("Ready", "Paste token â†’ Start");
      log("Bot initialized (dual trades: UNDER9 + OVER0 with 0/9 risk filter)");
    })();
  </script>
</body>
</html>
