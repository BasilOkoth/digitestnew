<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PROFESSIONAL | First Tick Martingale Bot v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* Enhanced Professional Styles */
        body { 
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .professional-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
            border: 1px solid rgba(56, 189, 248, 0.2);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .gradient-primary {
            background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 50%, #3b82f6 100%);
        }
        
        .gradient-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
        }
        
        .gradient-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%);
        }
        
        .gradient-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%);
        }
        
        .gradient-info {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #0369a1 100%);
        }
        
        /* Enhanced Win Glow Effect */
        @keyframes professional-win-glow {
            0% { 
                box-shadow: 0 0 10px #10B981, 
                           0 0 20px rgba(16, 185, 129, 0.5),
                           0 0 30px rgba(16, 185, 129, 0.3);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 40px #10B981, 
                           0 0 80px rgba(16, 185, 129, 0.8),
                           0 0 120px rgba(16, 185, 129, 0.5);
                transform: scale(1.02);
            }
            100% { 
                box-shadow: 0 0 10px #10B981, 
                           0 0 20px rgba(16, 185, 129, 0.5),
                           0 0 30px rgba(16, 185, 129, 0.3);
                transform: scale(1);
            }
        }
        
        .win-glow-effect {
            animation: professional-win-glow 1.5s infinite;
            border-color: #10B981 !important;
        }
        
        /* Digit Match Flash */
        @keyframes digit-match-flash {
            0% { background-color: #10B981; transform: scale(1); }
            50% { background-color: #34d399; transform: scale(1.2); }
            100% { background-color: #10B981; transform: scale(1); }
        }
        
        .digit-match-flash {
            animation: digit-match-flash 0.5s ease-out;
        }
        
        /* Pulse Animation for Trading */
        @keyframes trading-pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        .trading-pulse {
            animation: trading-pulse 2s infinite;
        }
        
        /* Professional Badge */
        .professional-badge {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Enhanced Stats Cards */
        .stat-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            border-color: rgba(56, 189, 248, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        /* Professional Inputs */
        .pro-input {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            transition: all 0.3s ease;
        }
        
        .pro-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            outline: none;
        }
        
        /* Enhanced Button */
        .pro-button {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            font-weight: 600;
            padding: 10px 24px;
            border-radius: 10px;
            border: none;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .pro-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }
        
        .pro-button:active {
            transform: translateY(0);
        }
        
        /* Professional Toggle */
        .pro-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .pro-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .pro-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #475569, #334155);
            border-radius: 34px;
            transition: .4s;
        }
        
        .pro-toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background: linear-gradient(135deg, #ffffff, #f1f5f9);
            border-radius: 50%;
            transition: .4s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        input:checked + .pro-toggle-slider {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        input:checked + .pro-toggle-slider:before {
            transform: translateX(30px);
        }
        
        /* Enhanced Progress Bar */
        .pro-progress {
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }
        
        .pro-progress-bar {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transition: width 0.3s ease;
        }
        
        /* Professional Table */
        .pro-table {
            background: rgba(15, 23, 42, 0.7);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .pro-table th {
            background: rgba(30, 41, 59, 0.9);
            color: #94a3b8;
            font-weight: 600;
            padding: 12px 16px;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }
        
        .pro-table td {
            padding: 12px 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* Enhanced Log Area */
        #log-area {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-family: 'JetBrains Mono', 'SF Mono', Monaco, monospace;
            font-size: 11px;
            line-height: 1.5;
        }
        
        /* Connection Status */
        .connection-badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 1px solid transparent;
        }
        
        .connection-connected {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
        }
        
        .connection-disconnected {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .connection-connecting {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-color: rgba(245, 158, 11, 0.3);
            animation: pulse-once 1s infinite;
        }
        
        /* Profit/Loss Colors */
        .profit-positive {
            color: #10b981;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
        }
        
        .profit-negative {
            color: #ef4444;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
        }
        
        /* Martingale Level Indicator */
        .martingale-level {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        /* Tick Digit Display */
        .tick-digit {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(135deg, #1e40af, #1d4ed8);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(30, 64, 175, 0.3);
        }
        
        /* Win Celebration */
        .win-celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 20px;
            background: linear-gradient(45deg, #10b981, #34d399, #a7f3d0);
            opacity: 0.8;
        }
        
        /* Collapsible calculator styles */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .collapsible-content.collapsed {
            max-height: 0;
        }
        
        .collapsible-content.expanded {
            max-height: 1000px;
        }
        
        .collapse-icon {
            transition: transform 0.3s ease;
        }
        
        .collapse-icon.rotated {
            transform: rotate(180deg);
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght300;400;500&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <!-- Win Celebration Overlay -->
    <div id="winCelebration" class="win-celebration"></div>

    <div class="w-full max-w-7xl">
        <!-- Header -->
        <div class="professional-card p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                        PRO TRADER v2.0
                    </h1>
                    <p class="text-gray-400 text-sm mt-1">First Tick Martingale System • Professional Grade</p>
                </div>
                
                <div class="flex flex-wrap items-center gap-3">
                    <div class="connection-badge connection-disconnected" id="status-badge">
                        <span class="w-2 h-2 rounded-full bg-white"></span>
                        DISCONNECTED
                    </div>
                    
                    <div class="professional-badge gradient-primary">
                        FIRST TICK
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <label class="flex items-center gap-2 text-sm text-gray-300">
                            <span>DEMO</span>
                            <label class="pro-toggle">
                                <input type="checkbox" id="accTypeToggle" onchange="switchAccount()">
                                <span class="pro-toggle-slider"></span>
                            </label>
                            <span>REAL</span>
                        </label>
                        
                        <button id="soundToggle" onclick="toggleSound()" 
                            class="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-gray-300 text-sm font-medium transition">
                            Sound
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: Control Panel -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Strategy Panel -->
                <div class="professional-card p-6">
                    <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        Trading Strategy
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="stat-card p-4">
                            <div class="text-gray-400 text-sm mb-1">Prediction Method</div>
                            <div class="text-lg font-bold text-white">First Tick Digit</div>
                            <div class="text-xs text-gray-400 mt-1">Uses first tick after start</div>
                        </div>
                        
                        <div class="stat-card p-4">
                            <div class="text-gray-400 text-sm mb-1">Martingale</div>
                            <div class="text-lg font-bold text-green-400">1.15x per Loss</div>
                            <div class="text-xs text-gray-400 mt-1">Increases stake after loss</div>
                        </div>
                        
                        <div class="stat-card p-4">
                            <div class="text-gray-400 text-sm mb-1">Payout</div>
                            <div class="text-lg font-bold text-yellow-400">9x on Win</div>
                            <div class="text-xs text-gray-400 mt-1">DIGITMATCH contract</div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-white">Quick Settings</h3>
                            <button onclick="applyQuickSettings('conservative')" class="text-xs px-3 py-1 rounded bg-gray-800 hover:bg-gray-700 text-gray-300">
                                Apply Conservative
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Base Stake</label>
                                <input type="number" id="baseStake" value="1.0" min="0.1" step="0.1" 
                                    class="w-full pro-input py-2 px-3">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Multiplier</label>
                                <input type="number" id="multiplier" value="1.15" min="1.0" step="0.01" 
                                    class="w-full pro-input py-2 px-3">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Max Trades</label>
                                <input type="number" id="maxTrades" value="15" min="1" max="50" 
                                    class="w-full pro-input py-2 px-3">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Symbol</label>
                                <select id="symbol" class="w-full pro-input py-2 px-3">
                                    <option value="R_10">V. 10 Index</option>
                                    <option value="R_100">V. 100 Index</option>
                                    <option value="R_25">V. 25 Index</option>
                                    <option value="R_50">V. 50 Index</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Start/Stop Button -->
                    <div class="mt-8">
                        <button id="toggleButton" onclick="toggleBot()" 
                            class="w-full pro-button text-lg py-4 rounded-xl gradient-success hover:shadow-xl transition-all duration-300">
                            START TRADING BOT
                        </button>
                    </div>
                </div>

                <!-- Live Trading Dashboard -->
                <div class="professional-card p-6">
                    <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        Live Trading Dashboard
                    </h2>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="stat-card p-4">
                            <div class="text-gray-400 text-sm mb-1">Current Tick</div>
                            <div id="metricLiveTick" class="text-2xl font-bold text-white">---</div>
                            <div id="metricLastDigit" class="text-sm text-gray-300">Digit: ?</div>
                        </div>
                        
                        <div class="stat-card p-4">
                            <div class="text-gray-400 text-sm mb-1">Predicted Digit</div>
                            <div id="metricPredictedDigit" class="text-3xl font-bold text-purple-400">?</div>
                            <div class="text-sm text-gray-300">From first tick</div>
                        </div>
                        
                        <div class="stat-card p-4">
                            <div class="text-gray-400 text-sm mb-1">Current Stake</div>
                            <div id="metricCurrentStake" class="text-2xl font-bold text-green-400">$0.00</div>
                            <div id="martingaleLevel" class="text-xs martingale-level mt-1">Level 0</div>
                        </div>
                        
                        <div class="stat-card p-4">
                            <div class="text-gray-400 text-sm mb-1">Trade Count</div>
                            <div id="metricTradeCount" class="text-2xl font-bold text-yellow-400">0</div>
                            <div class="text-sm text-gray-300">of <span id="maxTradesDisplay">15</span> max</div>
                        </div>
                    </div>
                    
                    <!-- Progress Bars -->
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm text-gray-300 mb-2">
                                <span>Trading Progress</span>
                                <span id="tradeProgressText">0/15</span>
                            </div>
                            <div class="pro-progress">
                                <div id="tradeProgressBar" class="pro-progress-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex justify-between text-sm text-gray-300 mb-2">
                                <span>PnL Update</span>
                                <span id="pnlTimer">--</span>
                            </div>
                            <div class="pro-progress">
                                <div id="pnlProgressBar" class="pro-progress-bar bg-gradient-to-r from-green-500 to-emerald-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Statistics & Info -->
            <div class="space-y-6">
                <!-- Profit & Loss -->
                <div class="professional-card p-6">
                    <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        Profit & Loss
                    </h2>
                    
                    <div class="text-center mb-6">
                        <div class="text-gray-400 text-sm mb-2">Net Profit/Loss</div>
                        <div id="metricTotalProfit" class="text-4xl font-bold profit-neutral">$0.00</div>
                        <div class="text-sm text-gray-400 mt-2" id="pnlBreakdown">
                            Investment: $0.00 • Payout: $0.00
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center p-3 rounded-lg bg-gray-800/50">
                            <div class="text-gray-400 text-sm">Starting Balance</div>
                            <div id="startingBalance" class="text-lg font-bold text-white">$---</div>
                        </div>
                        
                        <div class="text-center p-3 rounded-lg bg-gray-800/50">
                            <div class="text-gray-400 text-sm">Current Balance</div>
                            <div id="currentBalance" class="text-lg font-bold text-green-400">$---</div>
                        </div>
                    </div>
                </div>

                <!-- Martingale Calculator -->
                <div class="professional-card p-6" id="martingaleCalculator">
                    <div class="collapsible-header" onclick="toggleCalculator()">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            Martingale Calculator
                        </h2>
                        <svg id="collapseIcon" class="collapse-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    
                    <div id="calculatorContent" class="collapsible-content expanded space-y-4 mt-4">
                        <div>
                            <div class="text-sm text-gray-300 mb-2">Stake Progression (1.15x)</div>
                            <div class="pro-table">
                                <table class="w-full">
                                    <thead>
                                        <tr>
                                            <th class="text-left">Loss #</th>
                                            <th class="text-right">Stake</th>
                                            <th class="text-right">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="martingaleTable">
                                        <tr><td colspan="3" class="text-center text-gray-500 py-4">Enter stake to calculate</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="text-center p-4 rounded-lg bg-gradient-to-r from-blue-900/30 to-purple-900/30">
                            <div class="text-gray-300 text-sm mb-1">Payout on Win at Level 5</div>
                            <div id="payoutAtLevel5" class="text-2xl font-bold text-green-400">$0.00</div>
                            <div class="text-xs text-gray-400 mt-1">9x payout - total investment</div>
                        </div>
                    </div>
                </div>

                <!-- Bot Status -->
                <div class="professional-card p-6">
                    <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        Bot Status
                    </h2>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">First Tick Status:</span>
                            <span id="firstTickStatus" class="px-3 py-1 rounded-full bg-yellow-900/30 text-yellow-400 text-sm">Waiting</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Connection:</span>
                            <span id="connectionStatus" class="px-3 py-1 rounded-full bg-red-900/30 text-red-400 text-sm">Offline</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Ticks Received:</span>
                            <span id="ticksReceived" class="text-white font-medium">0</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Win Rate:</span>
                            <span id="winRate" class="text-green-400 font-medium">0%</span>
                        </div>
                        
                        <div class="mt-4 p-3 rounded-lg bg-gray-800/50">
                            <div class="text-sm text-gray-300 mb-1">Status Message</div>
                            <div id="statusMessage" class="text-white font-medium">Ready to start trading</div>
                            <div id="nextAction" class="text-xs text-gray-400 mt-1">Click START to begin</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trading Log -->
        <div class="professional-card p-6 mt-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    Trading Log
                </h2>
                <button onclick="clearLog()" class="text-sm px-3 py-1 rounded bg-gray-800 hover:bg-gray-700 text-gray-300">
                    Clear Log
                </button>
            </div>
            
            <div id="log-area" class="h-64 bg-gray-900/50 rounded-lg p-4 overflow-y-auto text-sm">
                <div class="text-gray-500 text-center py-8">
                    <div class="text-lg mb-2">Professional Trading Bot v2.0</div>
                    <div class="text-sm">First Tick Martingale System initialized</div>
                    <div class="text-xs mt-2">Ready to start trading with 1.15x martingale strategy</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // PROFESSIONAL FIRST TICK MARTINGALE BOT v2.0
        // ============================================================================
        
        // Global State
        window.ws = null;
        window.req_id = 0;
        window.isBotRunning = false;
        window.isConnecting = false;
        window.soundEnabled = true;
        window.ToneInitialized = false;
        window.synth = null;
        
        // FIRST TICK MODE STATE
        window.firstTickReceived = false;
        window.firstTickDigit = null;
        window.predictedDigit = null;
        window.waitingForFirstTick = true;
        
        // TRADING STATE WITH 1.15x MARTINGALE
        window.baseStake = 1.0;
        window.currentStake = 1.0;
        window.multiplier = 1.15;
        window.maxTrades = 15;
        window.tradeCount = 0;
        window.martingaleStep = 0;
        window.accountBalance = 0.0;
        window.startingBalance = 0.0;
        window.currentBalance = 0.0;
        window.netProfit = 0.0;
        window.totalInvestment = 0.0;
        window.totalPayout = 0.0;
        
        // WIN/LOSS STATISTICS
        window.stats = {
            wins: 0,
            losses: 0,
            totalTrades: 0,
            winRate: 0
        };
        
        // PnL UPDATE SYSTEM
        window.pnlUpdateInterval = null;
        window.pnlUpdateStartTime = 0;
        window.pnlUpdateDuration = 3000;
        window.pnlUpdateActive = false;
        
        // TRADING EXECUTION
        window.lastTick = null;
        window.nextTradeAllowed = true;
        window.stopAfterWin = false;
        window.pendingProposals = new Map();
        window.executionLock = false;
        
        // PERFORMANCE TRACKING
        window.totalTicksReceived = 0;
        window.tradeHistory = [];
        
        // CALCULATOR STATE
        window.calculatorCollapsed = false;
        
        // DOM ELEMENTS
        const toggleButton = document.getElementById('toggleButton');
        const statusBadge = document.getElementById('status-badge');
        const metricTotalProfit = document.getElementById('metricTotalProfit');
        const metricPredictedDigit = document.getElementById('metricPredictedDigit');
        const metricCurrentStake = document.getElementById('metricCurrentStake');
        const metricTradeCount = document.getElementById('metricTradeCount');
        const metricLiveTick = document.getElementById('metricLiveTick');
        const metricLastDigit = document.getElementById('metricLastDigit');
        const martingaleLevel = document.getElementById('martingaleLevel');
        const maxTradesDisplay = document.getElementById('maxTradesDisplay');
        const tradeProgressBar = document.getElementById('tradeProgressBar');
        const tradeProgressText = document.getElementById('tradeProgressText');
        const pnlProgressBar = document.getElementById('pnlProgressBar');
        const pnlTimer = document.getElementById('pnlTimer');
        const pnlBreakdown = document.getElementById('pnlBreakdown');
        const startingBalance = document.getElementById('startingBalance');
        const currentBalance = document.getElementById('currentBalance');
        const martingaleTable = document.getElementById('martingaleTable');
        const payoutAtLevel5 = document.getElementById('payoutAtLevel5');
        const firstTickStatus = document.getElementById('firstTickStatus');
        const connectionStatus = document.getElementById('connectionStatus');
        const ticksReceived = document.getElementById('ticksReceived');
        const winRate = document.getElementById('winRate');
        const statusMessage = document.getElementById('statusMessage');
        const nextAction = document.getElementById('nextAction');
        const calculatorContent = document.getElementById('calculatorContent');
        const collapseIcon = document.getElementById('collapseIcon');
        
        // ============================================================================
        // CALCULATOR MINIMIZE FUNCTION
        // ============================================================================
        
        function toggleCalculator() {
            window.calculatorCollapsed = !window.calculatorCollapsed;
            
            if (window.calculatorCollapsed) {
                calculatorContent.classList.remove('expanded');
                calculatorContent.classList.add('collapsed');
                collapseIcon.classList.add('rotated');
            } else {
                calculatorContent.classList.remove('collapsed');
                calculatorContent.classList.add('expanded');
                collapseIcon.classList.remove('rotated');
                calculateMartingaleTable();
            }
        }
        
        // ============================================================================
        // PROFESSIONAL WIN EFFECTS
        // ============================================================================
        
        function createWinCelebration() {
            const celebration = document.getElementById('winCelebration');
            celebration.innerHTML = '';
            celebration.style.opacity = '1';
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-20px';
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                confetti.style.animation = `fall ${Math.random() * 3 + 2}s linear forwards`;
                celebration.appendChild(confetti);
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fall {
                        0% { transform: translateY(0) rotate(0deg); opacity: 1; }
                        100% { transform: translateY(100vh) rotate(${Math.random() * 360}deg); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            setTimeout(() => {
                celebration.style.opacity = '0';
                setTimeout(() => celebration.innerHTML = '', 1000);
            }, 3000);
        }
        
        function playVictorySound() {
            if (!window.soundEnabled || !window.ToneInitialized) return;
            
            try {
                const now = Tone.now();
                window.synth.triggerAttackRelease("C5", "8n", now);
                window.synth.triggerAttackRelease("E5", "8n", now + 0.1);
                window.synth.triggerAttackRelease("G5", "8n", now + 0.2);
                window.synth.triggerAttackRelease("C6", "8n", now + 0.3);
                
                setTimeout(() => {
                    window.synth.triggerAttackRelease("G5", "4n");
                }, 500);
            } catch (e) {
                console.error("Audio error:", e);
            }
        }
        
        // ============================================================================
        // ENHANCED PnL UPDATE SYSTEM (COMPLETELY STOPS BOT AFTER WIN)
        // ============================================================================
        
        function startProfessionalPnLUpdate(payout) {
            // IMMEDIATELY STOP ALL TRADING
            window.stopAfterWin = true;
            window.nextTradeAllowed = false;
            window.executionLock = true;
            
            window.pnlUpdateActive = true;
            window.pnlUpdateStartTime = Date.now();
            
            if (window.pnlUpdateInterval) {
                clearInterval(window.pnlUpdateInterval);
            }
            
            updatePnL();
            
            window.pnlUpdateInterval = setInterval(() => {
                const elapsed = Date.now() - window.pnlUpdateStartTime;
                const remaining = Math.max(0, window.pnlUpdateDuration - elapsed);
                
                const progressPercent = 100 - (remaining / window.pnlUpdateDuration * 100);
                pnlProgressBar.style.width = `${progressPercent}%`;
                pnlTimer.textContent = `${(remaining / 1000).toFixed(1)}s`;
                
                updatePnL();
                
                if (elapsed % 500 < 50) {
                    metricTotalProfit.classList.add('digit-match-flash');
                    setTimeout(() => metricTotalProfit.classList.remove('digit-match-flash'), 500);
                }
                
                if (elapsed >= window.pnlUpdateDuration) {
                    clearInterval(window.pnlUpdateInterval);
                    window.pnlUpdateInterval = null;
                    window.pnlUpdateActive = false;
                    
                    updatePnL();
                    log('PnL update complete', 'PNL');
                    
                    // COMPLETELY STOP THE BOT AFTER WIN
                    setTimeout(() => {
                        stopBot();
                    }, 500);
                }
            }, 100);
        }
        
        function updatePnL() {
            const netProfit = window.totalPayout - window.totalInvestment;
            const formattedProfit = Math.abs(netProfit).toFixed(2);
            
            metricTotalProfit.textContent = `${netProfit >= 0 ? '+' : '-'}$${formattedProfit}`;
            
            metricTotalProfit.classList.remove('profit-positive', 'profit-negative', 'profit-neutral');
            if (netProfit > 0) {
                metricTotalProfit.classList.add('profit-positive');
                if (window.pnlUpdateActive) {
                    metricTotalProfit.parentElement.classList.add('win-glow-effect');
                }
            } else if (netProfit < 0) {
                metricTotalProfit.classList.add('profit-negative');
            } else {
                metricTotalProfit.classList.add('profit-neutral');
            }
            
            pnlBreakdown.textContent = `Investment: $${window.totalInvestment.toFixed(2)} • Payout: $${window.totalPayout.toFixed(2)}`;
            
            return netProfit;
        }
        
        function updateBalanceDisplay() {
            startingBalance.textContent = `$${window.startingBalance.toFixed(2)}`;
            currentBalance.textContent = `$${window.currentBalance.toFixed(2)}`;
        }
        
        // ============================================================================
        // MARTINGALE CALCULATOR
        // ============================================================================
        
        function calculateMartingaleTable() {
            const baseStake = parseFloat(document.getElementById('baseStake').value) || 1.0;
            const multiplier = parseFloat(document.getElementById('multiplier').value) || 1.15;
            const maxTrades = parseInt(document.getElementById('maxTrades').value) || 15;
            
            let html = '';
            let totalInvestment = 0;
            let currentStake = baseStake;
            
            for (let i = 0; i <= maxTrades; i++) {
                if (i === 0) {
                    currentStake = baseStake;
                } else {
                    currentStake *= multiplier;
                }
                
                totalInvestment += currentStake;
                
                const payout = currentStake * 9;
                const netProfit = payout - totalInvestment;
                
                html += `
                    <tr class="${i % 2 === 0 ? 'bg-gray-800/20' : ''}">
                        <td class="text-gray-300">${i}</td>
                        <td class="text-right font-medium ${i > 0 ? 'text-yellow-400' : 'text-white'}">$${currentStake.toFixed(2)}</td>
                        <td class="text-right font-medium ${netProfit >= 0 ? 'text-green-400' : 'text-red-400'}">$${totalInvestment.toFixed(2)}</td>
                    </tr>
                `;
                
                if (i === 5) {
                    payoutAtLevel5.textContent = `$${netProfit.toFixed(2)}`;
                }
            }
            
            martingaleTable.innerHTML = html;
        }
        
        // ============================================================================
        // PROFESSIONAL TRADING ENGINE
        // ============================================================================
        
        function resetTradingState() {
            window.firstTickReceived = false;
            window.firstTickDigit = null;
            window.predictedDigit = null;
            window.waitingForFirstTick = true;
            
            window.tradeCount = 0;
            window.martingaleStep = 0;
            window.totalInvestment = 0.0;
            window.totalPayout = 0.0;
            
            window.stats = { wins: 0, losses: 0, totalTrades: 0, winRate: 0 };
            window.tradeHistory = [];
            
            window.stopAfterWin = false;
            window.nextTradeAllowed = false;
            window.executionLock = false;
            
            metricPredictedDigit.textContent = '?';
            metricCurrentStake.textContent = '$0.00';
            metricTradeCount.textContent = '0';
            metricLiveTick.textContent = '---';
            metricLastDigit.textContent = 'Digit: ?';
            martingaleLevel.textContent = 'Level 0';
            tradeProgressBar.style.width = '0%';
            tradeProgressText.textContent = '0/15';
            firstTickStatus.textContent = 'Waiting';
            firstTickStatus.className = 'px-3 py-1 rounded-full bg-yellow-900/30 text-yellow-400 text-sm';
            
            updatePnL();
            updateBalanceDisplay();
            updateStatsDisplay();
        }
        
        function extractDigitFromTick(tick) {
            try {
                const price = parseFloat(tick.quote);
                const symbol = document.getElementById('symbol').value;
                let decimalPlaces = 3;
                if (symbol === 'R_100') decimalPlaces = 2;
                const formattedPrice = price.toFixed(decimalPlaces);
                const digit = formattedPrice.charAt(formattedPrice.length - 1);
                
                return {
                    digit: digit,
                    price: price,
                    formattedPrice: formattedPrice
                };
            } catch (error) {
                console.error('Error extracting digit:', error);
                return null;
            }
        }
        
        function processFirstTick(tick) {
            if (window.firstTickReceived || !window.waitingForFirstTick) {
                return;
            }
            
            // CHECK: If bot should stop after win, don't process ticks
            if (window.stopAfterWin || !window.isBotRunning) {
                return;
            }
            
            const tickData = extractDigitFromTick(tick);
            if (!tickData) return;
            
            window.firstTickReceived = true;
            window.waitingForFirstTick = false;
            window.firstTickDigit = tickData.digit;
            window.predictedDigit = tickData.digit;
            
            metricPredictedDigit.textContent = tickData.digit;
            metricPredictedDigit.classList.add('digit-match-flash');
            firstTickStatus.textContent = 'Ready';
            firstTickStatus.className = 'px-3 py-1 rounded-full bg-green-900/30 text-green-400 text-sm';
            
            log(`FIRST TICK DETECTED: ${tickData.formattedPrice}`, 'SYSTEM');
            log(`PREDICTION SET: Digit ${tickData.digit}`, 'SYSTEM');
            log(`MARTINGALE ACTIVE: 1.15x multiplier`, 'SYSTEM');
            
            updateStatus('READY', `Digit ${tickData.digit} locked`, 'Trading active');
            
            window.nextTradeAllowed = true;
        }
        
        // ============================================================================
        // ENHANCED TRADING LOGIC WITH 1.15x MARTINGALE
        // ============================================================================
        
        function checkForDigitMatch(tick, currentDigit) {
            // IMPORTANT: Check if bot should stop after win
            if (!window.isBotRunning || window.stopAfterWin) {
                return false;
            }
            
            if (currentDigit === window.predictedDigit) {
                log(`DIGIT MATCH! ${currentDigit} = ${window.predictedDigit}`, 'WIN');
                
                // CRITICAL: Set stop flags BEFORE anything else
                window.stopAfterWin = true;
                window.nextTradeAllowed = false;
                window.executionLock = true;
                
                window.stats.wins++;
                window.stats.totalTrades++;
                
                const payout = window.currentStake * 9;
                window.totalPayout += payout;
                
                playVictorySound();
                createWinCelebration();
                
                updateStatus('VICTORY!', 
                    `Digit ${currentDigit} matched! Payout: $${payout.toFixed(2)}`,
                    'Bot stopping after PnL update');
                
                // Start PnL update which will stop the bot
                startProfessionalPnLUpdate(payout);
                
                window.martingaleStep = 0;
                updateStakeDisplay();
                
                return true;
            }
            
            return false;
        }
        
        function executeTradeOnTick(tick) {
            // CRITICAL CHECKS: Prevent trading after win
            if (window.stopAfterWin || window.executionLock || !window.isBotRunning) {
                return;
            }
            
            if (window.tradeCount >= window.maxTrades) {
                log(`MAX TRADES REACHED (${window.maxTrades})`, 'WARNING');
                updateStatus('LIMIT REACHED', 'Maximum trades executed', 'Bot stopping');
                stopBot();
                return;
            }
            
            window.executionLock = true;
            
            try {
                window.tradeCount++;
                window.stats.totalTrades++;
                
                window.totalInvestment += window.currentStake;
                
                updateTradeProgress();
                updateStatsDisplay();
                
                log(`Trade #${window.tradeCount}: $${window.currentStake.toFixed(2)} on digit ${window.predictedDigit}`, 'TRADE');
                
                updateStatus('TRADING', 
                    `Trade ${window.tradeCount}: $${window.currentStake.toFixed(2)} stake`,
                    'Martingale Level: ' + window.martingaleStep);
                
                sendTradeRequest(tick);
                
            } catch (error) {
                log(`Trade error: ${error}`, 'ERROR');
                window.executionLock = false;
                window.nextTradeAllowed = true;
            }
        }
        
        function sendTradeRequest(tick) {
            // CHECK: Don't send trade if we should stop after win
            if (window.stopAfterWin) {
                log('Trade cancelled - win condition met', 'SYSTEM');
                handleTradeResult(false);
                return;
            }
            
            const contractType = "DIGITMATCH";
            const symbol = document.getElementById('symbol').value;
            
            const proposalRequest = {
                proposal: 1,
                amount: window.currentStake.toFixed(2),
                basis: "stake",
                contract_type: contractType,
                currency: "USD",
                duration: 1,
                duration_unit: "t",
                symbol: symbol,
                barrier: window.predictedDigit.toString(),
                req_id: getNextReqId()
            };
            
            window.pendingProposals.set(proposalRequest.req_id, {
                tick: tick,
                stake: window.currentStake,
                contractType: contractType,
                predictedDigit: window.predictedDigit,
                tradeNumber: window.tradeCount,
                martingaleStep: window.martingaleStep
            });
            
            sendRequest(proposalRequest);
        }
        
        function handleTradeResult(isWin) {
            window.executionLock = false;
            
            if (isWin) {
                // Win is already handled in checkForDigitMatch
                return;
            } else {
                // CHECK: Don't process losses if we should stop after win
                if (window.stopAfterWin) {
                    return;
                }
                
                window.stats.losses++;
                window.martingaleStep++;
                
                window.currentStake = window.baseStake * Math.pow(window.multiplier, window.martingaleStep);
                window.currentStake = parseFloat(window.currentStake.toFixed(2));
                
                log(`Loss #${window.martingaleStep}. Next stake: $${window.currentStake.toFixed(2)}`, 'MARTINGALE');
                
                updateStatus('MARTINGALE ACTIVE', 
                    `Loss streak: ${window.martingaleStep}`,
                    `Next stake: $${window.currentStake.toFixed(2)}`);
                
                updateStakeDisplay();
                updatePnL();
                
                window.nextTradeAllowed = true;
            }
        }
        
        // ============================================================================
        // UI UPDATE FUNCTIONS
        // ============================================================================
        
        function updateStatus(status, message, action) {
            statusMessage.textContent = message;
            nextAction.textContent = action;
            
            const statusContainer = statusMessage.parentElement.parentElement;
            statusContainer.classList.remove('bg-green-900/20', 'bg-blue-900/20', 'bg-yellow-900/20', 'bg-red-900/20');
            
            if (status.includes('VICTORY') || status.includes('WIN')) {
                statusContainer.classList.add('bg-green-900/20');
            } else if (status.includes('TRADING')) {
                statusContainer.classList.add('bg-blue-900/20');
            } else if (status.includes('MARTINGALE')) {
                statusContainer.classList.add('bg-yellow-900/20');
            } else if (status.includes('ERROR') || status.includes('LIMIT')) {
                statusContainer.classList.add('bg-red-900/20');
            }
        }
        
        function updateStakeDisplay() {
            metricCurrentStake.textContent = `$${window.currentStake.toFixed(2)}`;
            martingaleLevel.textContent = `Level ${window.martingaleStep}`;
            
            if (window.martingaleStep >= 5) {
                martingaleLevel.classList.remove('bg-blue-900/30', 'text-blue-400');
                martingaleLevel.classList.add('bg-yellow-900/30', 'text-yellow-400');
            } else if (window.martingaleStep >= 10) {
                martingaleLevel.classList.remove('bg-yellow-900/30', 'text-yellow-400');
                martingaleLevel.classList.add('bg-red-900/30', 'text-red-400');
            } else {
                martingaleLevel.classList.remove('bg-yellow-900/30', 'text-yellow-400', 'bg-red-900/30', 'text-red-400');
                martingaleLevel.classList.add('bg-blue-900/30', 'text-blue-400');
            }
        }
        
        function updateTradeProgress() {
            const progress = (window.tradeCount / window.maxTrades) * 100;
            tradeProgressBar.style.width = `${progress}%`;
            tradeProgressText.textContent = `${window.tradeCount}/${window.maxTrades}`;
            
            if (progress > 80) {
                tradeProgressBar.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-purple-500');
                tradeProgressBar.classList.add('bg-gradient-to-r', 'from-yellow-500', 'to-red-500');
            }
        }
        
        function updateStatsDisplay() {
            winRate.textContent = window.stats.totalTrades > 0 
                ? `${((window.stats.wins / window.stats.totalTrades) * 100).toFixed(1)}%`
                : '0%';
            ticksReceived.textContent = window.totalTicksReceived;
        }
        
        function updateConnectionDisplay(isConnected, isConnecting) {
            if (isConnected) {
                statusBadge.className = 'connection-badge connection-connected';
                statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-white"></span> CONNECTED';
                connectionStatus.textContent = 'Connected';
                connectionStatus.className = 'px-3 py-1 rounded-full bg-green-900/30 text-green-400 text-sm';
            } else if (isConnecting) {
                statusBadge.className = 'connection-badge connection-connecting';
                statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-white"></span> CONNECTING';
                connectionStatus.textContent = 'Connecting';
                connectionStatus.className = 'px-3 py-1 rounded-full bg-yellow-900/30 text-yellow-400 text-sm';
            } else {
                statusBadge.className = 'connection-badge connection-disconnected';
                statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-white"></span> DISCONNECTED';
                connectionStatus.textContent = 'Offline';
                connectionStatus.className = 'px-3 py-1 rounded-full bg-red-900/30 text-red-400 text-sm';
            }
        }
        
        // ============================================================================
        // WEBSOCKET & API HANDLING
        // ============================================================================
        
        function connectWebSocket() {
            if (window.ws) {
                try {
                    window.ws.close();
                } catch (e) {}
            }
            
            window.isConnecting = true;
            updateConnectionDisplay(false, true);
            
            const wsUrl = 'wss://ws.binaryws.com/websockets/v3?app_id=120389';
            log('Connecting to Deriv API...', 'SYSTEM');
            
            window.ws = new WebSocket(wsUrl);
            
            window.ws.onopen = () => {
                window.isConnecting = false;
                updateConnectionDisplay(true, false);
                log('WebSocket connected', 'SYSTEM');
                
                const token = localStorage.getItem('active_token') || localStorage.getItem('derivToken');
                if (!token) {
                    log('No API token found', 'ERROR');
                    stopBot();
                    return;
                }
                
                sendRequest({ 
                    authorize: token, 
                    req_id: getNextReqId() 
                });
            };
            
            window.ws.onmessage = (msg) => {
                try {
                    const data = JSON.parse(msg.data);
                    handleAPIResponse(data);
                } catch (e) {
                    console.error('WebSocket message error:', e);
                }
            };
            
            window.ws.onclose = () => {
                window.isConnecting = false;
                updateConnectionDisplay(false, false);
                log('Connection closed', 'SYSTEM');
                
                if (window.isBotRunning) {
                    updateStatus('DISCONNECTED', 'WebSocket connection lost', 'Attempting to reconnect...');
                    setTimeout(() => {
                        if (window.isBotRunning) {
                            connectWebSocket();
                        }
                    }, 3000);
                }
            };
            
            window.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                log('Connection error', 'ERROR');
            };
        }
        
        function handleTick(tick) {
            // CRITICAL: Don't process ticks if bot is not running or should stop after win
            if (!window.isBotRunning || window.stopAfterWin) {
                return;
            }
            
            window.totalTicksReceived++;
            updateStatsDisplay();
            
            const tickData = extractDigitFromTick(tick);
            if (!tickData) return;
            
            metricLiveTick.textContent = tickData.formattedPrice;
            metricLastDigit.textContent = `Digit: ${tickData.digit}`;
            
            metricLiveTick.classList.add('tick-flash');
            setTimeout(() => metricLiveTick.classList.remove('tick-flash'), 100);
            
            window.lastTick = tickData;
            
            if (window.waitingForFirstTick) {
                processFirstTick(tick);
                return;
            }
            
            if (window.predictedDigit && !window.stopAfterWin) {
                if (checkForDigitMatch(tick, tickData.digit)) {
                    return;
                }
            }
            
            // ADDED CHECK: Ensure we don't execute trades after win
            if (window.predictedDigit && window.nextTradeAllowed && !window.executionLock && !window.stopAfterWin) {
                executeTradeOnTick(tick);
            }
        }
        
        function handleAPIResponse(data) {
            if (data.error) {
                log(`API Error: ${data.error.message}`, 'ERROR');
                if (data.error.code === 'InvalidToken') {
                    log('Invalid token - please reauthenticate', 'CRITICAL');
                    stopBot();
                }
                return;
            }
            
            if (data.msg_type === 'authorize') {
                log(`Authorized as ${data.authorize.loginid}`, 'SYSTEM');
                subscribeToTicks(document.getElementById('symbol').value);
                subscribeToBalance();
            } else if (data.msg_type === 'tick') {
                handleTick(data.tick);
            } else if (data.msg_type === 'proposal') {
                handleProposalResponse(data);
            } else if (data.msg_type === 'buy') {
                handleBuyResponse(data);
            } else if (data.msg_type === 'balance') {
                handleBalanceUpdate(data);
            }
        }
        
        function handleProposalResponse(data) {
            const pending = window.pendingProposals.get(data.req_id);
            if (!pending) return;
            
            window.pendingProposals.delete(data.req_id);
            
            // CHECK: Don't process proposal if we should stop after win
            if (window.stopAfterWin) {
                log('Proposal cancelled - win condition met', 'SYSTEM');
                return;
            }
            
            if (data.proposal && data.proposal.id) {
                executeBuy(data.proposal.id, data.proposal.ask_price, pending);
            } else {
                log('Proposal failed', 'ERROR');
                handleTradeResult(false);
            }
        }
        
        function executeBuy(proposal_id, ask_price, pending) {
            // CHECK: Don't execute buy if we should stop after win
            if (window.stopAfterWin) {
                log('Buy cancelled - win condition met', 'SYSTEM');
                handleTradeResult(false);
                return;
            }
            
            const buyRequest = {
                buy: proposal_id,
                price: ask_price,
                req_id: getNextReqId()
            };
            
            window.pendingProposals.set(buyRequest.req_id, pending);
            sendRequest(buyRequest);
        }
        
        function handleBuyResponse(data) {
            if (data.buy && data.buy.contract_id) {
                const wasWin = data.buy.longcode && data.buy.longcode.includes("win");
                handleTradeResult(wasWin);
            } else {
                log('Buy failed', 'ERROR');
                handleTradeResult(false);
            }
        }
        
        function handleBalanceUpdate(data) {
            const newBalance = parseFloat(data.balance.balance);
            
            if (window.startingBalance === 0) {
                window.startingBalance = newBalance;
            }
            
            window.currentBalance = newBalance;
            updateBalanceDisplay();
            updatePnL();
        }
        
        function subscribeToTicks(symbol) {
            sendRequest({ ticks: symbol, subscribe: 1, req_id: getNextReqId() });
            log(`Subscribed to ${symbol} ticks`, 'SYSTEM');
            updateStatus('CONNECTED', 'Market data streaming', 'Waiting for first tick...');
        }
        
        function subscribeToBalance() {
            sendRequest({ balance: 1, subscribe: 1, req_id: getNextReqId() });
        }
        
        // ============================================================================
        // BOT CONTROL FUNCTIONS
        // ============================================================================
        
        function startBot() {
            if (window.isBotRunning) {
                stopBot();
                return;
            }
            
            window.baseStake = parseFloat(document.getElementById('baseStake').value) || 1.0;
            window.multiplier = parseFloat(document.getElementById('multiplier').value) || 1.15;
            window.maxTrades = parseInt(document.getElementById('maxTrades').value) || 15;
            maxTradesDisplay.textContent = window.maxTrades;
            
            const token = localStorage.getItem('active_token') || localStorage.getItem('derivToken');
            if (!token) {
                log('Please authenticate first', 'ERROR');
                updateStatus('AUTH REQUIRED', 'No API token found', 'Please authenticate');
                return;
            }
            
            resetTradingState();
            window.isBotRunning = true;
            window.stopAfterWin = false; // Ensure this is false when starting
            
            toggleButton.innerHTML = 'STOP TRADING';
            toggleButton.classList.remove('gradient-success');
            toggleButton.classList.add('gradient-danger');
            
            log('PROFESSIONAL TRADING BOT STARTED', 'SYSTEM');
            log(`Settings: $${window.baseStake} base • ${window.multiplier}x martingale • ${window.maxTrades} max trades`, 'SYSTEM');
            
            updateStatus('INITIALIZING', 'Starting trading session', 'Connecting to market...');
            
            calculateMartingaleTable();
            initTone();
            connectWebSocket();
        }
        
        function stopBot() {
            if (!window.isBotRunning) return;
            
            window.isBotRunning = false;
            window.nextTradeAllowed = false;
            window.stopAfterWin = true; // Ensure this is true when stopping
            window.executionLock = false;
            
            toggleButton.innerHTML = 'START TRADING BOT';
            toggleButton.classList.remove('gradient-danger');
            toggleButton.classList.add('gradient-success');
            
            if (window.ws) {
                window.ws.close();
                window.ws = null;
            }
            
            window.pendingProposals.clear();
            
            if (window.pnlUpdateInterval) {
                clearInterval(window.pnlUpdateInterval);
                window.pnlUpdateInterval = null;
            }
            
            const finalPnL = window.totalPayout - window.totalInvestment;
            log(`SESSION COMPLETE: PnL = $${finalPnL.toFixed(2)}`, 'SYSTEM');
            log(`Stats: ${window.stats.wins} wins • ${window.stats.losses} losses • ${window.stats.totalTrades} total trades`, 'SYSTEM');
            
            updateStatus('BOT STOPPED', 
                `Final PnL: $${finalPnL.toFixed(2)}`, 
                'Click START to begin new session');
        }
        
        function toggleBot() {
            if (window.isBotRunning) {
                stopBot();
            } else {
                startBot();
            }
        }
        
        // ============================================================================
        // HELPER FUNCTIONS
        // ============================================================================
        
        function sendRequest(request) {
            if (window.ws && window.ws.readyState === WebSocket.OPEN) {
                const message = JSON.stringify(request);
                window.ws.send(message);
                return request.req_id;
            }
            return null;
        }
        
        function getNextReqId() {
            return ++window.req_id;
        }
        
        function log(message, type = 'INFO') {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            let color = 'text-gray-400';
            if (type === 'ERROR') color = 'text-red-400'; 
            if (type === 'WARNING') color = 'text-yellow-400';
            if (type === 'TRADE') color = 'text-blue-400';
            if (type === 'WIN') color = 'text-green-400 font-bold';
            if (type === 'MARTINGALE') color = 'text-purple-400';
            if (type === 'SYSTEM') color = 'text-cyan-400';
            if (type === 'PNL') color = 'text-emerald-400';
            
            const entry = document.createElement('div');
            entry.className = 'mb-1';
            entry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> <span class="${color}">${message}</span>`;
            
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function clearLog() {
            const logArea = document.getElementById('log-area');
            logArea.innerHTML = '<div class="text-gray-500 text-center py-8">Log cleared</div>';
        }
        
        function toggleSound() {
            window.soundEnabled = !window.soundEnabled;
            const button = document.getElementById('soundToggle');
            button.textContent = window.soundEnabled ? 'Sound' : 'Muted';
            log(`Sound ${window.soundEnabled ? 'enabled' : 'disabled'}`, 'SYSTEM');
        }
        
        async function initTone() {
            if (!window.soundEnabled) return;
            
            try {
                await Tone.start();
                window.synth = new Tone.Synth().toDestination();
                window.ToneInitialized = true;
            } catch (e) {
                console.error("Audio init error:", e);
            }
        }
        
        function applyQuickSettings(type) {
            if (type === 'conservative') {
                document.getElementById('baseStake').value = '0.5';
                document.getElementById('multiplier').value = '1.15';
                document.getElementById('maxTrades').value = '10';
                calculateMartingaleTable();
                log('Applied conservative settings', 'SYSTEM');
            }
        }
        
        function switchAccount() {
            const isReal = document.getElementById('accTypeToggle').checked;
            log(`Switched to ${isReal ? 'REAL' : 'DEMO'} account mode`, 'SYSTEM');
        }
        
        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Professional Trading Bot v2.0 initialized');
            
            document.getElementById('baseStake').value = '1.0';
            document.getElementById('multiplier').value = '1.15';
            document.getElementById('maxTrades').value = '15';
            maxTradesDisplay.textContent = '15';
            
            calculateMartingaleTable();
            
            document.getElementById('baseStake').addEventListener('input', calculateMartingaleTable);
            document.getElementById('multiplier').addEventListener('input', calculateMartingaleTable);
            document.getElementById('maxTrades').addEventListener('input', function() {
                maxTradesDisplay.textContent = this.value;
                calculateMartingaleTable();
            });
            
            initTone();
            
            log('Professional Trading Bot v2.0 ready', 'SYSTEM');
            log('First Tick Martingale System with 1.15x multiplier', 'SYSTEM');
            log('Ready for professional trading', 'SYSTEM');
        });
    </script>
</body>
</html>
