<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deriv DIGITDIFF Bot (Volatility + Cluster AI + Real PnL)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#111827; }
    #log::-webkit-scrollbar{ width:4px; }
    #log::-webkit-scrollbar-thumb{ background:#4ade80; border-radius:2px; }
    #log::-webkit-scrollbar-track{ background:#374151; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .badge-ok { background: linear-gradient(90deg, #10b981, #059669) !important; }
    .badge-bad { background: linear-gradient(90deg, #dc2626, #b91c1c) !important; }
    .badge-warn { background: linear-gradient(90deg, #f59e0b, #d97706) !important; }
  </style>
</head>

<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">
  <div class="w-full max-w-6xl bg-gray-800 text-gray-100 shadow-2xl rounded-xl p-5 md:p-6 space-y-5">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl sm:text-3xl font-extrabold text-blue-400">
        ðŸŽ² Deriv DIGITDIFF Bot (Balanced AI)
        <span id="badge" class="ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full badge-bad text-white shadow-md">
          DISCONNECTED
        </span>
      </h1>
    </div>

    <!-- TOKEN -->
    <div class="bg-gray-900 border border-gray-700 rounded-xl p-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
        <div class="md:col-span-2">
          <label class="block text-xs font-semibold text-gray-300 mb-1">Deriv API Token</label>
          <input id="token" type="password" placeholder="Paste token..."
                 class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-3 py-2 text-sm" />
          <div class="text-[11px] text-gray-400 mt-1">Stored locally only if you click Save.</div>
        </div>
        <div class="flex gap-2">
          <button id="saveToken" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold">Save</button>
          <button id="clearToken" class="w-full px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg font-bold">Clear</button>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- LEFT: METRICS -->
      <div class="bg-gray-900 border border-gray-700 rounded-xl p-4 space-y-3">
        <div class="grid grid-cols-2 gap-2 text-xs">
          <div class="p-2 bg-gray-800 rounded border border-gray-700">
            <div class="text-gray-400">Symbol</div>
            <div id="symLabel" class="font-bold text-cyan-300">R_100</div>
          </div>
          <div class="p-2 bg-gray-800 rounded border border-gray-700">
            <div class="text-gray-400">Balance</div>
            <div id="bal" class="font-bold text-green-400">$---</div>
          </div>
          <div class="p-2 bg-gray-800 rounded border border-gray-700">
            <div class="text-gray-400">Trades</div>
            <div id="trades" class="font-bold text-yellow-300">0/0</div>
          </div>
          <div class="p-2 bg-gray-800 rounded border border-gray-700">
            <div class="text-gray-400">Session P/L</div>
            <div id="pnl" class="font-bold text-white">$0.00</div>
          </div>
        </div>

        <div class="p-3 bg-gray-800 rounded border border-gray-700">
          <div class="text-xs text-gray-400">Last Tick</div>
          <div id="tick" class="text-lg font-bold text-white mono">---</div>
          <div id="digit" class="text-xs text-green-300">Digit: ?</div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div class="p-3 bg-gray-800 rounded border border-gray-700 text-center">
            <div class="text-xs text-gray-400">Volatility</div>
            <div id="vol" class="text-lg font-bold text-white mono">-</div>
            <div id="volNote" class="text-[11px] text-gray-400">needs â‰¥ 10 ticks</div>
          </div>
          <div class="p-3 bg-gray-800 rounded border border-gray-700 text-center">
            <div class="text-xs text-gray-400">Cluster</div>
            <div id="cluster" class="text-lg font-bold text-white mono">-</div>
            <div class="text-[11px] text-gray-400">last 20 ticks</div>
          </div>
        </div>

        <div class="p-3 bg-gray-800 rounded border border-gray-700">
          <div class="text-xs text-gray-400">AI Barrier (DIGITDIFF)</div>
          <div id="barrier" class="text-2xl font-bold text-orange-300 mono">-</div>
          <div id="mode" class="text-[11px] text-gray-400 mt-1">Mode: -</div>
        </div>

        <div class="p-3 bg-gray-800 rounded border border-gray-700">
          <div class="text-xs text-gray-400">Status</div>
          <div id="status" class="text-sm font-bold text-gray-200">Ready</div>
          <div id="status2" class="text-xs text-gray-400">Paste token â†’ Start</div>
        </div>
      </div>

      <!-- RIGHT: CONTROLS + LOGS -->
      <div class="lg:col-span-2 bg-gray-900 border border-gray-700 rounded-xl p-4 space-y-3">
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">Symbol</label>
            <select id="symbol" class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-2 text-sm">
              <option value="R_10">V. 10 Index</option>
              <option value="R_25">V. 25 Index</option>
              <option value="R_50">V. 50 Index</option>
              <option value="R_75">V. 75 Index</option>
              <option value="R_100" selected>V. 100 Index</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">Rolling Window</label>
            <input id="window" type="number" min="10" max="500" value="100"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-2 text-sm" />
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">Min Ticks</label>
            <input id="minTicks" type="number" min="1" max="500" value="20"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-2 text-sm" />
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">Vol Threshold</label>
            <input id="volTh" type="number" min="0" step="0.1" value="4.5"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-2 text-sm" />
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">Base Stake ($)</label>
            <input id="baseStake" type="number" min="0.35" step="0.01" value="1.00"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-2 text-sm" />
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">Multiplier</label>
            <input id="mult" type="number" min="1.0" step="0.1" value="1.5"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-2 text-sm" />
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">Max Steps</label>
            <input id="steps" type="number" min="0" max="20" value="3"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-2 text-sm" />
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">Max Trades</label>
            <input id="maxTrades" type="number" min="1" max="500" value="10"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-2 text-sm" />
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">Stop Mode</label>
            <select id="stopMode" class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-2 text-sm">
              <option value="firstWin" selected>Stop on first WIN</option>
              <option value="breakEven">Stop at break-even (PnL â‰¥ 0)</option>
              <option value="targetProfit">Stop at target profit</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">Target Profit ($)</label>
            <input id="targetProfit" type="number" min="0" step="0.01" value="1.00"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-2 text-sm" />
          </div>
        </div>

        <div class="flex justify-center pt-2">
          <button id="toggle"
                  class="w-full md:w-2/3 px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-extrabold text-lg">
            START
          </button>
        </div>

        <div>
          <h2 class="text-sm font-bold text-gray-300 mb-2 border-b border-gray-700 pb-1">Logs</h2>
          <div id="log" class="h-80 bg-gray-950 border border-gray-800 rounded-lg p-3 text-xs text-lime-300 overflow-y-scroll whitespace-pre-wrap"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================================
    // Pseudocode plan
    // 1) Read inputs + token, reset session.
    // 2) WS connect â†’ authorize(token).
    // 3) Subscribe ticks(symbol) + balance.
    // 4) Maintain rolling last-digit list.
    // 5) AI:
    //    - calculateVolatility() from digits diffs
    //    - detectExtremeCluster() (>=6 highs 8-9, or >=6 lows 0-1 in last 20)
    //    - decideDiffBarrier():
    //       - if not enough ticks â†’ null
    //       - if volatility > threshold â†’ null
    //       - if extreme cluster â†’ barrier = most frequent digit in last 20 (hot digit)
    //       - else â†’ barrier = most frequent digit in rolling window
    // 6) Trading loop (one at a time):
    //    proposal(DIGITDIFF, barrier, stake, 1 tick) â†’ buy â†’ subscribe open_contract until is_sold
    //    realizedProfit = sell_price - buy_price (fallback oc.profit)
    //    martingale on loss, reset on win
    //    apply stop rules (firstWin / breakEven / targetProfit) + maxTrades.
    // ============================================================

    const $ = (id) => document.getElementById(id);
    const logBox = $("log");

    const state = {
      ws: null,
      reqId: 0,
      running: false,

      token: "",
      symbol: "R_100",

      window: 100,
      minTicks: 20,
      volThreshold: 4.5,

      baseStake: 1.0,
      mult: 1.5,
      maxSteps: 3,
      step: 0,
      stake: 1.0,

      maxTrades: 10,
      trades: 0,

      stopMode: "firstWin",
      targetProfit: 1.0,

      digits: [],
      inContract: false,
      liveContractId: null,

      lastBalance: null,
      pnl: 0,

      contracts: new Map(), // contract_id -> { buyPrice, barrier, stake }
    };

    const pending = {
      proposalReqId: null,
      buyReqId: null,
      barrier: null,
      stake: null,
    };

    function ts() {
      return new Date().toLocaleTimeString("en-US", { hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit" });
    }

    function log(msg) {
      logBox.textContent += `[${ts()}] ${msg}\n`;
      logBox.scrollTop = logBox.scrollHeight;
    }

    function setBadge(status) {
      const b = $("badge");
      if (status === "connected") {
        b.textContent = "CONNECTED";
        b.className = "ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full badge-ok text-white shadow-md";
      } else if (status === "connecting") {
        b.textContent = "CONNECTING";
        b.className = "ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full badge-warn text-white shadow-md";
      } else {
        b.textContent = "DISCONNECTED";
        b.className = "ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full badge-bad text-white shadow-md";
      }
    }

    function uiStatus(main, sub) {
      $("status").textContent = main;
      $("status2").textContent = sub || "";
    }

    function clampInt(v, min, max, fallback) {
      const n = parseInt(v, 10);
      if (!Number.isFinite(n)) return fallback;
      return Math.max(min, Math.min(max, n));
    }
    function clampNum(v, min, max, fallback) {
      const n = parseFloat(v);
      if (!Number.isFinite(n)) return fallback;
      return Math.max(min, Math.min(max, n));
    }
    function round2(n) { return Math.round(n * 100) / 100; }

    function disableInputs(disabled) {
      ["token","symbol","window","minTicks","volTh","baseStake","mult","steps","maxTrades","stopMode","targetProfit","saveToken","clearToken"].forEach(id => {
        $(id).disabled = disabled;
        $(id).classList.toggle("opacity-60", disabled);
      });
    }

    function readInputs() {
      state.symbol = $("symbol").value;
      state.window = clampInt($("window").value, 10, 500, 100);
      state.minTicks = clampInt($("minTicks").value, 1, 500, 20);
      state.volThreshold = clampNum($("volTh").value, 0, 100, 4.5);

      state.baseStake = clampNum($("baseStake").value, 0.35, 100000, 1.0);
      state.mult = clampNum($("mult").value, 1.0, 10.0, 1.5);
      state.maxSteps = clampInt($("steps").value, 0, 20, 3);

      state.maxTrades = clampInt($("maxTrades").value, 1, 500, 10);
      state.stopMode = $("stopMode").value;
      state.targetProfit = clampNum($("targetProfit").value, 0, 100000, 1.0);

      state.stake = state.baseStake;

      $("symLabel").textContent = state.symbol;
      $("trades").textContent = `${state.trades}/${state.maxTrades}`;
      renderPnL();
    }

    function renderPnL() {
      $("pnl").textContent = `$${state.pnl.toFixed(2)}`;
      $("pnl").className = state.pnl >= 0 ? "font-bold text-green-400" : "font-bold text-red-400";
    }

    function nextReqId() { state.reqId += 1; return state.reqId; }
    function send(msg) {
      if (!state.ws || state.ws.readyState !== WebSocket.OPEN) return;
      state.ws.send(JSON.stringify(msg));
    }

    function lastDigit(quote) {
      const s = String(quote);
      const d = parseInt(s[s.length - 1], 10);
      return Number.isFinite(d) ? d : null;
    }

    function resetWindow() {
      state.digits = [];
      $("barrier").textContent = "-";
      $("vol").textContent = "-";
      $("cluster").textContent = "-";
      $("mode").textContent = "Mode: -";
    }

    function pushDigit(d) {
      state.digits.push(d);
      while (state.digits.length > state.window) state.digits.shift();
    }

    // =========================
    // Volatility + Cluster AI
    // =========================
    function calculateVolatility() {
      if (state.digits.length < 10) return 0;
      let sum = 0;
      for (let i = 1; i < state.digits.length; i++) {
        sum += Math.abs(state.digits[i] - state.digits[i - 1]);
      }
      return sum / state.digits.length;
    }

    function detectExtremeCluster() {
      if (state.digits.length < 20) return null;
      const recent = state.digits.slice(-20);
      const high = recent.filter(d => d >= 8).length;
      const low = recent.filter(d => d <= 1).length;
      if (high >= 6) return "HIGH";
      if (low >= 6) return "LOW";
      return null;
    }

    function mostFrequentDigit(arr) {
      const counts = Array(10).fill(0);
      for (const d of arr) counts[d] += 1;

      let best = 0;
      for (let i = 1; i < 10; i++) if (counts[i] > counts[best]) best = i;

      const max = counts[best];
      const ties = [];
      for (let i = 0; i < 10; i++) if (counts[i] === max) ties.push(i);

      return ties[Math.floor(Math.random() * ties.length)];
    }

    function decideDiffBarrier() {
      if (state.digits.length < state.minTicks) return { barrier: null, mode: "COLLECT" };

      const vol = calculateVolatility();
      const extreme = detectExtremeCluster();

      if (vol > state.volThreshold) return { barrier: null, mode: "SKIP_VOL" };

      if (extreme) {
        const recent = state.digits.slice(-20);
        return { barrier: mostFrequentDigit(recent), mode: `STRIKE_${extreme}` };
      }

      const window = state.digits.slice(-Math.min(state.window, state.digits.length));
      return { barrier: mostFrequentDigit(window), mode: "STABLE" };
    }

    // =========================
    // Martingale
    // =========================
    function applyAfterLoss() {
      state.step += 1;
      if (state.step > state.maxSteps) {
        state.step = 0;
        state.stake = state.baseStake;
        return;
      }
      state.stake = round2(state.baseStake * Math.pow(state.mult, state.step));
    }

    function resetAfterWin() {
      state.step = 0;
      state.stake = state.baseStake;
    }

    // =========================
    // WS connect + trade lifecycle
    // =========================
    function connect() {
      if (state.ws) { try { state.ws.close(); } catch {} }

      setBadge("connecting");
      uiStatus("Connectingâ€¦", "Authorizingâ€¦");

      state.ws = new WebSocket("wss://ws.binaryws.com/websockets/v3?app_id=120389");

      state.ws.onopen = () => {
        setBadge("connected");
        log("WS connected");
        if (!state.token) {
          log("ERROR: missing token");
          stop("Missing token");
          return;
        }
        send({ authorize: state.token, req_id: nextReqId() });
      };

      state.ws.onmessage = (ev) => {
        let data;
        try { data = JSON.parse(ev.data); } catch { return; }

        if (data.error) {
          log(`API ERROR: ${data.error.message}`);
          state.inContract = false;
          state.liveContractId = null;
          return;
        }

        switch (data.msg_type) {
          case "authorize":
            log(`Authorized as ${data.authorize.loginid}`);
            uiStatus("Live", "Subscribed to ticks + balance");
            send({ ticks: state.symbol, subscribe: 1, req_id: nextReqId() });
            send({ balance: 1, subscribe: 1, req_id: nextReqId() });
            break;

          case "balance":
            state.lastBalance = Number(data.balance.balance);
            $("bal").textContent = `$${state.lastBalance.toFixed(2)}`;
            break;

          case "tick":
            onTick(data.tick);
            break;

          case "proposal":
            onProposal(data.proposal, data.req_id);
            break;

          case "buy":
            onBuy(data.buy, data.req_id);
            break;

          case "proposal_open_contract":
            onOpenContract(data.proposal_open_contract);
            break;

          default:
            break;
        }
      };

      state.ws.onerror = () => {
        log("WS error");
        setBadge("disconnected");
      };

      state.ws.onclose = () => {
        log("WS disconnected");
        setBadge("disconnected");
      };
    }

    function makeProposalDigitDiff(barrierDigit, stake) {
      const reqId = nextReqId();
      pending.proposalReqId = reqId;
      pending.barrier = barrierDigit;
      pending.stake = stake;

      send({
        proposal: 1,
        amount: stake.toFixed(2),
        basis: "stake",
        contract_type: "DIGITDIFF",
        currency: "USD",
        duration: 1,
        duration_unit: "t",
        symbol: state.symbol,
        barrier: String(barrierDigit),
        req_id: reqId
      });
    }

    function onProposal(proposal, reqId) {
      if (reqId !== pending.proposalReqId) return;
      if (!proposal || !proposal.id) {
        log("Proposal failed (no id)");
        state.inContract = false;
        return;
      }
      const buyReqId = nextReqId();
      pending.buyReqId = buyReqId;
      send({ buy: proposal.id, price: proposal.ask_price, req_id: buyReqId });
    }

    function onBuy(buy, reqId) {
      if (reqId !== pending.buyReqId) return;
      if (!buy || !buy.contract_id) {
        log("Buy failed (no contract_id)");
        state.inContract = false;
        return;
      }

      state.liveContractId = buy.contract_id;

      const buyPrice = Number(buy.buy_price ?? pending.stake ?? 0);
      state.contracts.set(String(state.liveContractId), {
        buyPrice,
        barrier: pending.barrier,
        stake: pending.stake
      });

      send({
        proposal_open_contract: 1,
        contract_id: state.liveContractId,
        subscribe: 1,
        req_id: nextReqId()
      });

      uiStatus("In contract", `Bought ${state.liveContractId} (DIFFERS ${pending.barrier})`);
      log(`BUY contract=${state.liveContractId} barrier=${pending.barrier} buy=$${buyPrice.toFixed(2)}`);
    }

    function onOpenContract(oc) {
      if (!oc) return;
      if (String(oc.contract_id) !== String(state.liveContractId)) return;
      if (!oc.is_sold) return;

      const cid = String(oc.contract_id);
      const cached = state.contracts.get(cid);

      const buyPriceFromOC = Number(oc.buy_price ?? 0);
      const sellPrice = Number(oc.sell_price ?? 0);
      const buyPrice = buyPriceFromOC > 0 ? buyPriceFromOC : Number(cached?.buyPrice ?? 0);

      let realized = 0;
      if (buyPrice > 0 && sellPrice > 0) realized = sellPrice - buyPrice;
      else if (typeof oc.profit !== "undefined") realized = Number(oc.profit) || 0;
      else realized = -Number(cached?.stake ?? 0);

      const isWin = realized > 0;

      state.trades += 1;
      state.pnl += realized;

      send({ balance: 1, req_id: nextReqId() });

      $("trades").textContent = `${state.trades}/${state.maxTrades}`;
      renderPnL();

      log(`SETTLE contract=${cid} buy=$${buyPrice.toFixed(2)} sell=$${sellPrice.toFixed(2)} pnl=$${realized.toFixed(2)} (session=$${state.pnl.toFixed(2)})`);

      if (isWin) {
        resetAfterWin();
        uiStatus("WIN", `+$${realized.toFixed(2)} | session $${state.pnl.toFixed(2)}`);
      } else {
        applyAfterLoss();
        uiStatus("LOSS", `${realized.toFixed(2)} | next stake $${state.stake.toFixed(2)}`);
      }

      state.contracts.delete(cid);
      state.inContract = false;
      state.liveContractId = null;

      if (state.trades >= state.maxTrades) return stop(`Max trades reached (${state.maxTrades})`);
      if (state.stopMode === "firstWin" && isWin) return stop("Stopped on first WIN");
      if (state.stopMode === "breakEven" && state.pnl >= 0) return stop("Stopped at break-even (PnL â‰¥ 0)");
      if (state.stopMode === "targetProfit" && state.pnl >= state.targetProfit) {
        return stop(`Target profit reached (+$${state.targetProfit.toFixed(2)})`);
      }
    }

    function onTick(tick) {
      if (!state.running) return;

      const d = lastDigit(tick.quote);
      if (d == null) return;

      pushDigit(d);

      $("tick").textContent = Number(tick.quote).toFixed(3);
      $("digit").textContent = `Digit: ${d}`;

      const vol = calculateVolatility();
      const cluster = detectExtremeCluster();

      $("vol").textContent = state.digits.length >= 10 ? vol.toFixed(2) : "-";
      $("cluster").textContent = cluster ?? "-";

      const decision = decideDiffBarrier();
      $("barrier").textContent = decision.barrier == null ? "-" : String(decision.barrier);
      $("mode").textContent = `Mode: ${decision.mode}`;

      if (state.digits.length < state.minTicks) {
        uiStatus("Collecting ticksâ€¦", `${state.digits.length}/${state.minTicks}`);
        return;
      }

      if (decision.barrier == null) {
        uiStatus("Skipping trade", decision.mode === "SKIP_VOL" ? `Vol=${vol.toFixed(2)} > ${state.volThreshold.toFixed(2)}` : "No signal");
        return;
      }

      if (state.trades >= state.maxTrades) return stop(`Max trades reached (${state.maxTrades})`);
      if (state.inContract) return;

      state.inContract = true;
      uiStatus("Placing tradeâ€¦", `DIGITDIFF barrier=${decision.barrier} stake=$${state.stake.toFixed(2)} (${decision.mode})`);
      log(`TRADE #${state.trades + 1} DIGITDIFF barrier=${decision.barrier} stake=$${state.stake.toFixed(2)} mode=${decision.mode}`);

      makeProposalDigitDiff(decision.barrier, state.stake);
    }

    // =========================
    // Start/Stop
    // =========================
    function start() {
      if (state.running) return;

      readInputs();

      state.token = ($("token").value || "").trim() || (localStorage.getItem("deriv_token") || "").trim();
      if (!state.token) {
        uiStatus("Missing token", "Paste token first");
        log("ERROR: token required");
        return;
      }

      state.trades = 0;
      state.pnl = 0;
      state.step = 0;
      state.stake = state.baseStake;

      state.inContract = false;
      state.liveContractId = null;
      state.contracts.clear();

      resetWindow();

      $("trades").textContent = `${state.trades}/${state.maxTrades}`;
      renderPnL();

      disableInputs(true);

      $("toggle").textContent = "STOP";
      $("toggle").classList.remove("bg-green-600","hover:bg-green-700");
      $("toggle").classList.add("bg-red-600","hover:bg-red-700");

      state.running = true;

      log(`START symbol=${state.symbol} window=${state.window} minTicks=${state.minTicks} volTh=${state.volThreshold} maxTrades=${state.maxTrades} base=$${state.baseStake.toFixed(2)}`);
      connect();
    }

    function stop(reason) {
      if (!state.running) return;

      state.running = false;
      disableInputs(false);

      $("toggle").textContent = "START";
      $("toggle").classList.remove("bg-red-600","hover:bg-red-700");
      $("toggle").classList.add("bg-green-600","hover:bg-green-700");

      uiStatus("Stopped", reason);
      log(`STOP: ${reason} | trades=${state.trades} pnl=$${state.pnl.toFixed(2)}`);

      try { if (state.ws) state.ws.close(); } catch {}
      state.ws = null;

      setBadge("disconnected");
    }

    // =========================
    // UI wiring
    // =========================
    $("saveToken").addEventListener("click", () => {
      const t = ($("token").value || "").trim();
      if (!t) return log("Token empty (not saved)");
      localStorage.setItem("deriv_token", t);
      state.token = t;
      log("Token saved locally");
    });

    $("clearToken").addEventListener("click", () => {
      localStorage.removeItem("deriv_token");
      $("token").value = "";
      state.token = "";
      log("Token cleared");
    });

    $("toggle").addEventListener("click", () => {
      if (state.running) stop("Manual stop");
      else start();
    });

    // Boot
    (function init() {
      const saved = (localStorage.getItem("deriv_token") || "").trim();
      if (saved) $("token").value = saved;

      readInputs();
      setBadge("disconnected");
      uiStatus("Ready", "Paste token â†’ Start");
      log("Bot initialized (DIGITDIFF + volatility+cluster barrier AI)");
    })();
  </script>
</body>
</html>
