<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deriv Over/Under Bot (Token UI + Real Trades)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#111827; }
    #log-area::-webkit-scrollbar{ width:4px; }
    #log-area::-webkit-scrollbar-thumb{ background:#4ade80; border-radius:2px; }
    #log-area::-webkit-scrollbar-track{ background:#374151; }

    .badge-ok { background: linear-gradient(90deg, #10b981, #059669) !important; }
    .badge-bad { background: linear-gradient(90deg, #dc2626, #b91c1c) !important; }
    .badge-warn { background: linear-gradient(90deg, #f59e0b, #d97706) !important; }

    @keyframes win-pulse { 0%{box-shadow:0 0 5px #10B981} 50%{box-shadow:0 0 30px #10B981} 100%{box-shadow:0 0 5px #10B981} }
    .win-glow{ animation:win-pulse 1s infinite; }
  </style>
</head>

<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">
  <div class="w-full max-w-6xl bg-gray-800 text-gray-100 shadow-2xl rounded-xl p-5 md:p-6">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl sm:text-3xl font-extrabold text-blue-400 border-b border-gray-700 pb-2 w-full">
        üîÆ Over/Under Bot
        <span id="status-badge" class="ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full badge-bad text-white shadow-md">
          üî¥ DISCONNECTED
        </span>
      </h1>
    </div>

    <!-- TOKEN BAR -->
    <div class="bg-gray-900 border border-gray-700 rounded-xl p-4 shadow-lg mb-6">
      <div class="flex flex-col md:flex-row gap-3 md:items-end">
        <div class="flex-1">
          <label for="token" class="block text-xs font-semibold text-gray-300 mb-1">Deriv API Token</label>
          <input id="token" type="password" placeholder="Paste your token here"
                 class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-3 py-2 text-sm" />
          <div class="text-[11px] text-gray-400 mt-1">
            Stored locally in your browser if you click ‚ÄúSave Token‚Äù.
          </div>
        </div>
        <div class="flex gap-2">
          <button id="saveTokenBtn" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition">Save Token</button>
          <button id="clearTokenBtn" class="px-4 py-2 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-700 transition">Clear</button>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- LEFT -->
      <div class="lg:col-span-1">
        <div class="bg-gray-900 border border-gray-700 rounded-xl p-4 shadow-lg">
          <h2 class="text-lg font-bold text-cyan-400 mb-4 pb-2 border-b border-gray-700">üìä MARKET</h2>

          <div class="mb-4 p-3 bg-gray-800 rounded-lg border border-gray-600 text-xs">
            <div class="grid grid-cols-2 gap-2">
              <div><span class="text-gray-400">Status:</span> <span id="market_status" class="ml-2 font-bold text-red-400">Offline</span></div>
              <div><span class="text-gray-400">Symbol:</span> <span id="current_symbol" class="ml-2 font-bold text-cyan-400">V. 100 Index</span></div>
              <div><span class="text-gray-400">Ticks:</span> <span id="ticks_received" class="ml-2 font-bold text-green-400">0</span></div>
              <div><span class="text-gray-400">Rate:</span> <span id="current_tick_rate" class="ml-2 font-bold text-blue-400">0/s</span></div>
            </div>
          </div>

          <div class="mb-4 p-3 bg-gray-800 rounded-lg border border-blue-500/50">
            <h3 class="text-sm font-bold text-blue-400 mb-3 flex items-center">
              üß† INCREMENTAL MEDIAN
              <span id="analysis-progress" class="ml-auto text-xs bg-gray-700 px-2 py-1 rounded">0/100</span>
            </h3>

            <div class="mb-3 p-2 bg-gray-900 rounded border border-gray-700">
              <div class="text-xs font-semibold text-gray-300 mb-1">Trading Gate:</div>
              <div id="window-status" class="text-sm font-bold text-yellow-400">Collecting data...</div>
              <div class="text-[11px] text-gray-400 mt-1">Trades can start after Min Ticks.</div>
            </div>

            <div class="mb-3 p-3 bg-gray-900 rounded border border-green-500/30 text-center">
              <div class="text-xs font-semibold text-green-400 mb-1">Median (rolling window)</div>
              <div id="median-value" class="text-4xl font-bold text-white">-</div>
              <div id="median-interpretation" class="text-xs text-gray-400 mt-1">Waiting for data</div>
            </div>

            <div class="mb-1 p-3 bg-gray-900 rounded border border-purple-500/30 text-center">
              <div class="text-xs font-semibold text-purple-400 mb-1">RECOMMENDATION</div>
              <div id="recommended-side" class="text-2xl font-bold text-white">---</div>
              <div id="confidence-score" class="text-xs text-gray-400 mt-1">Confidence: --</div>
            </div>
          </div>

          <div class="mt-2 p-3 bg-gray-800 rounded border border-blue-500/30">
            <h3 class="text-sm font-bold text-blue-300 mb-2">Session</h3>
            <div class="flex items-center justify-between">
              <div>
                <div class="text-xs text-gray-300">Side:</div>
                <div id="session_side" class="text-xl font-bold text-blue-400">-</div>
              </div>
              <div>
                <div class="text-xs text-gray-300">Trades:</div>
                <div id="session_trades" class="text-sm font-bold text-yellow-400">0/0</div>
              </div>
            </div>
            <div class="mt-3 text-xs text-gray-400">
              Stops on <span class="text-green-400 font-bold">FIRST WIN</span> or <span class="text-yellow-400 font-bold">MAX TRADES</span>.
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="lg:col-span-2">
        <div class="grid grid-cols-2 gap-3 mb-6">
          <div>
            <label for="symbol" class="block text-xs font-semibold text-gray-300 mb-1">Symbol</label>
            <select id="symbol" class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-1.5 text-sm">
              <option value="R_10">V. 10 Index</option>
              <option value="R_25">V. 25 Index</option>
              <option value="R_50">V. 50 Index</option>
              <option value="R_75">V. 75 Index</option>
              <option value="R_100" selected>V. 100 Index</option>
            </select>
          </div>

          <div>
            <label for="analysis_window" class="block text-xs font-semibold text-gray-300 mb-1">Rolling Window</label>
            <select id="analysis_window" class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-1.5 text-sm">
              <option value="20">20</option>
              <option value="50">50</option>
              <option value="100" selected>100</option>
              <option value="200">200</option>
            </select>
          </div>

          <div>
            <label for="min_ticks" class="block text-xs font-semibold text-gray-300 mb-1">Min Ticks Before Trading</label>
            <input id="min_ticks" type="number" min="1" max="500" value="10"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-1.5 text-sm">
          </div>

          <div>
            <label for="max_trades" class="block text-xs font-semibold text-gray-300 mb-1">Max Trades (session)</label>
            <input id="max_trades" type="number" min="1" max="500" value="10"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-1.5 text-sm">
          </div>

          <div>
            <label for="base_stake" class="block text-xs font-semibold text-gray-300 mb-1">Base Stake ($)</label>
            <input id="base_stake" type="number" min="0.35" step="0.01" value="1.00"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-1.5 text-sm">
          </div>

          <div>
            <label for="multiplier" class="block text-xs font-semibold text-gray-300 mb-1">Multiplier</label>
            <input id="multiplier" type="number" min="1.0" step="0.1" value="1.5"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-1.5 text-sm">
          </div>

          <div>
            <label for="max_steps" class="block text-xs font-semibold text-gray-300 mb-1">Max Steps</label>
            <input id="max_steps" type="number" min="0" max="20" step="1" value="3"
                   class="w-full rounded-md bg-gray-700 border border-gray-600 text-white px-2 py-1.5 text-sm">
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1">Mode</label>
            <div class="grid grid-cols-2 gap-2">
              <button id="mode_smart" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition">üß† SMART</button>
              <button id="mode_fixed" class="px-4 py-2 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-700 transition">üîí FIXED</button>
            </div>
          </div>

          <div class="col-span-2" id="fixed_side_container" style="display:none;">
            <label class="block text-xs font-semibold text-gray-300 mb-1">Fixed Side</label>
            <div class="grid grid-cols-2 gap-2">
              <button id="side_over" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg">OVER 2</button>
              <button id="side_under" class="px-4 py-2 bg-gray-600 text-white font-bold rounded-lg">UNDER 7</button>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-4 gap-2 mb-4">
          <div class="bg-gray-700 rounded-lg p-2 col-span-2">
            <p class="text-[10px] text-green-500">Current Tick</p>
            <p id="metricLiveTick" class="text-lg font-bold text-white">---</p>
            <p id="metricLastDigit" class="text-xs text-green-300">Digit: ?</p>
          </div>
          <div class="bg-gray-700 rounded-lg p-2">
            <p class="text-[10px] text-green-500">Balance</p>
            <p id="metricBalance" class="text-lg font-bold text-green-400">$---</p>
          </div>
          <div class="bg-gray-700 rounded-lg p-2">
            <p class="text-[10px] text-green-500">Trades</p>
            <p id="metricTradeCount" class="text-lg font-bold text-white">0</p>
          </div>
          <div class="bg-gray-700 rounded-lg p-2 col-span-2">
            <p class="text-[10px] text-lime-400">P/L (sum of contract profits)</p>
            <p id="metricTotalProfit" class="text-lg font-bold text-white">$0.00</p>
          </div>
          <div class="bg-gray-700 rounded-lg p-2 col-span-2">
            <p class="text-[10px] text-green-500">Next Stake</p>
            <p id="metricCurrentStake" class="text-lg font-bold text-white">$0.00</p>
          </div>
        </div>

        <div id="trade-status" class="bg-gray-900 rounded-lg p-3 border border-yellow-500/50 mb-4">
          <div class="flex justify-between items-center mb-1">
            <p class="text-xs font-semibold text-yellow-500">TRADE STATUS</p>
            <p id="status-badge-small" class="text-xs text-gray-400">READY</p>
          </div>
          <p id="status-message" class="text-sm font-bold text-gray-300">Waiting for start...</p>
          <p id="next-action" class="text-xs text-yellow-400 mt-1">Click START</p>
        </div>
      </div>
    </div>

    <div class="flex justify-center my-5">
      <button id="toggleButton"
              class="w-full md:w-1/2 px-6 py-3 bg-green-600 text-white font-bold text-lg rounded-lg shadow-xl hover:bg-green-700 transition">
        üöÄ START BOT
      </button>
    </div>

    <div>
      <h2 class="text-lg font-bold text-gray-300 mb-2 border-b border-gray-700 pb-1">Live Log</h2>
      <div id="log-area" class="h-80 bg-gray-900 text-lime-400 p-2.5 rounded-lg overflow-y-scroll text-xs">
[00:00:00] ü§ñ Over/Under Bot Initialized
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // State
    // ============================================
    const state = {
      ws: null,
      reqId: 0,

      isRunning: false,
      isConnecting: false,
      authorized: false,

      token: "",

      symbol: "R_100",
      analysisWindow: 100,
      minTicks: 10,

      strategy: "smart", // smart|fixed
      fixedSide: "OVER",
      currentSide: null,

      baseStake: 1.0,
      multiplier: 1.5,
      maxSteps: 3,
      step: 0,
      stake: 1.0,

      maxTrades: 10,
      trades: 0,

      stopOnFirstWin: true,

      tickCount: 0,
      tickTimes: [],
      lastDigit: null,

      digits: [],

      inContract: false,
      liveContractId: null,
      openContractSubId: null,

      profit: 0,
    };

    const pending = {
      proposalReqId: null,
      buyReqId: null,
      proposalId: null,
      side: null,
      stake: null,
    };

    // ============================================
    // DOM helpers
    // ============================================
    const $ = (id) => document.getElementById(id);

    function nowTime() {
      return new Date().toLocaleTimeString("en-US", { hour12:false, hour:"2-digit", minute:"2-digit", second:"2-digit" });
    }

    function log(msg, type = "INFO") {
      const area = $("log-area");
      let cls = "text-lime-400";
      if (type === "ERROR") cls = "text-red-400";
      if (type === "SYSTEM") cls = "text-white";
      if (type === "TRADE") cls = "text-yellow-300";
      if (type === "WIN") cls = "text-green-400 font-bold";
      if (type === "LOSS") cls = "text-red-400";
      if (type === "ENGINE") cls = "text-cyan-300";
      area.innerHTML += `\n[${nowTime()}] <span class="${cls}">${msg}</span>`;
      area.scrollTop = area.scrollHeight;
    }

    function setBadge(status) {
      const b = $("status-badge");
      const s = $("market_status");
      if (status === "connected") {
        b.textContent = "üü¢ CONNECTED";
        b.className = "ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full badge-ok text-white shadow-md";
        s.textContent = "Live";
        s.className = "ml-2 font-bold text-green-400";
      } else if (status === "connecting") {
        b.textContent = "üü° CONNECTING";
        b.className = "ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full badge-warn text-white shadow-md";
        s.textContent = "Connecting...";
        s.className = "ml-2 font-bold text-yellow-400";
      } else {
        b.textContent = "üî¥ DISCONNECTED";
        b.className = "ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full badge-bad text-white shadow-md";
        s.textContent = "Offline";
        s.className = "ml-2 font-bold text-red-400";
      }
    }

    function updateRateAndCounts() {
      const now = Date.now();
      state.tickTimes = state.tickTimes.filter(t => now - t < 5000);
      $("current_tick_rate").textContent = (state.tickTimes.length / 5).toFixed(1) + "/s";
      $("ticks_received").textContent = String(state.tickCount);
      $("metricTradeCount").textContent = String(state.trades);
      $("session_trades").textContent = `${state.trades}/${state.maxTrades}`;
      $("current_symbol").textContent = $("symbol").options[$("symbol").selectedIndex].text;
    }

    function updateTradeStatus(status, message, action, kind = "normal") {
      const box = $("trade-status");
      const badge = $("status-badge-small");
      const msg = $("status-message");
      const act = $("next-action");

      box.classList.remove("win-glow");
      msg.textContent = message;
      act.textContent = action;

      if (kind === "trade") {
        badge.textContent = "TRADING ‚ö°";
        badge.className = "text-xs font-bold text-yellow-400";
        msg.className = "text-sm font-bold text-yellow-400";
      } else if (kind === "win") {
        badge.textContent = "WIN üéØ";
        badge.className = "text-xs font-bold text-green-400";
        msg.className = "text-sm font-bold text-green-400";
        box.classList.add("win-glow");
      } else if (kind === "loss") {
        badge.textContent = "LOSS ‚ùå";
        badge.className = "text-xs font-bold text-red-400";
        msg.className = "text-sm font-bold text-red-400";
      } else {
        badge.textContent = status;
        badge.className = "text-xs font-bold text-gray-400";
        msg.className = "text-sm font-bold text-gray-300";
      }
    }

    function updatePnL() {
      $("metricTotalProfit").textContent = `$${state.profit.toFixed(2)}`;
      $("metricTotalProfit").className = state.profit >= 0 ? "text-lg font-bold text-green-400" : "text-lg font-bold text-red-400";
    }

    function updateStakeUI() {
      $("metricCurrentStake").textContent = `$${state.stake.toFixed(2)}`;
    }

    function setSessionSide(side) {
      state.currentSide = side;
      $("session_side").textContent = side;
      $("session_side").className = side === "OVER" ? "text-xl font-bold text-blue-400" : "text-xl font-bold text-purple-400";
    }

    // ============================================
    // Incremental median
    // ============================================
    function pushDigit(d) {
      state.digits.push(d);
      if (state.digits.length > state.analysisWindow) state.digits.shift();
    }

    function calcMedian(arr) {
      if (!arr.length) return null;
      const s = [...arr].sort((a, b) => a - b);
      const mid = Math.floor(s.length / 2);
      return (s.length % 2 === 0) ? (s[mid - 1] + s[mid]) / 2 : s[mid];
    }

    function computeRecommendation() {
      const used = state.digits.length;
      $("analysis-progress").textContent = `${used}/${state.analysisWindow}`;

      if (used < state.minTicks) {
        $("window-status").textContent = `Collecting data... (${used}/${state.minTicks})`;
        $("window-status").className = "text-sm font-bold text-yellow-400";
      } else {
        $("window-status").textContent = `Ready (min ticks reached)`;
        $("window-status").className = "text-sm font-bold text-green-400";
      }

      const med = calcMedian(state.digits);
      if (med === null) {
        $("median-value").textContent = "-";
        $("median-interpretation").textContent = "Waiting for data";
        $("recommended-side").textContent = "---";
        $("confidence-score").textContent = "Confidence: --";
        return { median: null, side: null, confidence: 0 };
      }

      $("median-value").textContent = med.toFixed(1);
      if (med > 4.5) {
        $("median-value").className = "text-4xl font-bold text-orange-400";
        $("median-interpretation").textContent = "‚ÜóÔ∏è Trending HIGH";
      } else {
        $("median-value").className = "text-4xl font-bold text-blue-400";
        $("median-interpretation").textContent = "‚ÜôÔ∏è Trending LOW";
      }

      const side = med > 4.5 ? "OVER" : "UNDER";
      const confidence = Math.min(100, Math.round((Math.abs(med - 4.5) / 4.5) * 100));

      $("recommended-side").textContent = side === "OVER" ? "OVER 2" : "UNDER 7";
      $("recommended-side").className = side === "OVER" ? "text-2xl font-bold text-blue-400" : "text-2xl font-bold text-purple-400";
      $("confidence-score").textContent = `Confidence: ${confidence}%`;

      return { median: med, side, confidence };
    }

    function decideSide() {
      if (state.strategy === "fixed") return state.fixedSide;
      const r = computeRecommendation();
      return r.side || "OVER";
    }

    // ============================================
    // Deriv WS helpers
    // ============================================
    function nextReqId() {
      state.reqId += 1;
      return state.reqId;
    }

    function send(msg) {
      if (!state.ws || state.ws.readyState !== WebSocket.OPEN) return;
      state.ws.send(JSON.stringify(msg));
    }

    function connect() {
      if (state.ws) {
        try { state.ws.close(); } catch {}
      }

      state.isConnecting = true;
      setBadge("connecting");

      state.ws = new WebSocket("wss://ws.binaryws.com/websockets/v3?app_id=120389");

      state.ws.onopen = () => {
        state.isConnecting = false;
        setBadge("connected");
        log("‚úÖ WebSocket connected", "SYSTEM");

        if (!state.token) {
          log("‚ùå Token missing. Paste token and click Save Token.", "ERROR");
          stop("Missing token");
          return;
        }

        send({ authorize: state.token, req_id: nextReqId() });
      };

      state.ws.onmessage = (ev) => {
        let data;
        try { data = JSON.parse(ev.data); } catch { return; }

        if (data.error) {
          log(`‚ùå API Error: ${data.error.message}`, "ERROR");
          state.inContract = false;
          state.liveContractId = null;
          state.openContractSubId = null;
          return;
        }

        switch (data.msg_type) {
          case "authorize":
            state.authorized = true;
            log(`üîê Authorized as ${data.authorize.loginid}`, "SYSTEM");
            send({ ticks: state.symbol, subscribe: 1, req_id: nextReqId() });
            send({ balance: 1, subscribe: 1, req_id: nextReqId() });
            break;

          case "tick":
            onTick(data.tick);
            break;

          case "balance":
            if (data.balance && typeof data.balance.balance !== "undefined") {
              $("metricBalance").textContent = `$${Number(data.balance.balance).toFixed(2)}`;
            }
            break;

          case "proposal":
            onProposal(data.proposal, data.req_id);
            break;

          case "buy":
            onBuy(data.buy, data.req_id);
            break;

          case "proposal_open_contract":
            onOpenContract(data.proposal_open_contract);
            break;

          default:
            break;
        }
      };

      state.ws.onclose = () => {
        setBadge("disconnected");
        log("üîå WebSocket disconnected", "SYSTEM");
      };

      state.ws.onerror = () => {
        setBadge("disconnected");
        log("‚ùå WebSocket error", "ERROR");
      };
    }

    // ============================================
    // Trading lifecycle (REAL)
    // ============================================
    function makeProposal(side, stake) {
      // Digit contracts:
      // - OVER 2 => DIGITOVER barrier 2
      // - UNDER 7 => DIGITUNDER barrier 7
      const contractType = side === "OVER" ? "DIGITOVER" : "DIGITUNDER";
      const barrier = side === "OVER" ? "2" : "7";

      const reqId = nextReqId();
      pending.proposalReqId = reqId;
      pending.side = side;
      pending.stake = stake;

      send({
        proposal: 1,
        amount: stake.toFixed(2),
        basis: "stake",
        contract_type: contractType,
        currency: "USD",
        duration: 1,
        duration_unit: "t",
        symbol: state.symbol,
        barrier,
        req_id: reqId,
      });
    }

    function onProposal(proposal, reqId) {
      if (reqId !== pending.proposalReqId) return;
      if (!proposal || !proposal.id) {
        log("‚ùå Proposal failed (no id)", "ERROR");
        state.inContract = false;
        return;
      }

      pending.proposalId = proposal.id;
      const buyReqId = nextReqId();
      pending.buyReqId = buyReqId;

      send({
        buy: proposal.id,
        price: proposal.ask_price,
        req_id: buyReqId,
      });
    }

    function onBuy(buy, reqId) {
      if (reqId !== pending.buyReqId) return;
      if (!buy || !buy.contract_id) {
        log("‚ùå Buy failed (no contract_id)", "ERROR");
        state.inContract = false;
        return;
      }

      state.liveContractId = buy.contract_id;

      // Subscribe to contract updates until it is_sold
      const subReq = nextReqId();
      state.openContractSubId = subReq;

      send({
        proposal_open_contract: 1,
        contract_id: state.liveContractId,
        subscribe: 1,
        req_id: subReq,
      });

      log(`üßæ Bought contract ${state.liveContractId} (${pending.side}) stake $${pending.stake.toFixed(2)}`, "TRADE");
      updateTradeStatus("LIVE", `Contract live (${pending.side})`, "Waiting settlement...", "trade");
    }

    function onOpenContract(oc) {
      if (!oc) return;
      if (String(oc.contract_id) !== String(state.liveContractId)) return;
      if (!oc.is_sold) return;

      const profit = Number(oc.profit || 0);
      const isWin = profit > 0;

      state.trades += 1;
      state.profit += profit;

      // keep balance tight after settlement
      send({ balance: 1, req_id: nextReqId() });

      updatePnL();
      updateRateAndCounts();

      if (isWin) {
        log(`‚úÖ WIN! Profit $${profit.toFixed(2)} | Trades ${state.trades}/${state.maxTrades}`, "WIN");
        updateTradeStatus("WIN", `WIN +$${profit.toFixed(2)}`, "Stopping (stop-on-win)", "win");
        resetAfterWin();
        finalizeContract();

        if (state.stopOnFirstWin) {
          stop("Stopped on first WIN");
          return;
        }
      } else {
        log(`‚ùå LOSS. Profit $${profit.toFixed(2)} | Trades ${state.trades}/${state.maxTrades}`, "LOSS");
        applyAfterLoss();
        updateTradeStatus("LOSS", `LOSS ${profit.toFixed(2)}`, `Next stake: $${state.stake.toFixed(2)}`, "loss");
        finalizeContract();
      }

      if (state.trades >= state.maxTrades) {
        stop(`Max trades reached (${state.maxTrades})`);
      }
    }

    function finalizeContract() {
      state.inContract = false;
      state.liveContractId = null;
      state.openContractSubId = null;
    }

    function resetAfterWin() {
      state.step = 0;
      state.stake = state.baseStake;
      updateStakeUI();
    }

    function applyAfterLoss() {
      state.step += 1;
      if (state.step > state.maxSteps) {
        state.step = 0;
        state.stake = state.baseStake;
      } else {
        state.stake = round2(state.baseStake * Math.pow(state.multiplier, state.step));
      }
      updateStakeUI();
    }

    function round2(n) {
      return Math.round(n * 100) / 100;
    }

    // ============================================
    // Tick -> trade trigger
    // ============================================
    function lastDigitOfQuote(q) {
      const s = String(q);
      const ch = s[s.length - 1];
      const d = parseInt(ch, 10);
      return Number.isFinite(d) ? d : null;
    }

    function onTick(tick) {
      if (!state.isRunning) return;

      const digit = lastDigitOfQuote(tick.quote);
      if (digit === null) return;

      state.lastDigit = digit;
      state.tickCount += 1;
      state.tickTimes.push(Date.now());

      $("metricLiveTick").textContent = Number(tick.quote).toFixed(3);
      $("metricLastDigit").textContent = `Digit: ${digit}`;

      pushDigit(digit);
      const rec = computeRecommendation();

      updateRateAndCounts();

      if (state.digits.length < state.minTicks) {
        updateTradeStatus("COLLECTING", `Collecting ticks (${state.digits.length}/${state.minTicks})`, "Waiting...", "normal");
        return;
      }

      if (state.trades >= state.maxTrades) {
        stop(`Max trades reached (${state.maxTrades})`);
        return;
      }

      if (state.inContract) return;

      // Place a real contract each time we are idle and eligible
      const side = decideSide();
      setSessionSide(side);

      state.inContract = true;

      log(`üìà Placing trade #${state.trades + 1}: ${side} stake $${state.stake.toFixed(2)} (median=${rec.median?.toFixed(1) ?? "?"})`, "TRADE");
      updateTradeStatus("PROPOSING", `Trade #${state.trades + 1}: ${side}`, `Stake: $${state.stake.toFixed(2)}`, "trade");

      makeProposal(side, state.stake);
    }

    // ============================================
    // UI / controls
    // ============================================
    function clampInt(v, min, max, fallback) {
      const n = parseInt(v, 10);
      if (!Number.isFinite(n)) return fallback;
      return Math.max(min, Math.min(max, n));
    }

    function clampNum(v, min, max, fallback) {
      const n = parseFloat(v);
      if (!Number.isFinite(n)) return fallback;
      return Math.max(min, Math.min(max, n));
    }

    function readInputs() {
      state.symbol = $("symbol").value;
      state.analysisWindow = clampInt($("analysis_window").value, 5, 500, 100);
      state.minTicks = clampInt($("min_ticks").value, 1, 500, 10);
      state.maxTrades = clampInt($("max_trades").value, 1, 500, 10);

      state.baseStake = clampNum($("base_stake").value, 0.35, 100000, 1.0);
      state.multiplier = clampNum($("multiplier").value, 1.0, 10.0, 1.5);
      state.maxSteps = clampInt($("max_steps").value, 0, 20, 3);

      state.stake = state.baseStake;
      updateStakeUI();

      if (state.digits.length > state.analysisWindow) {
        state.digits = state.digits.slice(state.digits.length - state.analysisWindow);
      }

      $("current_symbol").textContent = $("symbol").options[$("symbol").selectedIndex].text;
      $("analysis-progress").textContent = `${state.digits.length}/${state.analysisWindow}`;
      $("session_trades").textContent = `${state.trades}/${state.maxTrades}`;
      $("metricTradeCount").textContent = String(state.trades);
    }

    function disableInputs(disabled) {
      ["token","symbol","analysis_window","min_ticks","max_trades","base_stake","multiplier","max_steps"].forEach(id => {
        $(id).disabled = disabled;
      });
      ["mode_smart","mode_fixed","side_over","side_under","saveTokenBtn","clearTokenBtn"].forEach(id => {
        $(id).disabled = disabled;
        $(id).classList.toggle("opacity-60", disabled);
      });
    }

    function start() {
      if (state.isRunning) return;

      readTokenFromUI();
      readInputs();

      if (!state.token) {
        log("‚ùå Paste token and click Save Token (or just paste token).", "ERROR");
        return;
      }

      state.trades = 0;
      state.profit = 0;
      state.tickCount = 0;
      state.tickTimes = [];
      state.inContract = false;
      state.liveContractId = null;
      state.openContractSubId = null;

      pending.proposalReqId = null;
      pending.buyReqId = null;
      pending.proposalId = null;
      pending.side = null;
      pending.stake = null;

      updatePnL();
      updateStakeUI();
      updateRateAndCounts();
      computeRecommendation();

      setSessionSide(state.strategy === "fixed" ? state.fixedSide : "OVER");

      state.isRunning = true;
      disableInputs(true);

      $("toggleButton").textContent = "‚èπÔ∏è STOP BOT";
      $("toggleButton").classList.remove("bg-green-600","hover:bg-green-700");
      $("toggleButton").classList.add("bg-red-600","hover:bg-red-700");

      log(`üöÄ Starting bot (maxTrades=${state.maxTrades}, minTicks=${state.minTicks}, window=${state.analysisWindow})`, "SYSTEM");
      updateTradeStatus("STARTING", "Connecting...", "Authorizing...", "normal");

      connect();
    }

    function stop(reason = "Stopped") {
      if (!state.isRunning) return;

      state.isRunning = false;
      disableInputs(false);

      $("toggleButton").textContent = "üöÄ START BOT";
      $("toggleButton").classList.remove("bg-red-600","hover:bg-red-700");
      $("toggleButton").classList.add("bg-green-600","hover:bg-green-700");

      updateTradeStatus("STOPPED", reason, `Net: $${state.profit.toFixed(2)}`, state.profit > 0 ? "win" : "normal");
      log(`‚èπÔ∏è Bot stopped: ${reason}`, "SYSTEM");

      try { if (state.ws) state.ws.close(); } catch {}
      state.ws = null;
      setBadge("disconnected");

      state.inContract = false;
      state.liveContractId = null;
      state.openContractSubId = null;
      state.authorized = false;
    }

    function toggle() {
      if (state.isRunning) stop("Manual stop");
      else start();
    }

    function setStrategy(mode) {
      state.strategy = mode;

      if (mode === "smart") {
        $("mode_smart").classList.add("bg-blue-600");
        $("mode_fixed").classList.remove("bg-blue-600");
        $("mode_fixed").classList.add("bg-gray-600");
        $("fixed_side_container").style.display = "none";
        log("üß† Strategy: SMART", "SYSTEM");
      } else {
        $("mode_fixed").classList.add("bg-blue-600");
        $("mode_smart").classList.remove("bg-blue-600");
        $("mode_smart").classList.add("bg-gray-600");
        $("fixed_side_container").style.display = "block";
        log("üîí Strategy: FIXED", "SYSTEM");
      }
    }

    function setFixedSide(side) {
      state.fixedSide = side;
      setSessionSide(side);

      if (side === "OVER") {
        $("side_over").classList.add("bg-blue-600");
        $("side_over").classList.remove("bg-gray-600");
        $("side_under").classList.add("bg-gray-600");
        $("side_under").classList.remove("bg-purple-600");
      } else {
        $("side_under").classList.add("bg-purple-600");
        $("side_under").classList.remove("bg-gray-600");
        $("side_over").classList.add("bg-gray-600");
        $("side_over").classList.remove("bg-blue-600");
      }

      log(`üîí Fixed side = ${side}`, "SYSTEM");
    }

    // ============================================
    // Token storage
    // ============================================
    function readTokenFromUI() {
      state.token = ($("token").value || "").trim();
      if (!state.token) {
        const saved = (localStorage.getItem("deriv_token") || "").trim();
        if (saved) {
          state.token = saved;
          $("token").value = saved;
        }
      }
    }

    function saveToken() {
      const t = ($("token").value || "").trim();
      if (!t) {
        log("‚ùå Token empty. Paste token first.", "ERROR");
        return;
      }
      localStorage.setItem("deriv_token", t);
      state.token = t;
      log("‚úÖ Token saved locally.", "SYSTEM");
    }

    function clearToken() {
      localStorage.removeItem("deriv_token");
      $("token").value = "";
      state.token = "";
      log("üßπ Token cleared.", "SYSTEM");
    }

    // ============================================
    // Init
    // ============================================
    document.addEventListener("DOMContentLoaded", () => {
      setBadge("disconnected");

      const saved = (localStorage.getItem("deriv_token") || "").trim();
      if (saved) $("token").value = saved;

      $("saveTokenBtn").addEventListener("click", saveToken);
      $("clearTokenBtn").addEventListener("click", clearToken);

      $("toggleButton").addEventListener("click", toggle);

      $("mode_smart").addEventListener("click", () => setStrategy("smart"));
      $("mode_fixed").addEventListener("click", () => setStrategy("fixed"));
      $("side_over").addEventListener("click", () => setFixedSide("OVER"));
      $("side_under").addEventListener("click", () => setFixedSide("UNDER"));

      ["symbol","analysis_window","min_ticks","max_trades","base_stake","multiplier","max_steps"].forEach(id => {
        $(id).addEventListener("input", () => {
          if (!state.isRunning) {
            readInputs();
            computeRecommendation();
          }
        });
      });

      // defaults
      setStrategy("smart");
      setFixedSide("OVER");

      readTokenFromUI();
      readInputs();
      updateStakeUI();
      updatePnL();
      computeRecommendation();

      updateTradeStatus("READY", "Ready", "Paste token (optional save) then click START", "normal");
      log("üß† Median analysis engine loaded (incremental).", "ENGINE");
      if (saved) log("üîë Token loaded from localStorage.", "SYSTEM");
    });
  </script>
</body>
</html>
