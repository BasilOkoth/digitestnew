<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Deriv DigitMatchStar Bot - Smart Overdue Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* Custom styles */
        .balance-green {
            color: #10B981;
            font-weight: bold;
        }
        
        .profit-positive {
            color: #10B981;
            font-weight: 900;
            font-size: 1.125rem;
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        
        .profit-negative {
            color: #EF4444;
            font-weight: 900;
            font-size: 1.125rem;
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        
        .profit-neutral {
            color: #9CA3AF;
            font-weight: 600;
        }
        
        .status-win {
            color: #10B981;
            font-weight: bold;
        }
        
        .status-loss {
            color: #EF4444;
            font-weight: bold;
        }
        
        .status-trade {
            color: #F59E0B;
            font-weight: bold;
        }
        
        .tick-flash {
            animation: tickFlash 0.2s;
        }
        
        @keyframes tickFlash {
            0% { background-color: transparent; }
            50% { background-color: rgba(59, 130, 246, 0.3); }
            100% { background-color: transparent; }
        }
        
        .connection-badge-connected {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }
        
        .connection-badge-connecting {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
        }
        
        .connection-badge-disconnected {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
        }
        
        .phase-monitoring {
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
        }
        
        .phase-analysis {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        }
        
        .phase-trading {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }
        
        .contract-type-badge {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        .account-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #9CA3AF;
            transition: color 0.3s;
        }
        
        .account-label-demo {
            color: #3B82F6;
        }
        
        .account-label-real {
            color: #10B981;
        }
        
        .account-toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            margin: 0 8px;
        }
        
        .account-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .account-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            transition: .4s;
            border-radius: 24px;
        }
        
        .account-toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .account-toggle-slider {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }
        
        input:checked + .account-toggle-slider:before {
            transform: translateX(20px);
        }
        
        .calculator-highlight {
            border-color: #8B5CF6;
            background-color: rgba(139, 92, 246, 0.1);
        }
        
        .calculator-pulse {
            animation: calculatorPulse 0.5s;
        }
        
        @keyframes calculatorPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .calculator-safe {
            color: #10B981;
        }
        
        .calculator-warning {
            color: #F59E0B;
        }
        
        .digit-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            border-radius: 6px;
            font-weight: bold;
            transition: all 0.3s;
            cursor: pointer;
            font-size: 1.125rem;
        }
        
        .digit-hot {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            color: white;
            transform: scale(1.05);
        }
        
        .digit-warm {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white;
        }
        
        .digit-cold {
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            color: white;
        }
        
        .digit-overdue {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            animation: overduePulse 2s infinite;
        }
        
        @keyframes overduePulse {
            0% { box-shadow: 0 0 5px rgba(16, 185, 129, 0.5); }
            50% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.8); }
            100% { box-shadow: 0 0 5px rgba(16, 185, 129, 0.5); }
        }
        
        .digit-extreme-cold {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            color: white;
            transform: scale(1.08);
        }
        
        .digit-selected {
            border: 3px solid #F59E0B;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
        }
        
        .start-button-active {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        
        .stop-button-active {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }
        
        .pnl-update-animation {
            animation: pnlUpdate 0.5s;
        }
        
        @keyframes pnlUpdate {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .win-glow {
            animation: winGlow 1s infinite alternate;
            border-color: #10B981;
        }
        
        @keyframes winGlow {
            from {
                box-shadow: 0 0 5px rgba(16, 185, 129, 0.5),
                            inset 0 0 5px rgba(16, 185, 129, 0.2);
            }
            to {
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.8),
                            inset 0 0 10px rgba(16, 185, 129, 0.3);
            }
        }
        
        /* Enhanced overdue analysis styles */
        .analysis-enhanced {
            border: 2px solid #3B82F6;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(30, 64, 175, 0.1) 100%);
        }
        
        .confidence-bar {
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            background: #374151;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #EF4444, #F59E0B, #10B981);
            transition: width 0.5s ease;
        }
        
        .digit-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
        }
        
        .stat-item {
            padding: 4px;
            border-radius: 4px;
            background: rgba(31, 41, 55, 0.5);
            font-size: 0.75rem;
        }
        
        /* Add calculator minimize styles */
        .calculator-minimized {
            max-height: 60px;
            overflow: hidden;
        }
        
        .calculator-toggle-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 10;
        }
        
        .calculator-toggle-btn:hover {
            background: rgba(0, 0, 0, 0.5);
        }
        
        .calculator-header {
            position: relative;
        }
        
        /* Enhanced trade status */
        .trade-status-highlight {
            position: relative;
            overflow: hidden;
        }
        
        .trade-status-highlight::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.1) 50%,
                transparent 70%
            );
            animation: shine 3s infinite linear;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <div class="w-full max-w-6xl bg-gray-800 text-gray-100 shadow-2xl rounded-xl p-5 md:p-6">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-extrabold text-green-400 border-b border-gray-700 pb-2">
                DigitMatchStar Bot 
                <span id="status-badge" class="ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full connection-badge-disconnected text-white shadow-md">
                    üî¥ DISCONNECTED
                </span>
                <span id="contract-type-badge" class="contract-type-badge bg-purple-600 text-white">DIGITMATCH</span>
                <span id="phase-badge" class="ml-2 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full phase-monitoring text-white shadow-md">
                    üìä MONITORING
                </span>
                <div class="account-toggle-container ml-3">
                    <span class="account-label account-label-demo">DEMO</span>
                    <label class="account-toggle">
                        <input type="checkbox" id="accTypeToggle" onchange="switchAccount()">
                        <span class="account-toggle-slider"></span>
                    </label>
                    <span class="account-label account-label-real">REAL</span>
                </div>
            </h1>
            <div class="flex items-center space-x-2">
                <button id="soundToggle" onclick="toggleSound()" 
                    class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700 transition">
                    üîä Sound ON
                </button>
                <button id="enhancedAnalysisToggle" onclick="toggleEnhancedAnalysis()" 
                    class="px-4 py-2 bg-purple-600 text-white font-bold rounded-lg shadow hover:bg-purple-700 transition">
                    üîç Enhanced Analysis: ON
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- LEFT COLUMN: OVERDUE DIGIT ANALYZER -->
            <div class="lg:col-span-1">
                <div class="bg-gray-900 border border-gray-700 rounded-xl p-4 shadow-lg analysis-enhanced" id="analysisContainer">
                    <h2 class="text-lg font-bold text-cyan-400 mb-4 pb-2 border-b border-gray-700">
                        üß† ENHANCED OVERDUE DIGIT ANALYZER
                    </h2>
                    
                    <!-- Analysis Status -->
                    <div class="mb-4 p-3 bg-gray-800 rounded-lg border border-cyan-500/30">
                        <h3 class="text-sm font-bold text-cyan-300 mb-3">Analysis Status</h3>
                        
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <div class="text-center p-2 bg-gray-900 rounded">
                                <div class="text-xs text-gray-400">Ticks Analyzed</div>
                                <div id="ticksAnalyzed" class="text-xl font-bold text-cyan-400">0</div>
                            </div>
                            <div class="text-center p-2 bg-gray-900 rounded">
                                <div class="text-xs text-gray-400">Phase</div>
                                <div id="analysisPhase" class="text-lg font-bold text-green-400">Monitoring</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="text-xs font-semibold text-gray-300 mb-1">Analysis Progress</div>
                            <div class="w-full bg-gray-700 rounded-full h-3 mb-2">
                                <div id="analysisProgress" class="bg-cyan-600 h-3 rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="text-xs text-gray-400 flex justify-between">
                                <span id="phaseDescription">Collecting initial data...</span>
                                <span id="phaseProgress">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Prediction -->
                    <div class="mb-4 p-3 bg-gray-800 rounded-lg border border-purple-500/50">
                        <h3 class="text-sm font-bold text-purple-300 mb-2">Current Prediction</h3>
                        <div class="text-center p-3 bg-gray-900 rounded-lg mb-2">
                            <div class="text-xs text-gray-400 mb-1">Overdue Digit</div>
                            <div id="currentPrediction" class="text-3xl font-bold text-green-400">-</div>
                            <div id="predictionConfidence" class="text-xs text-gray-400 mt-1">Confidence: -</div>
                            <div class="mt-2">
                                <div class="text-xs text-gray-400 mb-1">Confidence Level</div>
                                <div class="confidence-bar">
                                    <div id="confidenceFill" class="confidence-fill" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="text-center p-2 bg-gray-900 rounded">
                                <div class="text-gray-400">Last Seen</div>
                                <div id="lastSeen" class="font-bold text-yellow-400">-</div>
                            </div>
                            <div class="text-center p-2 bg-gray-900 rounded">
                                <div class="text-gray-400">Expected Avg</div>
                                <div id="expectedAverage" class="font-bold text-blue-400">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Digit Analysis -->
                    <div class="mb-4 p-3 bg-gray-800 rounded-lg border border-green-500/30">
                        <h3 class="text-sm font-bold text-green-300 mb-2">Enhanced Analysis</h3>
                        <div class="digit-stats-grid">
                            <div class="stat-item">
                                <div class="text-gray-400">Current Streak</div>
                                <div id="currentStreak" class="font-bold text-yellow-400">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="text-gray-400">Overdue Index</div>
                                <div id="overdueIndex" class="font-bold text-red-400">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="text-gray-400">Statistical Bias</div>
                                <div id="statisticalBias" class="font-bold text-blue-400">None</div>
                            </div>
                            <div class="stat-item">
                                <div class="text-gray-400">Pattern Score</div>
                                <div id="patternScore" class="font-bold text-purple-400">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Digit Matrix -->
                    <div class="mb-4 p-3 bg-gray-800 rounded-lg border border-gray-600">
                        <h3 class="text-sm font-bold text-gray-300 mb-3">Digit Status Matrix</h3>
                        <div class="grid grid-cols-5 gap-1 mb-3" id="digitMatrix">
                            <!-- Digits 0-9 will be populated here -->
                        </div>
                        <div class="text-xs text-gray-400">
                            <div class="flex items-center mb-1">
                                <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                                <span>Hot (Recent)</span>
                            </div>
                            <div class="flex items-center mb-1">
                                <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                                <span>Overdue (Trade Now)</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-blue-500 mr-2"></div>
                                <span>Cold (Monitor)</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Probability Distribution -->
                    <div class="p-3 bg-gray-800 rounded-lg border border-blue-500/30">
                        <h3 class="text-sm font-bold text-blue-300 mb-2">Probability Distribution</h3>
                        <div class="space-y-1" id="probabilityBars">
                            <!-- Probability bars will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- MIDDLE COLUMN: MAIN CONTROLS -->
            <div class="lg:col-span-2">
                <!-- MARTINGALE CALCULATOR -->
                <div class="mb-6 p-4 bg-gray-900 rounded-xl border border-purple-500/50 shadow-lg" id="calculatorContainer">
                    <div class="calculator-header">
                        <h2 class="text-lg font-bold text-purple-400 mb-3 pb-2 border-b border-gray-700 flex items-center">
                            üßÆ MARTINGALE CALCULATOR (1.15x)
                            <button id="calculatorToggle" class="calculator-toggle-btn" onclick="toggleCalculator()">
                                ‚àí
                            </button>
                        </h2>
                    </div>
                    
                    <div id="calculatorContent" class="transition-all duration-300">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-300 mb-1">Base Stake ($)</label>
                                    <input type="number" id="calc_base_stake" value="1.0" min="0.1" step="0.1" 
                                        class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm calculator-highlight">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-semibold text-gray-300 mb-1">Multiplier</label>
                                    <input type="number" id="calc_multiplier" value="1.15" min="1.0" step="0.01" 
                                        class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-semibold text-gray-300 mb-1">Max Trades</label>
                                    <input type="number" id="calc_max_trades" value="10" min="1" max="100" 
                                        class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-semibold text-gray-300 mb-1">Bankroll Limit ($)</label>
                                    <input type="number" id="calc_bankroll_limit" value="50.0" min="1.0" step="0.1" 
                                        class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm">
                                </div>
                                
                                <button onclick="calculateMartingale()" 
                                    class="w-full mt-2 px-4 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition">
                                    üßÆ CALCULATE
                                </button>
                            </div>
                            
                            <div class="space-y-3">
                                <div class="p-3 bg-gray-800 rounded-lg border border-green-500/50">
                                    <div class="text-xs font-semibold text-green-400 mb-1">Total Required</div>
                                    <div id="calc_total_required" class="text-xl font-bold text-white">$0.00</div>
                                    <div class="text-xs text-gray-400 mt-1">For all trades</div>
                                </div>
                                
                                <div class="p-3 bg-gray-800 rounded-lg border border-blue-500/50">
                                    <div class="text-xs font-semibold text-blue-400 mb-1">Final Stake</div>
                                    <div id="calc_final_stake" class="text-lg font-bold text-white">$0.00</div>
                                    <div class="text-xs text-gray-400 mt-1">Last trade amount</div>
                                </div>
                                
                                <div class="p-3 bg-gray-800 rounded-lg border border-yellow-500/50">
                                    <div class="text-xs font-semibold text-yellow-400 mb-1">Bankroll Status</div>
                                    <div id="calc_bankroll_status" class="text-lg font-bold text-white">-</div>
                                    <div class="text-xs text-gray-400 mt-1">vs. your limit</div>
                                </div>
                                
                                <div class="p-3 bg-gray-800 rounded-lg border border-cyan-500/50">
                                    <div class="text-xs font-semibold text-cyan-400 mb-1">Profit on Win</div>
                                    <div id="calc_profit_on_win" class="text-lg font-bold text-white">$0.00</div>
                                    <div class="text-xs text-gray-400 mt-1">9x payout minus investment</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Trade Sequence Display -->
                        <div class="mt-4 p-3 bg-gray-800 rounded-lg border border-purple-500/30">
                            <h3 class="text-sm font-bold text-purple-300 mb-2">Trade Sequence (1.15x Martingale)</h3>
                            <div id="tradeSequence" class="text-xs space-y-1 max-h-40 overflow-y-auto">
                                <!-- Trade sequence will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Trading Controls -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
                    <div>
                        <label for="symbol" class="block text-xs font-semibold text-gray-300 mb-1">Symbol</label>
                        <select id="symbol" class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                            <option value="R_10">V. 10 Index</option>
                            <option value="R_100">V. 100 Index</option>
                            <option value="R_25">V. 25 Index</option>
                            <option value="R_50">V. 50 Index</option>
                            <option value="R_75">V. 75 Index</option>
                        </select>
                    </div>

                    <div>
                        <label for="contractType" class="block text-xs font-semibold text-gray-300 mb-1">Contract Type</label>
                        <select id="contractType" class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                            <option value="DIGITMATCH">DIGITMATCH</option>
                        </select>
                    </div>

                    <div>
                        <label for="baseStake" class="block text-xs font-semibold text-gray-300 mb-1">Base Stake</label>
                        <input type="number" id="baseStake" value="1.0" min="0.1" step="0.1" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                    </div>

                    <div>
                        <label for="maxTrades" class="block text-xs font-semibold text-gray-300 mb-1">Max Trades</label>
                        <input type="number" id="maxTrades" value="10" min="1" max="100" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                    </div>
                    
                    <div>
                        <label for="multiplier" class="block text-xs font-semibold text-gray-300 mb-1">Multiplier</label>
                        <input type="number" id="multiplier" value="1.15" min="1.0" step="0.01" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                    </div>
                    
                    <div class="col-span-2 lg:col-span-4 p-3 bg-gray-800 rounded-lg border border-blue-500/30">
                        <h3 class="text-sm font-bold text-blue-300 mb-2">Analysis Settings</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">Analysis Window</label>
                                <input type="number" id="analysisWindow" value="30" min="20" max="200" 
                                    class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 py-1.5 px-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">Confidence Threshold</label>
                                <input type="number" id="confidenceThreshold" value="65" min="50" max="95" 
                                    class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 py-1.5 px-2 text-sm">
                                <div class="text-xs text-gray-400 mt-1">% confidence to trade</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- METRICS -->
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner border border-green-500/50 col-span-2">
                        <p class="text-[10px] font-semibold text-green-500 uppercase">Current Tick</p>
                        <p id="metricLiveTick" class="text-xl font-extrabold text-white">---</p>
                        <p id="metricLastDigit" class="text-lg font-bold text-green-300">Digit: ?</p>
                        <p id="metricTickRate" class="text-xs font-bold text-blue-400">Ticks/sec: --</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner border border-green-500/50">
                        <p class="text-[10px] font-semibold text-green-500 uppercase">Balance</p>
                        <p id="metricAccountBalance" class="text-lg font-bold balance-green">$---</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner">
                        <p class="text-[10px] font-semibold text-green-500 uppercase">Trade #</p>
                        <p id="metricTradeCount" class="text-lg font-bold text-white">0</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner">
                        <p class="text-[10px] font-semibold text-lime-400 uppercase">P/L</p>
                        <p id="metricTotalProfit" class="text-lg font-bold profit-neutral">$0.00</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner">
                        <p class="text-[10px] font-semibold text-green-500 uppercase">Stake</p>
                        <p id="metricCurrentStake" class="text-lg font-bold text-white">$0.00</p>
                    </div>
                    
                    <!-- TRADE STATUS SECTION -->
                    <div id="trade-result-container" class="bg-gray-900 rounded-lg p-3 shadow-inner border border-yellow-500/50 col-span-3 trade-status-highlight">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-[10px] font-semibold text-yellow-500 uppercase">TRADE STATUS</p>
                            <p id="metricTradeResult" class="text-xs font-bold text-gray-400">READY</p>
                        </div>
                        <div class="mb-2">
                            <p class="text-[10px] font-semibold text-gray-400 uppercase mb-1">Status:</p>
                            <p id="metricPreviousResult" class="text-sm font-bold text-gray-300">Waiting for connection...</p>
                        </div>
                        <div>
                            <p class="text-[10px] font-semibold text-gray-400 uppercase mb-1">Action:</p>
                            <p id="metricNextAction" class="text-sm font-bold text-yellow-400">Start bot to begin</p>
                        </div>
                    </div>
                </div>
                
                <!-- STATISTICS -->
                <div class="bg-gray-800 rounded-lg p-3 border border-gray-600">
                    <h3 class="text-sm font-bold text-gray-300 mb-2">Statistics</h3>
                    <div class="grid grid-cols-4 gap-2 text-xs">
                        <div class="text-center p-2 bg-gray-900 rounded">
                            <div class="text-gray-400">Total Trades</div>
                            <div id="statTotalTrades" class="text-lg font-bold text-white">0</div>
                        </div>
                        <div class="text-center p-2 bg-gray-900 rounded">
                            <div class="text-gray-400">Wins</div>
                            <div id="statWins" class="text-lg font-bold text-green-400">0</div>
                        </div>
                        <div class="text-center p-2 bg-gray-900 rounded">
                            <div class="text-gray-400">Losses</div>
                            <div id="statLosses" class="text-lg font-bold text-red-400">0</div>
                        </div>
                        <div class="text-center p-2 bg-gray-900 rounded">
                            <div class="text-gray-400">Win Rate</div>
                            <div id="statWinRate" class="text-lg font-bold text-yellow-400">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- START/STOP BUTTON -->
        <div class="flex justify-center mb-5">
            <button id="toggleButton" onclick="toggleBot()" 
                class="w-full md:w-1/2 px-6 py-3 bg-green-600 text-white font-bold text-lg rounded-lg shadow-xl hover:bg-green-700 transition duration-150">
                üöÄ START BOT
            </button>
        </div>

        <!-- LOG AREA -->
        <div id="log-column" class="w-full flex flex-col">
            <h2 class="text-lg font-bold text-gray-300 mb-2 border-b border-gray-700 pb-1">Live Log</h2>
            <div id="log-area" class="flex-grow h-80 bg-gray-900 text-lime-400 p-2.5 rounded-lg overflow-y-scroll text-xs whitespace-pre-wrap shadow-inner">
[00:00:00] ü§ñ Deriv Bot Initialized
[00:00:00] üß† Smart Overdue Digit Analyzer Ready
[00:00:00] üìä Will analyze digits and trade only statistically confirmed overdue digits
[00:00:00] ‚ö° Trading only begins after thorough analysis
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // ENHANCED SMART OVERDUE DIGIT ANALYZER
        // ============================================================================
        
        // Enhanced Analysis Configuration
        window.analysisConfig = {
            windowSize: 30,
            confidenceThreshold: 65,
            minTicksForAnalysis: 15,
            phases: {
                MONITORING: 0,
                ANALYSIS: 1,
                CONFIRMATION: 2,
                TRADING: 3
            },
            enhancedMode: true,
            patternDetection: true,
            statisticalAnalysis: true
        };
        
        // Enhanced Analysis State
        window.analysisState = {
            phase: 0,
            ticksAnalyzed: 0,
            digitHistory: [],
            digitStats: Array(10).fill().map(() => ({ 
                count: 0, 
                lastSeen: -1, 
                streak: 0,
                expectedAverage: 0,
                overdueScore: 0,
                probability: 0.1,
                patternScore: 0,
                distributionScore: 0
            })),
            patternHistory: [],
            currentPrediction: null,
            predictionConfidence: 0,
            lockedDigit: null,
            lockedDigitStartTime: 0,
            lockedDigitTradeCount: 0,
            currentStreak: 0,
            overdueIndex: 0,
            statisticalBias: 'None',
            patternScore: 0
        };
        
        // Enhanced Digit Heat Levels
        const DIGIT_HEAT = {
            HOT: 'hot',
            WARM: 'warm',
            COLD: 'cold',
            OVERDUE: 'overdue',
            EXTREME_COLD: 'extreme-cold'
        };
        
        // Initialize digit matrix
        function initializeDigitMatrix() {
            const matrix = document.getElementById('digitMatrix');
            matrix.innerHTML = '';
            
            for (let i = 0; i < 10; i++) {
                const digitCell = document.createElement('div');
                digitCell.className = 'digit-cell bg-gray-700 text-white';
                digitCell.id = `digit-${i}`;
                digitCell.textContent = i;
                digitCell.title = `Digit ${i}`;
                matrix.appendChild(digitCell);
            }
            
            // Initialize probability bars
            initializeProbabilityBars();
        }
        
        // Initialize probability bars
        function initializeProbabilityBars() {
            const barsContainer = document.getElementById('probabilityBars');
            barsContainer.innerHTML = '';
            
            for (let i = 0; i < 10; i++) {
                const barContainer = document.createElement('div');
                barContainer.className = 'flex items-center space-x-2';
                
                const digitLabel = document.createElement('div');
                digitLabel.className = 'w-4 text-xs text-gray-300';
                digitLabel.textContent = i;
                
                const barWrapper = document.createElement('div');
                barWrapper.className = 'flex-1 bg-gray-700 rounded-full h-2 overflow-hidden';
                
                const bar = document.createElement('div');
                bar.id = `prob-bar-${i}`;
                bar.className = 'h-full bg-green-500';
                bar.style.width = '10%';
                
                const percentLabel = document.createElement('div');
                percentLabel.id = `prob-percent-${i}`;
                percentLabel.className = 'w-8 text-xs text-gray-400';
                percentLabel.textContent = '10%';
                
                barWrapper.appendChild(bar);
                barContainer.appendChild(digitLabel);
                barContainer.appendChild(barWrapper);
                barContainer.appendChild(percentLabel);
                barsContainer.appendChild(barContainer);
            }
        }
        
        // Update probability bars
        function updateProbabilityBars() {
            const totalTicks = window.analysisState.ticksAnalyzed;
            if (totalTicks < 5) return;
            
            for (let i = 0; i < 10; i++) {
                const stat = window.analysisState.digitStats[i];
                const probability = totalTicks > 0 ? (stat.count / totalTicks) * 100 : 10;
                const expectedProbability = 10; // Expected 10% for each digit
                
                const bar = document.getElementById(`prob-bar-${i}`);
                const percentLabel = document.getElementById(`prob-percent-${i}`);
                
                // Color coding based on deviation from expected
                let barColor = '#10B981'; // Green for normal
                if (probability > expectedProbability * 1.5) {
                    barColor = '#EF4444'; // Red for overrepresented
                } else if (probability < expectedProbability * 0.5) {
                    barColor = '#3B82F6'; // Blue for underrepresented
                }
                
                bar.style.backgroundColor = barColor;
                bar.style.width = `${Math.min(probability, 30)}%`; // Cap at 30% for visualization
                percentLabel.textContent = `${probability.toFixed(1)}%`;
            }
        }
        
        // Enhanced heat level calculation
        function calculateDigitHeatLevels() {
            const heatLevels = Array(10).fill(DIGIT_HEAT.COLD);
            const stats = window.analysisState.digitStats;
            const totalTicks = window.analysisState.ticksAnalyzed;
            
            if (totalTicks < 15) return heatLevels;
            
            const expectedFrequency = totalTicks / 10;
            
            for (let i = 0; i < 10; i++) {
                const stat = stats[i];
                const ticksSinceLast = stat.lastSeen === -1 ? totalTicks : totalTicks - stat.lastSeen;
                
                // Enhanced overdue score calculation
                let overdueScore = 0;
                let patternScore = 0;
                let distributionScore = 0;
                
                // Pattern detection: Check for repeating patterns
                if (window.analysisConfig.patternDetection && window.analysisState.digitHistory.length > 10) {
                    const recentHistory = window.analysisState.digitHistory.slice(-10);
                    const patternFrequency = recentHistory.filter(d => d === i).length;
                    patternScore = patternFrequency * 2;
                }
                
                // Distribution analysis
                if (window.analysisConfig.statisticalAnalysis) {
                    const deviation = Math.abs(stat.count - expectedFrequency) / expectedFrequency;
                    distributionScore = deviation * 10;
                    
                    // If digit is severely underrepresented
                    if (stat.count < expectedFrequency * 0.3) {
                        distributionScore += 15;
                    }
                }
                
                // Combined score
                overdueScore = (ticksSinceLast / expectedFrequency) * 5 + patternScore + distributionScore;
                
                // If never appeared
                if (stat.count === 0 && totalTicks >= 10) {
                    overdueScore += 20;
                }
                
                stat.overdueScore = overdueScore;
                stat.patternScore = patternScore;
                stat.distributionScore = distributionScore;
                
                // Enhanced heat level determination
                if (ticksSinceLast <= 2) {
                    heatLevels[i] = DIGIT_HEAT.HOT;
                } else if (ticksSinceLast <= 5) {
                    heatLevels[i] = DIGIT_HEAT.WARM;
                } else if (overdueScore > 25) {
                    heatLevels[i] = DIGIT_HEAT.EXTREME_COLD;
                } else if (overdueScore > 15) {
                    heatLevels[i] = DIGIT_HEAT.OVERDUE;
                } else if (ticksSinceLast > expectedFrequency * 1.5) {
                    heatLevels[i] = DIGIT_HEAT.COLD;
                }
                
                // Update probability
                stat.probability = totalTicks > 0 ? stat.count / totalTicks : 0.1;
            }
            
            // Calculate overall statistical bias
            calculateStatisticalBias();
            
            return heatLevels;
        }
        
        // Calculate statistical bias
        function calculateStatisticalBias() {
            const stats = window.analysisState.digitStats;
            const totalTicks = window.analysisState.ticksAnalyzed;
            if (totalTicks < 20) return;
            
            let maxDeviation = 0;
            let biasedDigit = -1;
            
            for (let i = 0; i < 10; i++) {
                const expected = totalTicks / 10;
                const deviation = Math.abs(stats[i].count - expected);
                
                if (deviation > maxDeviation) {
                    maxDeviation = deviation;
                    biasedDigit = i;
                }
            }
            
            const biasLevel = maxDeviation / (totalTicks / 10);
            
            if (biasLevel > 0.5) {
                window.analysisState.statisticalBias = `Digit ${biasedDigit} (${(biasLevel * 100).toFixed(1)}% bias)`;
            } else {
                window.analysisState.statisticalBias = 'Balanced';
            }
            
            document.getElementById('statisticalBias').textContent = window.analysisState.statisticalBias;
        }
        
        // Enhanced overdue digit detection
        function findMostOverdueDigit() {
            const stats = window.analysisState.digitStats;
            const totalTicks = window.analysisState.ticksAnalyzed;
            const expectedFrequency = totalTicks / 10;
            
            let mostOverdue = null;
            let maxOverdueScore = 0;
            let currentStreak = 0;
            
            // Don't change prediction if we have a locked digit
            if (window.analysisState.lockedDigit !== null) {
                const lockedStat = stats[window.analysisState.lockedDigit];
                const ticksSinceLast = lockedStat.lastSeen === -1 ? totalTicks : totalTicks - lockedStat.lastSeen;
                let score = (ticksSinceLast / expectedFrequency) * 8;
                
                // Increase score based on trade count and time locked
                const timeLocked = (Date.now() - window.analysisState.lockedDigitStartTime) / 1000;
                score += window.analysisState.lockedDigitTradeCount * 5;
                score += Math.min(timeLocked / 10, 10);
                
                // Calculate streak
                const lastDigit = window.analysisState.digitHistory[window.analysisState.digitHistory.length - 1];
                if (window.analysisState.lockedDigit === lastDigit) {
                    currentStreak = 1;
                }
                
                return { 
                    digit: window.analysisState.lockedDigit, 
                    score: score, 
                    isLocked: true,
                    streak: currentStreak 
                };
            }
            
            for (let i = 0; i < 10; i++) {
                const stat = stats[i];
                const ticksSinceLast = stat.lastSeen === -1 ? totalTicks : totalTicks - stat.lastSeen;
                
                let score = 0;
                let streak = 0;
                
                // Base overdue score
                const baseScore = (ticksSinceLast / expectedFrequency) * 10;
                score += baseScore;
                
                // Pattern score bonus
                score += stat.patternScore;
                
                // Distribution score bonus (severely underrepresented)
                if (stat.count < expectedFrequency * 0.5) {
                    score += (expectedFrequency - stat.count) * 2;
                }
                
                // Consecutive miss bonus
                const consecutiveMissBonus = Math.floor(ticksSinceLast / (expectedFrequency * 2)) * 5;
                score += consecutiveMissBonus;
                
                // Hot streak detection
                if (window.analysisState.digitHistory.length >= 3) {
                    const recent = window.analysisState.digitHistory.slice(-3);
                    if (recent.every(d => d === i)) {
                        streak = 3;
                        score -= 20; // Reduce score for hot digits
                    } else if (recent.filter(d => d === i).length >= 2) {
                        streak = 2;
                        score -= 15;
                    }
                }
                
                // Update streak
                if (streak > currentStreak) {
                    currentStreak = streak;
                }
                
                // Only consider if significantly overdue
                if (score > maxOverdueScore && ticksSinceLast > expectedFrequency * 1.2) {
                    maxOverdueScore = score;
                    mostOverdue = i;
                }
            }
            
            window.analysisState.currentStreak = currentStreak;
            document.getElementById('currentStreak').textContent = currentStreak;
            
            // Calculate overdue index (0-100)
            const overdueIndex = Math.min(100, Math.round((maxOverdueScore / 50) * 100));
            window.analysisState.overdueIndex = overdueIndex;
            document.getElementById('overdueIndex').textContent = overdueIndex;
            
            return { 
                digit: mostOverdue, 
                score: maxOverdueScore, 
                isLocked: false,
                streak: currentStreak 
            };
        }
        
        // Enhanced confidence calculation
        function calculateConfidence(digit) {
            if (digit === null) return 0;
            
            const stats = window.analysisState.digitStats[digit];
            const totalTicks = window.analysisState.ticksAnalyzed;
            const expectedFrequency = totalTicks / 10;
            const ticksSinceLast = stats.lastSeen === -1 ? totalTicks : totalTicks - stats.lastSeen;
            
            let confidence = 0;
            
            // Higher confidence for locked digits
            if (window.analysisState.lockedDigit === digit) {
                const baseConfidence = 75;
                const tradeCountBonus = Math.min(20, window.analysisState.lockedDigitTradeCount * 8);
                const timeLockedBonus = Math.min(10, ((Date.now() - window.analysisState.lockedDigitStartTime) / 10000));
                confidence = baseConfidence + tradeCountBonus + timeLockedBonus;
            } else {
                // Enhanced confidence calculation
                const overdueRatio = ticksSinceLast / expectedFrequency;
                
                // Base confidence from overdue ratio
                if (overdueRatio > 4.0) {
                    confidence = 90;
                } else if (overdueRatio > 3.0) {
                    confidence = 85;
                } else if (overdueRatio > 2.5) {
                    confidence = 80;
                } else if (overdueRatio > 2.0) {
                    confidence = 75;
                } else if (overdueRatio > 1.5) {
                    confidence = 65;
                } else if (overdueRatio > 1.2) {
                    confidence = 55;
                }
                
                // Pattern confidence boost
                if (stats.patternScore > 5) {
                    confidence += 5;
                }
                
                // Distribution confidence boost
                if (stats.distributionScore > 10) {
                    confidence += 5;
                }
                
                // Sample size adjustment
                const sampleSizeFactor = Math.min(1, totalTicks / 40);
                confidence *= sampleSizeFactor;
                
                // Streak adjustment
                if (window.analysisState.currentStreak >= 2) {
                    confidence -= 10;
                }
            }
            
            // Calculate pattern score
            const patternScore = Math.min(100, Math.round(stats.patternScore * 5));
            window.analysisState.patternScore = patternScore;
            document.getElementById('patternScore').textContent = patternScore;
            
            return Math.min(98, Math.max(2, Math.round(confidence)));
        }
        
        // Process tick for enhanced analysis
        function processTickForAnalysis(tick) {
            const price = parseFloat(tick.quote);
            const symbol = document.getElementById('symbol').value;
            let decimalPlaces = 3;
            if (symbol === 'R_100') decimalPlaces = 2;
            const formattedPrice = price.toFixed(decimalPlaces);
            const digit = parseInt(formattedPrice.charAt(formattedPrice.length - 1), 10);
            
            if (isNaN(digit) || digit < 0 || digit > 9) return;
            
            window.analysisState.ticksAnalyzed++;
            window.analysisState.digitHistory.push(digit);
            
            if (window.analysisState.digitHistory.length > window.analysisConfig.windowSize) {
                window.analysisState.digitHistory.shift();
            }
            
            // Update pattern history
            if (window.analysisState.digitHistory.length >= 2) {
                const pattern = window.analysisState.digitHistory.slice(-2);
                window.analysisState.patternHistory.push(pattern.join('-'));
                if (window.analysisState.patternHistory.length > 50) {
                    window.analysisState.patternHistory.shift();
                }
            }
            
            const stat = window.analysisState.digitStats[digit];
            stat.count++;
            stat.lastSeen = window.analysisState.ticksAnalyzed;
            
            // Update streaks
            for (let i = 0; i < 10; i++) {
                if (i !== digit) {
                    window.analysisState.digitStats[i].streak = 0;
                } else {
                    window.analysisState.digitStats[i].streak++;
                }
            }
            
            // Check if locked digit appeared
            if (window.analysisState.lockedDigit !== null && digit === window.analysisState.lockedDigit) {
                log(`üéØ LOCKED DIGIT ${digit} APPEARED! Ending sequence.`, 'WIN');
                window.analysisState.lockedDigit = null;
                window.analysisState.lockedDigitTradeCount = 0;
                
                // Start PnL update sequence immediately
                startExtendedPnlUpdate(window.currentStake * 9);
            }
            
            document.getElementById('ticksAnalyzed').textContent = window.analysisState.ticksAnalyzed;
            updateAnalysisProgress();
            
            if (window.analysisState.ticksAnalyzed >= window.analysisConfig.minTicksForAnalysis) {
                performEnhancedOverdueAnalysis();
            }
            
            updateDigitMatrix();
            updateProbabilityBars();
        }
        
        // Enhanced overdue analysis
        function performEnhancedOverdueAnalysis() {
            if (window.analysisState.ticksAnalyzed < window.analysisConfig.minTicksForAnalysis) {
                return;
            }
            
            const overdueResult = findMostOverdueDigit();
            const confidence = calculateConfidence(overdueResult.digit);
            
            // Update confidence display
            document.getElementById('confidenceFill').style.width = `${confidence}%`;
            
            // If we have a locked digit, keep using it
            if (window.analysisState.lockedDigit !== null) {
                window.analysisState.currentPrediction = window.analysisState.lockedDigit;
            } else {
                window.analysisState.currentPrediction = overdueResult.digit;
                
                // Enhanced locking logic
                if (confidence >= window.analysisConfig.confidenceThreshold && 
                    overdueResult.digit !== null && 
                    !overdueResult.isLocked &&
                    window.analysisState.overdueIndex > 60) {
                    
                    window.analysisState.lockedDigit = overdueResult.digit;
                    window.analysisState.lockedDigitStartTime = Date.now();
                    window.analysisState.lockedDigitTradeCount = 0;
                    log(`üîí ENHANCED LOCK: Digit ${overdueResult.digit} (${confidence}% confidence, ${window.analysisState.overdueIndex} overdue index)`, 'TRADE');
                }
            }
            
            window.analysisState.predictionConfidence = confidence;
            
            updatePredictionDisplay();
            
            if (confidence >= window.analysisConfig.confidenceThreshold && overdueResult.digit !== null) {
                const stat = window.analysisState.digitStats[overdueResult.digit];
                const ticksSinceLast = stat.lastSeen === -1 ? window.analysisState.ticksAnalyzed : window.analysisState.ticksAnalyzed - stat.lastSeen;
                const expected = Math.floor(window.analysisState.ticksAnalyzed / 10);
                
                if (window.analysisState.enhancedMode) {
                    log(`üéØ ENHANCED: Digit ${overdueResult.digit} - ${ticksSinceLast} ticks overdue (${confidence}% conf, ${window.analysisState.overdueIndex} index)`, 'ANALYSIS');
                }
            }
        }
        
        // Enhanced prediction display
        function updatePredictionDisplay() {
            const predictionElem = document.getElementById('currentPrediction');
            const confidenceElem = document.getElementById('predictionConfidence');
            const lastSeenElem = document.getElementById('lastSeen');
            const expectedElem = document.getElementById('expectedAverage');
            
            if (window.analysisState.currentPrediction !== null) {
                const digit = window.analysisState.currentPrediction;
                const stat = window.analysisState.digitStats[digit];
                const ticksSinceLast = stat.lastSeen === -1 ? window.analysisState.ticksAnalyzed : window.analysisState.ticksAnalyzed - stat.lastSeen;
                const expected = Math.floor(window.analysisState.ticksAnalyzed / 10);
                
                predictionElem.textContent = digit;
                
                if (window.analysisState.lockedDigit === digit) {
                    confidenceElem.textContent = `LOCKED üîí (${window.analysisState.lockedDigitTradeCount} trades)`;
                } else {
                    confidenceElem.textContent = `Confidence: ${window.analysisState.predictionConfidence}%`;
                }
                
                lastSeenElem.textContent = `${ticksSinceLast} ticks`;
                expectedElem.textContent = `~${expected} ticks`;
                
                // Enhanced visual feedback
                if (window.analysisState.lockedDigit === digit) {
                    predictionElem.className = 'text-3xl font-bold text-green-400';
                    predictionElem.textContent = `${digit} üîí`;
                    predictionElem.style.textShadow = '0 0 10px rgba(16, 185, 129, 0.7)';
                } else if (window.analysisState.predictionConfidence >= window.analysisConfig.confidenceThreshold) {
                    predictionElem.className = 'text-3xl font-bold text-green-400';
                    predictionElem.style.textShadow = '0 0 5px rgba(16, 185, 129, 0.5)';
                } else if (window.analysisState.predictionConfidence >= 50) {
                    predictionElem.className = 'text-3xl font-bold text-yellow-400';
                    predictionElem.style.textShadow = 'none';
                } else {
                    predictionElem.className = 'text-3xl font-bold text-gray-400';
                    predictionElem.style.textShadow = 'none';
                }
            } else {
                predictionElem.textContent = '-';
                confidenceElem.textContent = 'Confidence: -';
                lastSeenElem.textContent = '-';
                expectedElem.textContent = '-';
                predictionElem.className = 'text-3xl font-bold text-gray-400';
                predictionElem.style.textShadow = 'none';
            }
        }
        
        // Update digit matrix display
        function updateDigitMatrix() {
            const heatLevels = calculateDigitHeatLevels();
            
            for (let i = 0; i < 10; i++) {
                const cell = document.getElementById(`digit-${i}`);
                const heat = heatLevels[i];
                const stat = window.analysisState.digitStats[i];
                
                cell.className = 'digit-cell';
                switch(heat) {
                    case DIGIT_HEAT.HOT:
                        cell.classList.add('digit-hot');
                        break;
                    case DIGIT_HEAT.WARM:
                        cell.classList.add('digit-warm');
                        break;
                    case DIGIT_HEAT.COLD:
                        cell.classList.add('digit-cold');
                        break;
                    case DIGIT_HEAT.OVERDUE:
                        cell.classList.add('digit-overdue');
                        break;
                    case DIGIT_HEAT.EXTREME_COLD:
                        cell.classList.add('digit-extreme-cold');
                        break;
                }
                
                // Enhanced highlighting
                if (window.analysisState.lockedDigit === i) {
                    cell.classList.add('digit-selected');
                    cell.style.animation = 'overduePulse 1s infinite';
                } else if (window.analysisState.currentPrediction === i) {
                    cell.style.border = '2px solid #F59E0B';
                }
                
                const lastSeen = stat.lastSeen === -1 ? 'Never' : `${window.analysisState.ticksAnalyzed - stat.lastSeen} ticks ago`;
                cell.title = `Digit ${i}\nCount: ${stat.count}\nLast seen: ${lastSeen}\nProbability: ${(stat.probability * 100).toFixed(1)}%\nOverdue Score: ${stat.overdueScore.toFixed(1)}`;
            }
        }
        
        // Enhanced analysis initialization
        function initializeAnalysis() {
            window.analysisConfig.windowSize = parseInt(document.getElementById('analysisWindow').value) || 30;
            window.analysisConfig.confidenceThreshold = parseInt(document.getElementById('confidenceThreshold').value) || 65;
            
            window.analysisState = {
                phase: 0,
                ticksAnalyzed: 0,
                digitHistory: [],
                digitStats: Array(10).fill().map(() => ({ 
                    count: 0, 
                    lastSeen: -1, 
                    streak: 0,
                    expectedAverage: 0,
                    overdueScore: 0,
                    probability: 0.1,
                    patternScore: 0,
                    distributionScore: 0
                })),
                patternHistory: [],
                currentPrediction: null,
                predictionConfidence: 0,
                lockedDigit: null,
                lockedDigitStartTime: 0,
                lockedDigitTradeCount: 0,
                currentStreak: 0,
                overdueIndex: 0,
                statisticalBias: 'None',
                patternScore: 0,
                enhancedMode: document.getElementById('enhancedAnalysisToggle').textContent.includes('ON')
            };
            
            initializeDigitMatrix();
            updatePredictionDisplay();
            updateAnalysisProgress();
            
            log('üîÑ Enhanced analysis system initialized', 'ANALYSIS');
        }
        
        // Toggle enhanced analysis
        function toggleEnhancedAnalysis() {
            const toggleBtn = document.getElementById('enhancedAnalysisToggle');
            const analysisContainer = document.getElementById('analysisContainer');
            
            window.analysisConfig.enhancedMode = !window.analysisConfig.enhancedMode;
            
            if (window.analysisConfig.enhancedMode) {
                toggleBtn.textContent = 'üîç Enhanced Analysis: ON';
                toggleBtn.className = 'px-4 py-2 bg-purple-600 text-white font-bold rounded-lg shadow hover:bg-purple-700 transition';
                analysisContainer.classList.add('analysis-enhanced');
                log('üîç Enhanced analysis mode: ON', 'ANALYSIS');
            } else {
                toggleBtn.textContent = 'üîç Enhanced Analysis: OFF';
                toggleBtn.className = 'px-4 py-2 bg-gray-600 text-white font-bold rounded-lg shadow hover:bg-gray-700 transition';
                analysisContainer.classList.remove('analysis-enhanced');
                log('üîç Enhanced analysis mode: OFF', 'ANALYSIS');
            }
        }
        
        // Get predicted digit for trading
        function getPredictedDigit() {
            // Always use locked digit if available
            if (window.analysisState.lockedDigit !== null) {
                return window.analysisState.lockedDigit;
            }
            
            // Enhanced prediction logic
            if (window.analysisState.currentPrediction !== null && 
                window.analysisState.predictionConfidence >= window.analysisConfig.confidenceThreshold &&
                window.analysisState.overdueIndex > 50) {
                return window.analysisState.currentPrediction;
            }
            
            // Default fallback
            return 5;
        }
        
        // Update analysis progress
        function updateAnalysisProgress() {
            const progressElem = document.getElementById('analysisProgress');
            const phaseDescElem = document.getElementById('phaseDescription');
            const phaseProgressElem = document.getElementById('phaseProgress');
            const phaseElem = document.getElementById('analysisPhase');
            const phaseBadge = document.getElementById('phase-badge');
            
            const totalTicks = window.analysisState.ticksAnalyzed;
            let progress = 0;
            let phaseDescription = '';
            let phaseName = '';
            let phaseClass = '';
            
            switch(window.analysisState.phase) {
                case window.analysisConfig.phases.MONITORING:
                    progress = Math.min(100, (totalTicks / window.analysisConfig.minTicksForAnalysis) * 100);
                    phaseDescription = `Collecting data (${totalTicks}/${window.analysisConfig.minTicksForAnalysis} ticks)`;
                    phaseName = 'MONITORING';
                    phaseClass = 'phase-monitoring';
                    if (totalTicks >= window.analysisConfig.minTicksForAnalysis) {
                        window.analysisState.phase = window.analysisConfig.phases.ANALYSIS;
                    }
                    break;
                    
                case window.analysisConfig.phases.ANALYSIS:
                    progress = Math.min(100, 50 + (totalTicks / (window.analysisConfig.windowSize * 1.5)) * 50);
                    phaseDescription = `Analyzing patterns (${totalTicks} ticks)`;
                    phaseName = 'ANALYSIS';
                    phaseClass = 'phase-analysis';
                    if (totalTicks >= window.analysisConfig.windowSize) {
                        window.analysisState.phase = window.analysisConfig.phases.TRADING;
                        log('‚úÖ Enhanced analysis complete! Ready to trade overdue digits', 'ANALYSIS');
                    }
                    break;
                    
                case window.analysisConfig.phases.TRADING:
                    progress = 100;
                    if (window.analysisState.lockedDigit !== null) {
                        phaseDescription = `Trading digit ${window.analysisState.lockedDigit} (${window.analysisState.lockedDigitTradeCount} trades)`;
                    } else {
                        phaseDescription = `Ready to trade overdue digits`;
                    }
                    phaseName = 'TRADING';
                    phaseClass = 'phase-trading';
                    break;
            }
            
            progressElem.style.width = `${progress}%`;
            phaseDescElem.textContent = phaseDescription;
            phaseProgressElem.textContent = `${Math.round(progress)}%`;
            phaseElem.textContent = phaseName;
            phaseBadge.className = `ml-2 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full ${phaseClass} text-white shadow-md`;
            phaseBadge.textContent = `üìä ${phaseName}`;
        }
        
        // ============================================================================
        // CORE BOT FUNCTIONS WITH ENHANCED FEATURES
        // ============================================================================
        
        // Global State
        window.ws = null;
        window.req_id = 0;
        window.isBotRunning = false;
        window.isConnecting = false;
        window.soundEnabled = true;
        window.ToneInitialized = false;
        window.synth = null;
        window.calculatorMinimized = false;
        
        // Trading State
        window.baseStake = 1.0;
        window.currentStake = 1.0;
        window.multiplier = 1.15;
        window.maxTrades = 10;
        window.tradeCount = 0;
        window.martingaleStep = 0;
        window.accountBalance = 0.0;
        window.startingBalance = 0.0;
        window.currentBalance = 0.0;
        window.netProfit = 0.0;
        
        // Enhanced PnL Tracking
        window.pnlTracker = {
            totalInvestment: 0.0,
            totalPayout: 0.0,
            netProfit: 0.0,
            trades: []
        };
        
        // Enhanced PnL Update - Changed to 5 seconds
        window.pnlUpdateInterval = null;
        window.pnlUpdateStartTime = 0;
        window.pnlUpdateDuration = 5000; // Changed from 10000 to 5000 (5 seconds)
        
        // Statistics
        window.stats = {
            totalTicks: 0,
            tradesExecuted: 0,
            wins: 0,
            losses: 0
        };
        
        // Execution State
        window.lastTick = null;
        window.nextTradeAllowed = true;
        window.stopAfterWin = true; // Bot stops immediately on win
        window.pendingProposals = new Map();
        window.executionLock = false;
        
        // Tick Queue
        window.tickQueue = [];
        window.maxQueueSize = 50;
        window.botTickTimestamps = [];
        
        // Tick tracking
        window.totalTicksReceived = 0;
        window.tickTimestamps = [];
        
        // DOM Elements
        const toggleButton = document.getElementById('toggleButton');
        const soundToggleButton = document.getElementById('soundToggle');
        const tradeResultContainer = document.getElementById('trade-result-container');
        const metricPreviousResult = document.getElementById('metricPreviousResult');
        const metricNextAction = document.getElementById('metricNextAction');
        const metricTradeResult = document.getElementById('metricTradeResult');
        const metricTotalProfit = document.getElementById('metricTotalProfit');
        
        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ü§ñ Enhanced Bot initialized');
            initializeToggleState();
            
            initializeAnalysis();
            initializeDigitMatrix();
            
            setInterval(calculateRates, 1000);
            startQueueProcessor();
            
            calculateMartingale();
            
            // Set up event listeners
            document.getElementById('baseStake').addEventListener('change', syncCalculatorWithMain);
            document.getElementById('multiplier').addEventListener('change', syncCalculatorWithMain);
            document.getElementById('maxTrades').addEventListener('change', syncCalculatorWithMain);
            
            document.getElementById('calc_base_stake').addEventListener('change', () => {
                document.getElementById('baseStake').value = document.getElementById('calc_base_stake').value;
                syncCalculatorWithMain();
            });
            document.getElementById('calc_multiplier').addEventListener('change', () => {
                document.getElementById('multiplier').value = document.getElementById('calc_multiplier').value;
                syncCalculatorWithMain();
            });
            document.getElementById('calc_max_trades').addEventListener('change', () => {
                document.getElementById('maxTrades').value = document.getElementById('calc_max_trades').value;
                syncCalculatorWithMain();
            });
            
            document.getElementById('analysisWindow').addEventListener('change', function() {
                window.analysisConfig.windowSize = parseInt(this.value) || 30;
                log(`üìä Analysis window updated to ${window.analysisConfig.windowSize} ticks`, 'SETTINGS');
            });
            
            document.getElementById('confidenceThreshold').addEventListener('change', function() {
                window.analysisConfig.confidenceThreshold = parseInt(this.value) || 65;
                log(`üéØ Confidence threshold updated to ${window.analysisConfig.confidenceThreshold}%`, 'SETTINGS');
            });
            
            log('ü§ñ ENHANCED Smart Overdue Digit Analyzer Ready', 'SYSTEM');
            log('‚ö° Using 1.15x incremental martingale strategy', 'SYSTEM');
            log('üîí Bot will lock onto overdue digit and trade until win', 'SYSTEM');
            log('‚èπÔ∏è Bot stops immediately on win with 5s PnL update', 'SYSTEM');
            
            updatePnL();
            resetTradeStatus();
            
            // Initialize calculator toggle button
            const calculatorToggle = document.getElementById('calculatorToggle');
            if (calculatorToggle) {
                calculatorToggle.textContent = '‚àí';
            }
            
            // Initialize enhanced analysis toggle
            const enhancedToggle = document.getElementById('enhancedAnalysisToggle');
            if (enhancedToggle) {
                enhancedToggle.textContent = 'üîç Enhanced Analysis: ON';
            }
        });
        
        // ============================================================================
        // CALCULATOR MINIMIZE/MAXIMIZE FUNCTION
        // ============================================================================
        
        function toggleCalculator() {
            const calculatorContainer = document.getElementById('calculatorContainer');
            const calculatorContent = document.getElementById('calculatorContent');
            const calculatorToggle = document.getElementById('calculatorToggle');
            
            window.calculatorMinimized = !window.calculatorMinimized;
            
            if (window.calculatorMinimized) {
                calculatorContainer.classList.add('calculator-minimized');
                calculatorContent.style.display = 'none';
                calculatorToggle.textContent = '+';
                calculatorToggle.title = 'Expand calculator';
            } else {
                calculatorContainer.classList.remove('calculator-minimized');
                calculatorContent.style.display = 'block';
                calculatorToggle.textContent = '‚àí';
                calculatorToggle.title = 'Minimize calculator';
            }
        }
        
        // ============================================================================
        // BOT START/STOP FUNCTIONS
        // ============================================================================
        
        // Check for authentication token
        function checkAuthToken() {
            const token = localStorage.getItem('active_token') || localStorage.getItem('derivToken');
            if (!token) {
                log('‚ö†Ô∏è No API token found. Please authenticate first.', 'WARNING');
                alert('No API token found. Please authenticate first.');
                return false;
            }
            return true;
        }
        
        // Initialize account toggle
        function initializeToggleState() {
            const token = localStorage.getItem('active_token');
            const allAccounts = JSON.parse(localStorage.getItem('deriv_accounts')) || [];
            
            if (token && allAccounts.length > 0) {
                const currentAccount = allAccounts.find(acc => acc.token === token);
                if (currentAccount) {
                    const isReal = !currentAccount.account.startsWith('VR');
                    document.getElementById('accTypeToggle').checked = isReal;
                    log(`Account: ${isReal ? 'REAL' : 'DEMO'} (${currentAccount.account})`, 'SYSTEM');
                }
            }
        }
        
        // Switch account
        function switchAccount() {
            const isRealRequested = document.getElementById('accTypeToggle').checked;
            const allAccounts = JSON.parse(localStorage.getItem('deriv_accounts')) || [];
            
            const targetAccount = allAccounts.find(acc => 
                isRealRequested ? !acc.account.startsWith('VR') : acc.account.startsWith('VR')
            );
        
            if (targetAccount) {
                localStorage.setItem('active_token', targetAccount.token);
                log(`Switched to ${isRealRequested ? 'REAL' : 'DEMO'} account`, 'SYSTEM');
                
                if (window.isBotRunning) {
                    stopBot();
                    setTimeout(() => startBot(), 1000);
                }
            } else {
                alert(`No ${isRealRequested ? 'Real' : 'Demo'} account found`);
                document.getElementById('accTypeToggle').checked = !isRealRequested;
            }
        }
        
        // ENHANCED TRADE STATUS UI FUNCTIONS
        function updateTradeStatus(status, result, action, type = 'normal') {
            tradeResultContainer.classList.remove('win-glow', 'trade-status-highlight');
            metricPreviousResult.textContent = result;
            metricNextAction.textContent = action;
            
            switch(type) {
                case 'win':
                    metricTradeResult.textContent = 'WIN üéØ';
                    metricTradeResult.className = 'text-xs font-bold text-green-400';
                    metricPreviousResult.className = 'text-sm font-bold text-green-400';
                    metricNextAction.className = 'text-sm font-bold text-green-300';
                    tradeResultContainer.classList.add('win-glow', 'trade-status-highlight');
                    metricTotalProfit.classList.add('profit-positive');
                    log(`üéØ WIN: ${result}`, 'WIN');
                    break;
                case 'loss':
                    metricTradeResult.textContent = 'LOSS ‚ùå';
                    metricTradeResult.className = 'text-xs font-bold text-red-400';
                    metricPreviousResult.className = 'text-sm font-bold text-red-400';
                    metricNextAction.className = 'text-sm font-bold text-red-300';
                    metricTotalProfit.classList.add('profit-negative');
                    log(`‚ùå LOSS: ${result}`, 'LOSS');
                    break;
                case 'trade':
                    metricTradeResult.textContent = 'TRADING ‚ö°';
                    metricTradeResult.className = 'text-xs font-bold text-yellow-400';
                    metricPreviousResult.className = 'text-sm font-bold text-yellow-400';
                    metricNextAction.className = 'text-sm font-bold text-yellow-300';
                    log(`‚ö° TRADING: ${result}`, 'TRADE');
                    break;
                default:
                    metricTradeResult.textContent = status || 'READY';
                    metricTradeResult.className = 'text-xs font-bold text-gray-400';
                    metricPreviousResult.className = 'text-sm font-bold text-gray-300';
                    metricNextAction.className = 'text-sm font-bold text-yellow-400';
                    break;
            }
        }
        
        function resetTradeStatus() {
            updateTradeStatus('READY', 'Waiting for connection...', 'Start bot to begin', 'normal');
        }
        
        // Update statistics display
        function updateStatistics() {
            document.getElementById('statTotalTrades').textContent = window.stats.tradesExecuted;
            document.getElementById('statWins').textContent = window.stats.wins;
            document.getElementById('statLosses').textContent = window.stats.losses;
            
            const winRate = window.stats.tradesExecuted > 0 ? 
                Math.round((window.stats.wins / window.stats.tradesExecuted) * 100) : 0;
            document.getElementById('statWinRate').textContent = `${winRate}%`;
        }
        
        // ENHANCED PnL UPDATE FUNCTIONS (5 seconds)
        function startExtendedPnlUpdate(payout) {
            window.pnlUpdateStartTime = Date.now();
            
            if (window.pnlUpdateInterval) {
                clearInterval(window.pnlUpdateInterval);
            }
            
            updatePnL();
            
            window.pnlUpdateInterval = setInterval(() => {
                const elapsed = Date.now() - window.pnlUpdateStartTime;
                
                if (elapsed >= window.pnlUpdateDuration) {
                    clearInterval(window.pnlUpdateInterval);
                    window.pnlUpdateInterval = null;
                    log('üí∞ PnL update sequence completed (5 seconds)', 'PNL');
                    
                    updatePnL();
                    
                    // Stop bot after 5 seconds
                    setTimeout(() => {
                        if (window.isBotRunning) {
                            stopBot();
                        }
                    }, 100);
                } else {
                    updatePnL();
                    
                    // Visual feedback every 500ms
                    if (elapsed % 500 < 50) {
                        metricTotalProfit.classList.add('pnl-update-animation');
                        setTimeout(() => {
                            metricTotalProfit.classList.remove('pnl-update-animation');
                        }, 500);
                    }
                    
                    // Log every second
                    if (elapsed % 1000 < 50) {
                        const secondsLeft = Math.ceil((window.pnlUpdateDuration - elapsed) / 1000);
                        log(`üí∞ PnL updating... ${secondsLeft}s`, 'PNL');
                    }
                }
            }, 100);
        }
        
        // ENHANCED PnL UPDATE with bold colors
        function updatePnL() {
            const pnlElem = document.getElementById('metricTotalProfit');
            
            if (window.startingBalance > 0 && window.currentBalance > 0) {
                window.netProfit = window.currentBalance - window.startingBalance;
                const formattedProfit = window.netProfit.toFixed(2);
                
                pnlElem.textContent = `${window.netProfit >= 0 ? '+' : ''}$${formattedProfit}`;
                pnlElem.classList.remove('profit-positive', 'profit-negative', 'profit-neutral');
                
                if (window.netProfit > 0) {
                    pnlElem.classList.add('profit-positive');
                } else if (window.netProfit < 0) {
                    pnlElem.classList.add('profit-negative');
                } else {
                    pnlElem.classList.add('profit-neutral');
                }
                
                return window.netProfit;
            }
            
            if (window.pnlTracker.totalPayout > 0 || window.pnlTracker.totalInvestment > 0) {
                window.netProfit = window.pnlTracker.totalPayout - window.pnlTracker.totalInvestment;
                const formattedProfit = window.netProfit.toFixed(2);
                
                pnlElem.textContent = `${window.netProfit >= 0 ? '+' : ''}$${formattedProfit}`;
                pnlElem.classList.remove('profit-positive', 'profit-negative', 'profit-neutral');
                
                if (window.netProfit > 0) {
                    pnlElem.classList.add('profit-positive');
                } else if (window.netProfit < 0) {
                    pnlElem.classList.add('profit-negative');
                } else {
                    pnlElem.classList.add('profit-neutral');
                }
                
                return window.netProfit;
            }
            
            pnlElem.textContent = '$0.00';
            pnlElem.classList.remove('profit-positive', 'profit-negative');
            pnlElem.classList.add('profit-neutral');
            return 0;
        }
        
        function trackTradeInvestment(amount) {
            window.pnlTracker.totalInvestment += parseFloat(amount);
            window.pnlTracker.trades.push({
                type: 'investment',
                amount: parseFloat(amount),
                timestamp: Date.now()
            });
            updatePnL();
        }
        
        function trackTradePayout(amount) {
            window.pnlTracker.totalPayout += parseFloat(amount);
            window.pnlTracker.trades.push({
                type: 'payout',
                amount: parseFloat(amount),
                timestamp: Date.now()
            });
            updatePnL();
        }
        
        function resetPnL() {
            window.pnlTracker = { totalInvestment: 0.0, totalPayout: 0.0, netProfit: 0.0, trades: [] };
            window.startingBalance = 0.0;
            window.currentBalance = 0.0;
            window.netProfit = 0.0;
            
            if (window.pnlUpdateInterval) {
                clearInterval(window.pnlUpdateInterval);
                window.pnlUpdateInterval = null;
            }
            
            updatePnL();
            log('üí∞ PnL reset', 'PNL');
        }
        
        // ============================================================================
        // MARTINGALE CALCULATOR (1.15x)
        // ============================================================================
        
        function calculateMartingale() {
            try {
                const baseStake = parseFloat(document.getElementById('calc_base_stake').value) || 1.0;
                const multiplier = parseFloat(document.getElementById('calc_multiplier').value) || 1.15;
                const maxTrades = parseInt(document.getElementById('calc_max_trades').value) || 10;
                const bankrollLimit = parseFloat(document.getElementById('calc_bankroll_limit').value) || 50.0;
                
                if (baseStake <= 0 || multiplier <= 1.0 || maxTrades <= 0) {
                    alert('Please enter valid values for calculation.');
                    return;
                }
                
                let currentStake = baseStake;
                let totalRequired = 0;
                let finalStake = baseStake;
                let tradeSequence = [];
                
                for (let i = 1; i <= maxTrades; i++) {
                    if (i === 1) {
                        currentStake = baseStake;
                    } else {
                        currentStake *= multiplier;
                    }
                    
                    currentStake = Math.round(currentStake * 100) / 100;
                    totalRequired += currentStake;
                    finalStake = currentStake;
                    
                    tradeSequence.push({
                        trade: i,
                        stake: currentStake.toFixed(2),
                        cumulative: Math.round(totalRequired * 100) / 100
                    });
                }
                
                totalRequired = Math.round(totalRequired * 100) / 100;
                const profitOnWin = (finalStake * 9) - totalRequired;
                
                // Update main inputs
                document.getElementById('baseStake').value = baseStake.toFixed(2);
                document.getElementById('multiplier').value = multiplier.toFixed(2);
                document.getElementById('maxTrades').value = maxTrades;
                
                // Update display elements
                document.getElementById('calc_total_required').textContent = `$${totalRequired.toFixed(2)}`;
                document.getElementById('calc_final_stake').textContent = `$${finalStake.toFixed(2)}`;
                document.getElementById('calc_profit_on_win').textContent = `$${profitOnWin.toFixed(2)}`;
                
                // Update bankroll status
                const bankrollStatusElem = document.getElementById('calc_bankroll_status');
                bankrollStatusElem.classList.remove('calculator-safe', 'calculator-warning', 'calculator-highlight');
                
                if (totalRequired <= bankrollLimit) {
                    bankrollStatusElem.textContent = '‚úÖ Within Limit';
                    bankrollStatusElem.classList.add('calculator-safe');
                } else if (totalRequired <= bankrollLimit * 1.2) {
                    bankrollStatusElem.textContent = '‚ö†Ô∏è Close to Limit';
                    bankrollStatusElem.classList.add('calculator-warning');
                } else {
                    bankrollStatusElem.textContent = '‚ùå Over Limit';
                    bankrollStatusElem.classList.add('calculator-warning');
                }
                
                // Display trade sequence
                const tradeSequenceElem = document.getElementById('tradeSequence');
                tradeSequenceElem.innerHTML = '';
                
                tradeSequence.forEach(item => {
                    const status = item.cumulative <= bankrollLimit ? '‚úÖ' : '‚ùå';
                    const row = document.createElement('div');
                    row.className = `grid grid-cols-4 gap-1 text-xs py-1 ${item.trade % 2 === 0 ? 'bg-gray-900/30' : ''}`;
                    row.innerHTML = `
                        <div class="text-gray-300">Trade ${item.trade}</div>
                        <div class="text-green-400">$${item.stake}</div>
                        <div class="text-blue-400">$${item.cumulative.toFixed(2)}</div>
                        <div class="${status === '‚úÖ' ? 'text-green-400' : 'text-red-400'} font-bold">${status}</div>
                    `;
                    tradeSequenceElem.appendChild(row);
                });
                
                // Add animation
                document.getElementById('calc_total_required').classList.add('calculator-pulse');
                setTimeout(() => {
                    document.getElementById('calc_total_required').classList.remove('calculator-pulse');
                }, 500);
                
                log(`üßÆ 1.15x Martingale: Total required: $${totalRequired.toFixed(2)} for ${maxTrades} trades`, 'CALCULATOR');
                
            } catch (error) {
                console.error('Calculator error:', error);
                alert('Error in calculation. Please check your inputs.');
            }
        }
        
        function syncCalculatorWithMain() {
            const baseStake = parseFloat(document.getElementById('baseStake').value) || 1.0;
            const multiplier = parseFloat(document.getElementById('multiplier').value) || 1.15;
            const maxTrades = parseInt(document.getElementById('maxTrades').value) || 10;
            
            document.getElementById('calc_base_stake').value = baseStake.toFixed(2);
            document.getElementById('calc_multiplier').value = multiplier.toFixed(2);
            document.getElementById('calc_max_trades').value = maxTrades;
            
            calculateMartingale();
        }
        
        // ============================================================================
        // WEBSOCKET CONNECTION
        // ============================================================================
        
        function connectWebSocket() {
            if (window.ws) {
                try {
                    window.ws.close();
                } catch (e) {}
            }
            
            window.isConnecting = true;
            updateConnectionStatus();
            
            const wsUrl = 'wss://ws.binaryws.com/websockets/v3?app_id=120389';
            log('üîó Connecting to Deriv API...', 'SYSTEM');
            
            window.ws = new WebSocket(wsUrl);
            
            window.ws.onopen = () => {
                window.isConnecting = false;
                log('‚úÖ WebSocket connected', 'SYSTEM');
                updateConnectionStatus();
                
                const token = localStorage.getItem('active_token') || localStorage.getItem('derivToken');
                if (!token) {
                    log('‚ùå No API token found in storage', 'ERROR');
                    stopBot();
                    return;
                }
                
                sendRequest({ 
                    authorize: token, 
                    req_id: getNextReqId() 
                });
            };
            
            window.ws.onmessage = (msg) => {
                try {
                    const data = JSON.parse(msg.data);
                    handleAPIResponse(data);
                } catch (e) {
                    console.error('WebSocket message error:', e);
                }
            };
            
            window.ws.onclose = () => {
                window.isConnecting = false;
                updateConnectionStatus();
                log('üîå WebSocket disconnected', 'SYSTEM');
                
                if (window.isBotRunning) {
                    updateTradeStatus('DISCONNECTED', 'WebSocket disconnected', 'Click START to reconnect', 'normal');
                }
            };
            
            window.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                log('‚ùå WebSocket connection error', 'ERROR');
            };
        }
        
        // Update connection status
        function updateConnectionStatus() {
            const isConnected = window.ws && window.ws.readyState === WebSocket.OPEN;
            const isConnecting = window.isConnecting || false;
            
            if (isConnected) {
                document.getElementById('status-badge').textContent = 'üü¢ CONNECTED';
                document.getElementById('status-badge').className = 'ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full connection-badge-connected text-white shadow-md';
                updateTradeStatus('CONNECTED', 'Market live - Ready to trade', 'Set parameters and start trading', 'normal');
            } else if (isConnecting) {
                document.getElementById('status-badge').textContent = 'üü° CONNECTING';
                document.getElementById('status-badge').className = 'ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full connection-badge-connecting text-white shadow-md';
                updateTradeStatus('CONNECTING', 'Connecting to market...', 'Please wait', 'normal');
            } else {
                document.getElementById('status-badge').textContent = 'üî¥ DISCONNECTED';
                document.getElementById('status-badge').className = 'ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full connection-badge-disconnected text-white shadow-md';
                updateTradeStatus('DISCONNECTED', 'Market offline', 'Start bot to connect', 'normal');
            }
            
            const now = Date.now();
            const recentTicks = window.botTickTimestamps.filter(ts => now - ts < 5000);
            const tickRate = recentTicks.length / 5;
            document.getElementById('metricTickRate').textContent = `Ticks/sec: ${tickRate.toFixed(1)}`;
        }
        
        // TICK HANDLER
        function handleTick(tick) {
            if (!window.isBotRunning) return;
            
            const price = parseFloat(tick.quote);
            const symbol = document.getElementById('symbol').value;
            let decimalPlaces = 3;
            if (symbol === 'R_100') decimalPlaces = 2;
            const formattedPrice = price.toFixed(decimalPlaces);
            const digit = formattedPrice.charAt(formattedPrice.length - 1);
            
            const tickData = { 
                digit: digit, 
                price: price, 
                time: Date.now() 
            };
            
            window.lastTick = tickData;
            
            document.getElementById('metricLiveTick').textContent = price.toFixed(3);
            document.getElementById('metricLastDigit').textContent = `Digit: ${digit}`;
            document.getElementById('metricLiveTick').classList.add('tick-flash');
            setTimeout(() => document.getElementById('metricLiveTick').classList.remove('tick-flash'), 50);
            
            window.stats.totalTicks++;
            window.botTickTimestamps.push(Date.now());
            
            window.totalTicksReceived++;
            window.tickTimestamps.push(Date.now());
            const tenSecondsAgo = Date.now() - 10000;
            window.tickTimestamps = window.tickTimestamps.filter(ts => ts > tenSecondsAgo);
            
            processTickForAnalysis(tick);
            
            addTickToQueue(tickData);
            playAudioFeedback('TICK');
        }
        
        // Add tick to queue
        function addTickToQueue(tick) {
            window.tickQueue.push(tick);
            if (window.tickQueue.length > window.maxQueueSize) {
                window.tickQueue.shift();
            }
            
            return true;
        }
        
        // Check for immediate win
        function checkForImmediateWin(tick) {
            if (!window.isBotRunning || window.stopAfterWin) return false;
            
            const predictedDigit = getPredictedDigit();
            const tickDigit = parseInt(tick.digit);
            
            if (tickDigit === predictedDigit) {
                const confidence = window.analysisState.predictionConfidence;
                log(`üéØ IMMEDIATE WIN! Digit ${tickDigit} matches predicted ${predictedDigit} (${confidence}% confidence)`, 'WIN');
                
                window.lastTradeResult = 'win';
                window.stopAfterWin = true; // Stop immediately on win
                window.stats.wins++;
                window.tradeCount++;
                
                // Increment locked digit trade count if applicable
                if (window.analysisState.lockedDigit === predictedDigit) {
                    window.analysisState.lockedDigitTradeCount++;
                }
                
                playAudioFeedback('WIN');
                
                const payout = window.currentStake * 9;
                trackTradePayout(payout);
                log(`üí∞ Payout: $${payout.toFixed(2)}`, 'PNL');
                
                // Start 5-second PnL update sequence
                startExtendedPnlUpdate(payout);
                
                updateTradeStatus(
                    'IMMEDIATE WIN üéØ',
                    `Digit ${tickDigit} matched! Payout: $${payout.toFixed(2)}`,
                    'PnL updating for 5 seconds...',
                    'win'
                );
                
                updateStake('win');
                updateStatistics();
                return true;
            }
            
            return false;
        }
        
        // Process tick for trading
        function processTickImmediately(tick) {
            if (window.stopAfterWin) return;
            
            // Don't trade if analysis isn't ready yet
            if (window.analysisState.phase < window.analysisConfig.phases.TRADING) {
                return;
            }
            
            if (checkForImmediateWin(tick)) {
                return;
            }
            
            if (window.tradeCount >= window.maxTrades) {
                log(`üõë Max trades reached (${window.maxTrades})`, 'CRITICAL');
                updateTradeStatus('MAX TRADES', `Maximum trades reached (${window.maxTrades})`, 'Bot stopped', 'loss');
                stopBot();
                return;
            }
            
            // Enhanced trading logic
            const predictedDigit = getPredictedDigit();
            const confidence = window.analysisState.predictionConfidence;
            const overdueIndex = window.analysisState.overdueIndex;
            
            // Only trade if conditions are met
            if (window.analysisState.lockedDigit === null && 
                (confidence < window.analysisConfig.confidenceThreshold || overdueIndex < 50)) {
                return;
            }
            
            window.executionLock = true;
            window.nextTradeAllowed = false;
            
            try {
                window.stats.tradesExecuted++;
                window.tradeCount++;
                
                // Increment locked digit trade count
                if (window.analysisState.lockedDigit === predictedDigit) {
                    window.analysisState.lockedDigitTradeCount++;
                }
                
                document.getElementById('metricTradeCount').textContent = window.tradeCount;
                
                log(`‚ö° Trade #${window.tradeCount}: $${window.currentStake.toFixed(2)} on digit ${predictedDigit} (${confidence}% confidence, ${overdueIndex} index)`, 'TRADE');
                
                updateTradeStatus(
                    'TRADING',
                    `Trade #${window.tradeCount}: $${window.currentStake.toFixed(2)} on digit ${predictedDigit}`,
                    'Executing trade...',
                    'trade'
                );
                
                playAudioFeedback('EXECUTION');
                executeTrade(tick);
                
            } catch (error) {
                log(`‚ùå Error: ${error}`, 'ERROR');
                window.executionLock = false;
                window.nextTradeAllowed = true;
                updateTradeStatus('ERROR', `Trade failed: ${error}`, 'Retrying...', 'loss');
            }
        }
        
        // Execute trade
        function executeTrade(tick) {
            const contractType = document.getElementById('contractType').value;
            const symbol = document.getElementById('symbol').value;
            const predictedDigit = getPredictedDigit();
            
            let stake = window.currentStake;
            trackTradeInvestment(stake);
            
            const proposalRequest = {
                proposal: 1,
                amount: stake.toFixed(2),
                basis: "stake",
                contract_type: contractType,
                currency: "USD",
                duration: 1,
                duration_unit: "t",
                symbol: symbol,
                barrier: predictedDigit.toString(),
                req_id: getNextReqId()
            };
            
            window.pendingProposals.set(proposalRequest.req_id, {
                tick: tick,
                stake: stake,
                contractType: contractType,
                predictedDigit: predictedDigit,
                startTime: Date.now(),
                tradeNumber: window.tradeCount,
                martingaleStep: window.martingaleStep,
                isLockedDigit: window.analysisState.lockedDigit === predictedDigit
            });
            
            sendRequest(proposalRequest);
        }
        
        // Update stake function with 1.15x multiplier
        function updateStake(winOrLoss) {
            window.baseStake = parseFloat(document.getElementById('baseStake').value) || 1.0;
            window.multiplier = parseFloat(document.getElementById('multiplier').value) || 1.15;
            window.maxTrades = parseInt(document.getElementById('maxTrades').value) || 10;
            
            if (winOrLoss === 'win') {
                window.martingaleStep = 0;
                window.currentStake = window.baseStake;
                log(`‚úÖ WIN! Reset stake: $${window.currentStake.toFixed(2)}`, 'WIN');
                
                const payout = window.currentStake * 9;
                trackTradePayout(payout);
                log(`üí∞ Payout: $${payout.toFixed(2)}`, 'PNL');
                
                // Unlock digit after win
                if (window.analysisState.lockedDigit !== null) {
                    log(`üîì Unlocking digit ${window.analysisState.lockedDigit} after win`, 'TRADE');
                    window.analysisState.lockedDigit = null;
                    window.analysisState.lockedDigitTradeCount = 0;
                }
                
                // Start 5-second PnL update sequence
                startExtendedPnlUpdate(payout);
                
                updateTradeStatus(
                    'WIN üéØ',
                    `WON! Digit matched - Payout: $${payout.toFixed(2)}`,
                    'PnL updating for 5 seconds...',
                    'win'
                );
                
            } else if (winOrLoss === 'loss') {
                window.martingaleStep++;
                
                if (window.martingaleStep >= window.maxTrades) {
                    log(`üõë MAX TRADES REACHED (${window.maxTrades})`, 'CRITICAL');
                    updateTradeStatus('MAX TRADES', `Maximum trades reached (${window.maxTrades})`, 'Bot stopped', 'loss');
                    stopBot();
                    return;
                }
                
                const newStake = window.currentStake * window.multiplier;
                window.currentStake = parseFloat(newStake.toFixed(2));
                log(`‚ùå LOSS. Next stake: $${window.currentStake.toFixed(2)} (Step: ${window.martingaleStep})`, 'LOSS');
                
                updateTradeStatus(
                    'LOSS ‚ùå',
                    `Lost - Next: $${window.currentStake.toFixed(2)}`,
                    'Increasing stake (1.15x)',
                    'loss'
                );
                
                updatePnL();
                
            } else {
                window.martingaleStep = 0;
                window.currentStake = window.baseStake;
                log(`Starting. Base stake: $${window.currentStake.toFixed(2)}`, 'SYSTEM');
                updateTradeStatus('STARTING', `Base stake: $${window.currentStake.toFixed(2)}`, 'Waiting for trades', 'normal');
            }
            
            const stakeElem = document.getElementById('metricCurrentStake');
            stakeElem.textContent = `$${window.currentStake.toFixed(2)}`;
            stakeElem.className = 'text-lg font-bold text-white';
        }
        
        // ============================================================================
        // MAIN BOT CONTROL FUNCTIONS
        // ============================================================================
        
        // Start bot
        function startBot() {
            if (window.isBotRunning) {
                stopBot();
                return;
            }
            
            // Check for authentication token
            if (!checkAuthToken()) {
                return;
            }
            
            window.maxTrades = parseInt(document.getElementById('maxTrades').value) || 10;
            window.multiplier = parseFloat(document.getElementById('multiplier').value) || 1.15;
            
            resetAllState();
            initializeAnalysis();
            
            window.isBotRunning = true;
            updateButtonState();
            
            log('üöÄ Starting ENHANCED Smart Overdue Digit Analyzer...', 'SYSTEM');
            log(`üìä Will analyze ${window.analysisConfig.windowSize} ticks before trading`, 'SYSTEM');
            log(`üéØ Trading only with ‚â•${window.analysisConfig.confidenceThreshold}% confidence`, 'SYSTEM');
            log(`‚ö° Using 1.15x incremental martingale`, 'SYSTEM');
            log(`üîí Will lock onto digit and trade until win or ${window.maxTrades} trades`, 'SYSTEM');
            log(`‚èπÔ∏è Bot stops immediately on win with 5s PnL update`, 'SYSTEM');
            
            updateTradeStatus('STARTING', 'Initializing enhanced analysis engine...', 'Collecting market data', 'normal');
            updateStake('initial');
            initTone();
            connectWebSocket();
            
            // Disable controls while bot is running
            document.querySelectorAll('#symbol, #contractType, #baseStake, #maxTrades, #multiplier, #analysisWindow, #confidenceThreshold').forEach(control => {
                control.disabled = true;
                control.classList.add('opacity-50', 'cursor-not-allowed');
            });
        }
        
        // Stop bot
        function stopBot() {
            if (!window.isBotRunning) return;
            
            window.isBotRunning = false;
            window.nextTradeAllowed = false;
            window.stopAfterWin = false;
            updateButtonState();
            
            log('‚èπÔ∏è Bot stopped', 'SYSTEM');
            
            if (window.pnlUpdateInterval) {
                clearInterval(window.pnlUpdateInterval);
                window.pnlUpdateInterval = null;
            }
            
            if (window.ws) {
                window.ws.close();
                window.ws = null;
            }
            window.tickSubscriptionSent = false;
            window.pendingProposals.clear();
            window.executionLock = false;
            
            // Unlock any locked digit
            if (window.analysisState.lockedDigit !== null) {
                log(`üîì Unlocking digit ${window.analysisState.lockedDigit}`, 'SYSTEM');
                window.analysisState.lockedDigit = null;
                window.analysisState.lockedDigitTradeCount = 0;
            }
            
            // Re-enable controls
            document.querySelectorAll('#symbol, #contractType, #baseStake, #maxTrades, #multiplier, #analysisWindow, #confidenceThreshold').forEach(control => {
                control.disabled = false;
                control.classList.remove('opacity-50', 'cursor-not-allowed');
            });
            
            updateConnectionStatus();
            
            const finalPnL = updatePnL();
            log(`üí∞ Final PnL: ${finalPnL >= 0 ? '+' : ''}$${finalPnL.toFixed(2)}`, 'PNL');
            
            updateTradeStatus(
                'STOPPED',
                `Final PnL: ${finalPnL >= 0 ? '+' : ''}$${finalPnL.toFixed(2)}`,
                'Bot stopped - Ready for new session',
                finalPnL > 0 ? 'win' : 'normal'
            );
            
            updateStatistics();
        }
        
        // Toggle bot
        function toggleBot() {
            if (window.isBotRunning) {
                stopBot();
            } else {
                startBot();
            }
        }
        
        // ============================================================================
        // HELPER FUNCTIONS
        // ============================================================================
        
        function calculateRates() {
            const now = Date.now();
            window.botTickTimestamps = window.botTickTimestamps.filter(ts => now - ts < 5000);
            const tickRate = window.botTickTimestamps.length / 5;
            document.getElementById('metricTickRate').textContent = `Ticks/sec: ${tickRate.toFixed(1)}`;
        }
        
        function toggleSound() {
            window.soundEnabled = !window.soundEnabled;
            localStorage.setItem('soundEnabled', window.soundEnabled);
            updateSoundButton();
            log(`üîä Sound ${window.soundEnabled ? 'ON' : 'OFF'}`, 'SYSTEM');
        }
        
        function updateSoundButton() {
            if (soundToggleButton) {
                soundToggleButton.textContent = window.soundEnabled ? 'üîä Sound ON' : 'üîá Sound OFF';
                soundToggleButton.className = window.soundEnabled ? 
                    'px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700 transition' :
                    'px-4 py-2 bg-gray-600 text-white font-bold rounded-lg shadow hover:bg-gray-700 transition';
            }
        }
        
        async function initTone() {
            if (!window.soundEnabled) return;
            
            if (typeof Tone === 'undefined') {
                console.error("Tone.js not loaded");
                return;
            }
            
            try {
                await Tone.start();
                window.synth = new Tone.Synth().toDestination();
                window.ToneInitialized = true;
            } catch (e) {
                console.error("Audio init error:", e);
            }
        }
        
        function playAudioFeedback(type) {
            if (!window.soundEnabled || !window.ToneInitialized || !window.synth) return;
            
            try {
                if (type === 'WIN') {
                    window.synth.triggerAttackRelease("C5", "8n");
                    setTimeout(() => window.synth.triggerAttackRelease("E5", "8n"), 100);
                    setTimeout(() => window.synth.triggerAttackRelease("G5", "8n"), 200);
                    setTimeout(() => window.synth.triggerAttackRelease("C6", "8n"), 300);
                } else if (type === 'TICK') {
                    window.synth.triggerAttackRelease("C4", "32n", Tone.now(), 0.3);
                } else if (type === 'EXECUTION') {
                    window.synth.triggerAttackRelease("E5", "16n", Tone.now(), 0.5);
                } else if (type === 'LOSS') {
                    window.synth.triggerAttackRelease("C3", "8n", Tone.now(), 0.5);
                }
            } catch (e) {
                console.error("Audio error:", e);
            }
        }
        
        function log(message, type = 'INFO') {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            let color = 'text-lime-400';
            if (type === 'ERROR') color = 'text-red-500 font-bold'; 
            if (type === 'WARNING') color = 'text-yellow-400';
            if (type === 'TRADE') color = 'text-green-300';
            if (type === 'WIN') color = 'text-green-400 font-bold';
            if (type === 'LOSS') color = 'text-red-400 font-bold';
            if (type === 'TICK') color = 'text-cyan-300';
            if (type === 'SYSTEM') color = 'text-white';
            if (type === 'ANALYSIS') color = 'text-cyan-300 font-bold';
            if (type === 'PNL') color = 'text-purple-300 font-bold';
            if (type === 'SESSION') color = 'text-blue-300 font-bold';
            if (type === 'CALCULATOR') color = 'text-purple-300 font-bold';
            
            logArea.innerHTML += `\n[${timestamp}] <span class="${color}">${message}</span>`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function updateButtonState() {
            if (!toggleButton) return;
            
            if (window.isBotRunning) {
                toggleButton.innerHTML = '<span class="flex items-center justify-center"><span class="mr-2">‚èπÔ∏è</span> STOP BOT</span>';
                toggleButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'start-button-active');
                toggleButton.classList.add('stop-button-active', 'hover:bg-red-700');
            } else {
                toggleButton.innerHTML = '<span class="flex items-center justify-center"><span class="mr-2">üöÄ</span> START BOT</span>';
                toggleButton.classList.remove('stop-button-active', 'hover:bg-red-700');
                toggleButton.classList.add('bg-green-600', 'hover:bg-green-700', 'start-button-active');
            }
        }
        
        // QUEUE PROCESSOR
        function startQueueProcessor() {
            setInterval(() => {
                if (!window.isBotRunning || window.stopAfterWin) return;
                
                while (window.tickQueue.length > 0 && !window.executionLock && window.nextTradeAllowed) {
                    const tick = window.tickQueue.shift();
                    processTickImmediately(tick);
                }
            }, 50);
        }
        
        function sendRequest(request) {
            if (window.ws && window.ws.readyState === WebSocket.OPEN) {
                const message = JSON.stringify(request);
                window.ws.send(message);
                return request.req_id;
            }
            return null;
        }
        
        function getNextReqId() {
            return ++window.req_id;
        }
        
        // API RESPONSE HANDLER
        function handleAPIResponse(data) {
            if (data.error) {
                log(`API Error: ${data.error.message}`, 'ERROR');
                if (data.error.code === 'InvalidToken') {
                    log('‚ùå Invalid API Token. Please check your authentication.', 'CRITICAL');
                    stopBot();
                }
                return;
            }
        
            if (data.msg_type === 'authorize') {
                if (data.authorize) {
                    log(`üîê Authorized as ${data.authorize.loginid}`, 'SYSTEM');
                    subscribeToTicks(document.getElementById('symbol').value);
                    subscribeToBalance();
                }
            } else if (data.msg_type === 'tick') {
                handleTick(data.tick);
            } else if (data.msg_type === 'proposal') {
                handleProposalResponse(data.proposal, data.req_id);
            } else if (data.msg_type === 'buy') {
                handleBuyResponse(data.buy);
            } else if (data.msg_type === 'balance') {
                handleBalanceUpdate(data.balance);
            }
        }
        
        function subscribeToBalance() {
            sendRequest({ balance: 1, subscribe: 1, req_id: getNextReqId() });
            log('üí∞ Subscribed to balance', 'SYSTEM');
        }
        
        function handleBalanceUpdate(balanceData) {
            const newBalance = parseFloat(balanceData.balance);
            
            if (window.startingBalance === 0) {
                window.startingBalance = newBalance;
                log(`üí∞ Starting Balance: $${window.startingBalance.toFixed(2)}`, 'PNL');
            }
            
            window.currentBalance = newBalance;
            const balanceElem = document.getElementById('metricAccountBalance');
            balanceElem.textContent = `$${window.currentBalance.toFixed(2)}`;
            balanceElem.className = 'text-lg font-bold balance-green';
            updatePnL();
        }
        
        function subscribeToTicks(symbol) {
            if (window.tickSubscriptionSent) return;
            
            sendRequest({ ticks: symbol, subscribe: 1, req_id: getNextReqId() });
            window.tickSubscriptionSent = true;
            log(`‚úÖ Subscribed to ${symbol} ticks`, 'SYSTEM');
        }
        
        function handleProposalResponse(proposal, req_id) {
            if (!proposal || !proposal.id) {
                log(`‚ùå Proposal failed`, 'ERROR');
                updateTradeStatus('ERROR', 'Proposal failed', 'Retrying...', 'loss');
                return;
            }
        
            const pending = window.pendingProposals.get(req_id);
            if (!pending) return;
        
            window.pendingProposals.delete(req_id);
            executeBuy(proposal.id, proposal.ask_price, pending);
        }
        
        function executeBuy(proposal_id, ask_price, pending) {
            const buyRequest = {
                buy: proposal_id,
                price: ask_price,
                req_id: getNextReqId()
            };
            
            log(`‚úÖ Buying: $${pending.stake.toFixed(2)} on digit ${pending.predictedDigit}`, 'TRADE');
            
            window.pendingProposals.set(buyRequest.req_id, {
                ...pending,
                proposal_id: proposal_id,
                buyStartTime: Date.now()
            });
            
            sendRequest(buyRequest);
        }
        
        function handleBuyResponse(buyData) {
            if (buyData.contract_id) {
                log(`‚úÖ Trade executed successfully`, 'TRADE');
                
                const wasWin = buyData.longcode && buyData.longcode.includes("win");
                
                updateStake(wasWin ? 'win' : 'loss');
                onTradeComplete(true);
            } else {
                log(`‚ùå Trade failed`, 'ERROR');
                updateTradeStatus('ERROR', 'Trade execution failed', 'Retrying...', 'loss');
                onTradeComplete(false);
            }
        }
        
        function onTradeComplete(isSuccess = true) {
            window.executionLock = false;
            window.nextTradeAllowed = true;
            
            if (!isSuccess) {
                updateStake('loss');
            }
            
            if (window.stopAfterWin) {
                return;
            }
            
            if (window.tradeCount >= window.maxTrades) {
                log(`üõë Max trades reached (${window.maxTrades})`, 'CRITICAL');
                updateTradeStatus('MAX TRADES', `Maximum trades reached (${window.maxTrades})`, 'Bot stopped', 'loss');
                stopBot();
                return;
            }
        }
        
        // Reset all state
        function resetAllState() {
            window.maxTrades = parseInt(document.getElementById('maxTrades').value) || 10;
            window.multiplier = parseFloat(document.getElementById('multiplier').value) || 1.15;
            
            updateStake('initial');
            resetPnL();
            resetTradeStatus();
            
            window.startingBalance = 0.0;
            window.currentBalance = 0.0;
            window.netProfit = 0.0;
            
            document.getElementById('metricTradeCount').textContent = '0';
            document.getElementById('metricAccountBalance').textContent = '$---';
            document.getElementById('metricLiveTick').textContent = '---';
            document.getElementById('metricLastDigit').textContent = 'Digit: ?';
            
            window.stats = { totalTicks: 0, tradesExecuted: 0, wins: 0, losses: 0 };
            window.tickQueue = [];
            window.lastTick = null;
            window.lastTradeResult = null;
            window.tradeCount = 0;
            window.martingaleStep = 0;
            window.pendingProposals.clear();
            window.botTickTimestamps = [];
            
            window.executionLock = false;
            window.waitingForTradeResult = false;
            window.nextTradeAllowed = true;
            window.stopAfterWin = false;
            
            const logArea = document.getElementById('log-area');
            logArea.innerHTML = '[00:00:00] ü§ñ Enhanced Bot reset. Ready.';
            
            log('üîÑ Enhanced bot reset', 'SYSTEM');
            updateStatistics();
        }
    </script>
</body>
</html>
