<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Signal-Based DigitMatch Bot - WIN & STOP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        #log-area::-webkit-scrollbar { width: 4px; }
        #log-area::-webkit-scrollbar-thumb { background: #4ade80; border-radius: 2px; }
        #log-area::-webkit-scrollbar-track { background: #374151; }
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        @keyframes pulse-once { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.03); opacity: 0.9; } 100% { transform: scale(1); opacity: 1; } }
        .tick-flash { animation: pulse-once 0.1s ease-out; }
        @keyframes win-pulse { 
            0% { 
                box-shadow: 0 0 5px #10B981, 0 0 10px rgba(16, 185, 129, 0.5); 
                border-color: #10B981;
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2)) !important;
            } 
            50% { 
                box-shadow: 0 0 30px #10B981, 0 0 50px rgba(16, 185, 129, 0.8); 
                border-color: #34d399;
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.4)) !important;
            } 
            100% { 
                box-shadow: 0 0 5px #10B981, 0 0 10px rgba(16, 185, 129, 0.5); 
                border-color: #10B981;
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2)) !important;
            } 
        }
        .win-glow {
            animation: win-pulse 1s infinite;
        }
        .signal-glow {
            animation: signal-pulse 1s infinite;
        }
        @keyframes signal-pulse {
            0% { box-shadow: 0 0 5px #8b5cf6, 0 0 10px rgba(139, 92, 246, 0.5); }
            50% { box-shadow: 0 0 20px #8b5cf6, 0 0 40px rgba(139, 92, 246, 0.8); }
            100% { box-shadow: 0 0 5px #8b5cf6, 0 0 10px rgba(139, 92, 246, 0.5); }
        }
        .high-signal { color: #10b981 !important; font-weight: bold !important; }
        .medium-signal { color: #f59e0b !important; font-weight: bold !important; }
        .low-signal { color: #ef4444 !important; font-weight: bold !important; }
        .signal-bar { 
            height: 10px; 
            border-radius: 5px; 
            transition: all 0.3s ease;
        }
        .contract-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        .stop-button-active {
            background-color: #dc2626 !important;
            border: 2px solid #fca5a5 !important;
            animation: pulse-once 0.5s infinite;
        }
        .start-button-active {
            background-color: #16a34a !important;
            border: 2px solid #86efac !important;
            animation: pulse-once 0.5s;
        }
        .connection-badge-connected {
            background: linear-gradient(90deg, #10b981, #059669) !important;
        }
        .connection-badge-disconnected {
            background: linear-gradient(90deg, #dc2626, #b91c1c) !important;
        }
        .connection-badge-connecting {
            background: linear-gradient(90deg, #f59e0b, #d97706) !important;
        }
        /* Account Toggle */
        .account-toggle-container {
            display: inline-flex;
            align-items: center;
            margin-left: 15px;
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 10px;
            border-radius: 20px;
        }
        .account-toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
            margin: 0 8px;
        }
        .account-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .account-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #1e40af;
            border-radius: 34px;
            transition: .4s;
        }
        .account-toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: .4s;
        }
        input:checked + .account-toggle-slider {
            background-color: #059669;
        }
        input:checked + .account-toggle-slider:before {
            transform: translateX(22px);
        }
        .account-label {
            font-size: 12px;
            font-weight: 600;
        }
        .account-label-demo {
            color: #3b82f6;
        }
        .account-label-real {
            color: #10b981;
        }
        .profit-positive {
            color: #10b981 !important;
            font-weight: bold !important;
        }
        .profit-negative {
            color: #ef4444 !important;
            font-weight: bold !important;
        }
        .profit-neutral {
            color: #d1d5db !important;
            font-weight: bold !important;
        }
        .status-win {
            color: #10b981 !important;
            font-weight: bold !important;
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        .status-loss {
            color: #ef4444 !important;
            font-weight: bold !important;
        }
        .status-trade {
            color: #f59e0b !important;
            font-weight: bold !important;
        }
        .balance-green {
            color: #10b981 !important;
            font-weight: bold !important;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <div class="w-full max-w-6xl bg-gray-800 text-gray-100 shadow-2xl rounded-xl p-5 md:p-6">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-extrabold text-purple-400 border-b border-gray-700 pb-2">
                Signal-Based DigitMatch Bot 
                <span id="status-badge" class="ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full connection-badge-disconnected text-white shadow-md">
                    üî¥ DISCONNECTED
                </span>
                <span id="contract-type-badge" class="contract-type-badge bg-purple-600 text-white">DIGITMATCH</span>
                <span id="signal-mode-badge" class="contract-type-badge bg-green-600 text-white">SIGNAL MODE</span>
                <!-- Account toggle -->
                <div class="account-toggle-container ml-3">
                    <span class="account-label account-label-demo">DEMO</span>
                    <label class="account-toggle">
                        <input type="checkbox" id="accTypeToggle" onchange="switchAccount()">
                        <span class="account-toggle-slider"></span>
                    </label>
                    <span class="account-label account-label-real">REAL</span>
                </div>
            </h1>
            <div class="flex items-center space-x-2">
                <button id="soundToggle" onclick="toggleSound()" 
                    class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700 transition">
                    üîä Sound ON
                </button>
            </div>
        </div>
        
        <!-- SIGNAL ANALYSIS ENGINE -->
        <div class="mb-6 p-4 bg-gray-900 rounded-xl border border-purple-500/50 shadow-lg">
            <h2 class="text-lg font-bold text-purple-400 mb-3 pb-2 border-b border-gray-700 flex items-center">
                üß† SIGNAL ANALYSIS ENGINE
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <!-- Signal Status -->
                <div class="space-y-3">
                    <div class="p-3 bg-gray-800 rounded-lg border border-green-500/30">
                        <h3 class="text-sm font-bold text-green-300 mb-2">Current Signal</h3>
                        <div class="text-center mb-3">
                            <div id="signalStrength" class="text-3xl font-bold high-signal">--</div>
                            <div id="signalLabel" class="text-xs text-gray-400 mt-1">Analyzing...</div>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-3 mb-2">
                            <div id="signalBar" class="signal-bar bg-green-500 h-3 rounded-full" style="width: 0%"></div>
                        </div>
                        <div class="text-xs text-gray-400 text-center">
                            Confidence: <span id="signalConfidence">0%</span>
                        </div>
                    </div>
                    
                    <div class="p-3 bg-gray-800 rounded-lg border border-blue-500/30">
                        <h3 class="text-sm font-bold text-blue-300 mb-2">Signal History</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-400">Total Signals:</span>
                                <span id="totalSignals" class="font-bold text-white">0</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-400">Strong Signals:</span>
                                <span id="strongSignals" class="font-bold text-green-400">0</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-400">Last Signal:</span>
                                <span id="lastSignalTime" class="font-bold text-yellow-400">--</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Signal Details -->
                <div class="space-y-3">
                    <div class="p-3 bg-gray-800 rounded-lg border border-cyan-500/30">
                        <h3 class="text-sm font-bold text-cyan-300 mb-2">Predicted Digit</h3>
                        <div class="text-center mb-3">
                            <div id="predictedDigitDisplay" class="text-4xl font-bold text-white bg-purple-600 rounded-full w-20 h-20 mx-auto flex items-center justify-center">?</div>
                            <div class="text-xs text-gray-400 mt-2" id="digitSource">Based on signal analysis</div>
                        </div>
                    </div>
                    
                    <div class="p-3 bg-gray-800 rounded-lg border border-yellow-500/30">
                        <h3 class="text-sm font-bold text-yellow-300 mb-2">Signal Components</h3>
                        <div class="space-y-2">
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-gray-400">Pattern Recognition:</span>
                                    <span id="patternScore" class="font-bold text-green-400">0%</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2">
                                    <div id="patternBar" class="signal-bar bg-green-500 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-gray-400">Frequency Analysis:</span>
                                    <span id="frequencyScore" class="font-bold text-blue-400">0%</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2">
                                    <div id="frequencyBar" class="signal-bar bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-gray-400">Trend Analysis:</span>
                                    <span id="trendScore" class="font-bold text-purple-400">0%</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2">
                                    <div id="trendBar" class="signal-bar bg-purple-500 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Trading Stats -->
                <div class="space-y-3">
                    <div class="p-3 bg-gray-800 rounded-lg border border-red-500/30">
                        <h3 class="text-sm font-bold text-red-300 mb-2">Trading Stats</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="text-center p-2 bg-gray-900 rounded">
                                <div class="text-xs text-gray-400">Total Trades</div>
                                <div id="totalTrades" class="text-lg font-bold text-white">0</div>
                            </div>
                            <div class="text-center p-2 bg-gray-900 rounded">
                                <div class="text-xs text-gray-400">Wins</div>
                                <div id="totalWins" class="text-lg font-bold text-green-400">0</div>
                            </div>
                            <div class="text-center p-2 bg-gray-900 rounded">
                                <div class="text-xs text-gray-400">Win Rate</div>
                                <div id="winRate" class="text-lg font-bold text-blue-400">0%</div>
                            </div>
                            <div class="text-center p-2 bg-gray-900 rounded">
                                <div class="text-xs text-gray-400">Avg. Signal</div>
                                <div id="avgSignal" class="text-lg font-bold text-purple-400">0%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-3 bg-gray-800 rounded-lg border border-green-500/30">
                        <h3 class="text-sm font-bold text-green-300 mb-2">Execution Rules</h3>
                        <div class="space-y-2 text-xs">
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                <span>Execute only on STRONG signals (>85%)</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                <span>Stop bot immediately after win</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                <span>Wait for 5 ticks minimum between trades</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-3 bg-gray-800 rounded-lg border border-gray-600">
                        <h3 class="text-sm font-bold text-gray-300 mb-2">Market Status</h3>
                        <div class="space-y-1 text-xs">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Symbol:</span>
                                <span id="current_symbol" class="font-bold text-cyan-400">V. 10 Index</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Ticks Received:</span>
                                <span id="ticks_received" class="font-bold text-green-400">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Tick Rate:</span>
                                <span id="current_tick_rate" class="font-bold text-blue-400">0/s</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- LEFT COLUMN: SIGNAL SETTINGS -->
            <div class="lg:col-span-1">
                <div class="bg-gray-900 border border-gray-700 rounded-xl p-4 shadow-lg">
                    <h2 class="text-lg font-bold text-cyan-400 mb-4 pb-2 border-b border-gray-700">
                        ‚öôÔ∏è SIGNAL SETTINGS
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-2">Signal Threshold</label>
                            <div class="flex items-center gap-2">
                                <input type="range" id="signalThreshold" min="70" max="95" value="85" step="1" 
                                    class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                <span id="thresholdValue" class="text-sm font-bold text-green-400 w-12">85%</span>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Minimum signal strength to execute trade</p>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-2">Analysis Window</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="analysisWindow" value="25" min="10" max="100" 
                                    class="flex-1 rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-cyan-500 focus:ring-cyan-500 py-1.5 px-2 text-sm">
                                <button onclick="updateAnalysisWindow()" 
                                    class="px-3 py-1.5 bg-cyan-600 text-white font-bold rounded-md hover:bg-cyan-700 transition text-sm">
                                    Update
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Number of ticks to analyze for patterns</p>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-2">Minimum Ticks Between Trades</label>
                            <input type="number" id="minTicksBetween" value="5" min="1" max="50" 
                                class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm">
                            <p class="text-xs text-gray-400 mt-1">Wait X ticks before analyzing for next trade</p>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-2">Maximum Trades Per Session</label>
                            <input type="number" id="maxTradesPerSession" value="1" min="1" max="10" 
                                class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-red-500 focus:ring-red-500 py-1.5 px-2 text-sm">
                            <p class="text-xs text-gray-400 mt-1">Stop after X trades (win or loss)</p>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-700">
                            <h3 class="text-sm font-bold text-yellow-300 mb-2">Signal Weights</h3>
                            <div class="space-y-2">
                                <div>
                                    <div class="flex justify-between text-xs mb-1">
                                        <span class="text-gray-300">Pattern Recognition:</span>
                                        <span id="patternWeight" class="font-bold text-green-400">40%</span>
                                    </div>
                                    <input type="range" id="patternWeightSlider" min="10" max="60" value="40" step="5" 
                                        class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs mb-1">
                                        <span class="text-gray-300">Frequency Analysis:</span>
                                        <span id="frequencyWeight" class="font-bold text-blue-400">35%</span>
                                    </div>
                                    <input type="range" id="frequencyWeightSlider" min="10" max="60" value="35" step="5" 
                                        class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs mb-1">
                                        <span class="text-gray-300">Trend Analysis:</span>
                                        <span id="trendWeight" class="font-bold text-purple-400">25%</span>
                                    </div>
                                    <input type="range" id="trendWeightSlider" min="10" max="60" value="25" step="5" 
                                        class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- MIDDLE COLUMN: MAIN CONTROLS -->
            <div class="lg:col-span-2">
                <!-- TRADING CONTROLS -->
                <div class="mb-6 p-4 bg-gray-900 rounded-xl border border-green-500/50 shadow-lg">
                    <h2 class="text-lg font-bold text-green-400 mb-3 pb-2 border-b border-gray-700">
                        üí∞ TRADING CONTROLS
                    </h2>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <!-- Symbol -->
                        <div>
                            <label for="symbol" class="block text-xs font-semibold text-gray-300 mb-1">Symbol</label>
                            <select id="symbol" class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                                <option value="R_10">V. 10 Index</option>
                                <option value="R_100">V. 100 Index</option>
                                <option value="R_25">V. 25 Index</option>
                                <option value="R_50">V. 50 Index</option>
                                <option value="R_75">V. 75 Index</option>
                            </select>
                        </div>

                        <!-- Contract Type -->
                        <div>
                            <label for="contractType" class="block text-xs font-semibold text-gray-300 mb-1">Contract Type</label>
                            <select id="contractType" class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                                <option value="DIGITMATCH">DIGITMATCH</option>
                                <option value="DIGITDIFF">DIGITDIFF</option>
                            </select>
                        </div>

                        <!-- Stake Amount -->
                        <div>
                            <label for="stakeAmount" class="block text-xs font-semibold text-gray-300 mb-1">Stake Amount</label>
                            <input type="number" id="stakeAmount" value="1.0" min="0.1" step="0.1" 
                                class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                        </div>

                        <!-- Manual Override -->
                        <div>
                            <label for="manualDigit" class="block text-xs font-semibold text-gray-300 mb-1">Manual Digit (Optional)</label>
                            <input type="number" id="manualDigit" min="0" max="9" 
                                class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-yellow-500 focus:ring-yellow-500 py-1.5 px-2 text-sm" placeholder="0-9">
                        </div>
                    </div>
                    
                    <!-- Signal-Based Trading Status -->
                    <div class="p-4 bg-gray-800 rounded-lg border border-blue-500/30 mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-sm font-bold text-blue-300">Trading Status</h3>
                            <div id="tradeStatusBadge" class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full">
                                WAITING FOR SIGNAL
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-400">Next Trade Allowed:</span>
                                <span id="nextTradeTime" class="font-bold text-green-400">Ready</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-400">Current Session:</span>
                                <span id="sessionStatus" class="font-bold text-yellow-400">Inactive</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-400">Last Signal Age:</span>
                                <span id="lastSignalAge" class="font-bold text-cyan-400">--</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- START/STOP BUTTON -->
                    <div class="flex justify-center">
                        <button id="toggleButton" onclick="toggleBot()" 
                            class="w-full px-6 py-3 bg-green-600 text-white font-bold text-lg rounded-lg shadow-xl hover:bg-green-700 transition duration-150 flex items-center justify-center">
                            <span class="mr-2">üöÄ</span> START SIGNAL BOT
                        </button>
                    </div>
                </div>
                
                <!-- LIVE METRICS -->
                <div class="grid grid-cols-4 gap-3 mb-4">
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner border border-green-500/50">
                        <p class="text-[10px] font-semibold text-green-500 uppercase">Current Tick</p>
                        <p id="metricLiveTick" class="text-xl font-extrabold text-white">---</p>
                        <p id="metricLastDigit" class="text-sm font-bold text-green-300">Digit: ?</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner border border-blue-500/50">
                        <p class="text-[10px] font-semibold text-blue-500 uppercase">Balance</p>
                        <p id="metricAccountBalance" class="text-lg font-bold balance-green">$---</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner border border-purple-500/50">
                        <p class="text-[10px] font-semibold text-purple-500 uppercase">P/L</p>
                        <p id="metricTotalProfit" class="text-lg font-bold profit-neutral">$0.00</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner border border-yellow-500/50">
                        <p class="text-[10px] font-semibold text-yellow-500 uppercase">Stake</p>
                        <p id="metricCurrentStake" class="text-lg font-bold text-white">$0.00</p>
                    </div>
                </div>
                
                <!-- TRADE EXECUTION LOG -->
                <div class="bg-gray-900 rounded-xl p-4 border border-yellow-500/30 shadow-lg">
                    <h2 class="text-lg font-bold text-yellow-400 mb-3 pb-2 border-b border-gray-700">
                        üìä TRADE EXECUTION LOG
                    </h2>
                    
                    <div id="tradeLog" class="space-y-2 max-h-60 overflow-y-auto">
                        <div class="text-xs text-gray-500 italic">No trades executed yet. Waiting for strong signals...</div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-700">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-xs font-semibold text-gray-300">Last Action:</p>
                                <p id="lastAction" class="text-sm font-bold text-gray-400">Idle</p>
                            </div>
                            <div>
                                <p class="text-xs font-semibold text-gray-300">Next Check:</p>
                                <p id="nextCheck" class="text-sm font-bold text-green-400">--</p>
                            </div>
                            <button onclick="clearTradeLog()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-xs rounded transition">
                                Clear Log
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LOG AREA -->
        <div id="log-column" class="w-full flex flex-col mt-6">
            <h2 class="text-lg font-bold text-gray-300 mb-2 border-b border-gray-700 pb-1">Signal Analysis Log</h2>
            <div id="log-area" class="flex-grow h-64 bg-gray-900 text-lime-400 p-2.5 rounded-lg overflow-y-scroll text-xs whitespace-pre-wrap shadow-inner">
[00:00:00] ü§ñ Signal-Based DigitMatch Bot Initialized
[00:00:00] üß† Signal analysis engine ready
[00:00:00] ‚ö° Waiting for market connection...
[00:00:00] üìä Signal threshold: 85% (STRONG required)
[00:00:00] üéØ Bot will stop automatically after win
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // SIGNAL ANALYSIS BOT
        // ============================================================================
        
        // Global State
        window.ws = null;
        window.req_id = 0;
        window.isBotRunning = false;
        window.isConnecting = false;
        window.soundEnabled = true;
        window.ToneInitialized = false;
        window.synth = null;
        
        // Trading State
        window.stakeAmount = 1.0;
        window.accountBalance = 0.0;
        window.startingBalance = 0.0;
        window.currentBalance = 0.0;
        window.netProfit = 0.0;
        
        // PnL Tracking
        window.pnlTracker = {
            totalInvestment: 0.0,
            totalPayout: 0.0,
            netProfit: 0.0,
            trades: []
        };
        
        // Signal Analysis State
        window.signalState = {
            lastTick: null,
            tickHistory: [],
            maxHistorySize: 100,
            analysisWindow: 25,
            signalThreshold: 85,
            minTicksBetweenTrades: 5,
            maxTradesPerSession: 1,
            ticksSinceLastTrade: 0,
            lastTradeTime: 0,
            totalTrades: 0,
            totalWins: 0,
            sessionActive: false,
            waitingForSignal: true,
            signalWeights: {
                pattern: 40,
                frequency: 35,
                trend: 25
            },
            // Statistics
            totalSignals: 0,
            strongSignals: 0,
            signalHistory: [],
            currentSignal: null,
            lastSignalTime: 0,
            // Execution lock
            executionLock: false,
            pendingProposals: new Map(),
            stopAfterWin: true, // Always stop after win
            stopAfterTrade: false
        };
        
        // Statistics
        window.stats = {
            totalTicks: 0,
            tradesExecuted: 0,
            wins: 0,
            losses: 0
        };
        
        // Rate tracking
        window.botTickTimestamps = [];
        window.tickTimestamps = [];
        window.totalTicksReceived = 0;
        window.lastTickTime = 0;
        
        // DOM Elements
        const toggleButton = document.getElementById('toggleButton');
        const soundToggleButton = document.getElementById('soundToggle');
        const tradeLog = document.getElementById('tradeLog');
        
        // ============================================================================
        // SIGNAL ANALYSIS ENGINE
        // ============================================================================
        
        // Process tick for signal analysis
        function processTickForSignalAnalysis(tick) {
            try {
                const price = parseFloat(tick.quote);
                const symbol = document.getElementById('symbol').value;
                let decimalPlaces = 3;
                if (symbol === 'R_100') decimalPlaces = 2;
                const formattedPrice = price.toFixed(decimalPlaces);
                const digit = parseInt(formattedPrice.charAt(formattedPrice.length - 1), 10);
                
                if (isNaN(digit) || digit < 0 || digit > 9) return;
                
                // Update tick statistics
                window.totalTicksReceived++;
                window.lastTickTime = Date.now();
                window.tickTimestamps.push(window.lastTickTime);
                
                // Keep only recent timestamps (10 seconds)
                const tenSecondsAgo = Date.now() - 10000;
                window.tickTimestamps = window.tickTimestamps.filter(ts => ts > tenSecondsAgo);
                
                // Update metrics
                document.getElementById('metricLiveTick').textContent = price.toFixed(3);
                document.getElementById('metricLastDigit').textContent = `Digit: ${digit}`;
                document.getElementById('metricLiveTick').classList.add('tick-flash');
                setTimeout(() => document.getElementById('metricLiveTick').classList.remove('tick-flash'), 50);
                
                document.getElementById('ticks_received').textContent = window.totalTicksReceived;
                
                // Calculate tick rate
                const now = Date.now();
                const recentTicks = window.tickTimestamps.filter(ts => now - ts < 5000);
                const tickRate = recentTicks.length / 5;
                document.getElementById('current_tick_rate').textContent = tickRate.toFixed(1) + '/s';
                
                // Add to history
                const tickData = {
                    digit: digit,
                    price: price,
                    timestamp: window.lastTickTime,
                    formattedPrice: formattedPrice
                };
                
                window.signalState.lastTick = tickData;
                window.signalState.tickHistory.push(tickData);
                
                // Keep history size limited
                if (window.signalState.tickHistory.length > window.signalState.maxHistorySize) {
                    window.signalState.tickHistory.shift();
                }
                
                // Update ticks since last trade
                if (window.signalState.ticksSinceLastTrade < 1000) { // Prevent overflow
                    window.signalState.ticksSinceLastTrade++;
                }
                
                document.getElementById('nextTradeTime').textContent = 
                    window.signalState.ticksSinceLastTrade >= window.signalState.minTicksBetweenTrades ? 
                    'Ready' : 
                    `${window.signalState.minTicksBetweenTrades - window.signalState.ticksSinceLastTrade} ticks`;
                
                // Update last signal age
                if (window.signalState.lastSignalTime > 0) {
                    const ageSeconds = Math.floor((Date.now() - window.signalState.lastSignalTime) / 1000);
                    document.getElementById('lastSignalAge').textContent = `${ageSeconds}s ago`;
                }
                
                // Only analyze if we have enough data and bot is running
                if (window.isBotRunning && 
                    window.signalState.tickHistory.length >= window.signalState.analysisWindow &&
                    window.signalState.ticksSinceLastTrade >= window.signalState.minTicksBetweenTrades &&
                    !window.signalState.executionLock &&
                    !window.signalState.stopAfterTrade) {
                    
                    analyzeSignal();
                }
                
                // Log first few ticks
                if (window.totalTicksReceived <= 3) {
                    log(`üìä Tick #${window.totalTicksReceived}: ${price.toFixed(3)} (Digit ${digit})`, 'TICK');
                }
                
            } catch (error) {
                console.error('Tick processing error:', error);
                log(`‚ùå Tick processing error: ${error.message}`, 'ERROR');
            }
        }
        
        // Analyze signal from tick history
        function analyzeSignal() {
            if (window.signalState.tickHistory.length < window.signalState.analysisWindow) {
                return;
            }
            
            try {
                // Get recent digits for analysis
                const recentDigits = window.signalState.tickHistory
                    .slice(-window.signalState.analysisWindow)
                    .map(t => t.digit);
                
                // 1. Pattern Recognition Score (40%)
                const patternScore = calculatePatternScore(recentDigits);
                document.getElementById('patternScore').textContent = `${patternScore}%`;
                document.getElementById('patternBar').style.width = `${patternScore}%`;
                
                // 2. Frequency Analysis Score (35%)
                const frequencyScore = calculateFrequencyScore(recentDigits);
                document.getElementById('frequencyScore').textContent = `${frequencyScore}%`;
                document.getElementById('frequencyBar').style.width = `${frequencyScore}%`;
                
                // 3. Trend Analysis Score (25%)
                const trendScore = calculateTrendScore(recentDigits);
                document.getElementById('trendScore').textContent = `${trendScore}%`;
                document.getElementById('trendBar').style.width = `${trendScore}%`;
                
                // Calculate overall signal strength
                const totalSignal = Math.round(
                    (patternScore * window.signalState.signalWeights.pattern / 100) +
                    (frequencyScore * window.signalState.signalWeights.frequency / 100) +
                    (trendScore * window.signalState.signalWeights.trend / 100)
                );
                
                // Get predicted digit
                const predictedDigit = predictDigit(recentDigits, totalSignal);
                
                // Update signal state
                window.signalState.currentSignal = {
                    strength: totalSignal,
                    predictedDigit: predictedDigit,
                    patternScore: patternScore,
                    frequencyScore: frequencyScore,
                    trendScore: trendScore,
                    timestamp: Date.now()
                };
                
                window.signalState.totalSignals++;
                window.signalState.lastSignalTime = Date.now();
                window.signalState.signalHistory.push({...window.signalState.currentSignal});
                
                // Keep only last 100 signals
                if (window.signalState.signalHistory.length > 100) {
                    window.signalState.signalHistory.shift();
                }
                
                // Update UI
                updateSignalDisplay(totalSignal, predictedDigit);
                
                // Check if signal is strong enough to trade
                if (totalSignal >= window.signalState.signalThreshold) {
                    window.signalState.strongSignals++;
                    document.getElementById('strongSignals').textContent = window.signalState.strongSignals;
                    
                    log(`üéØ STRONG SIGNAL DETECTED! Strength: ${totalSignal}%, Digit: ${predictedDigit}`, 'SIGNAL');
                    
                    // Execute trade if conditions are met
                    if (window.isBotRunning && 
                        window.signalState.ticksSinceLastTrade >= window.signalState.minTicksBetweenTrades &&
                        !window.signalState.executionLock &&
                        !window.signalState.stopAfterTrade) {
                        
                        executeSignalTrade(predictedDigit, totalSignal);
                    }
                } else if (totalSignal >= 70) {
                    log(`üìà Medium Signal: ${totalSignal}%, Digit: ${predictedDigit}`, 'SIGNAL');
                } else {
                    // Only log low signals occasionally to avoid spam
                    if (Math.random() < 0.1) { // 10% chance to log
                        log(`üìâ Low Signal: ${totalSignal}%, Digit: ${predictedDigit}`, 'SIGNAL');
                    }
                }
                
                document.getElementById('totalSignals').textContent = window.signalState.totalSignals;
                document.getElementById('lastSignalTime').textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Update average signal
                if (window.signalState.signalHistory.length > 0) {
                    const avgSignal = Math.round(
                        window.signalState.signalHistory.reduce((sum, sig) => sum + sig.strength, 0) / 
                        window.signalState.signalHistory.length
                    );
                    document.getElementById('avgSignal').textContent = `${avgSignal}%`;
                }
                
            } catch (error) {
                console.error('Signal analysis error:', error);
                log(`‚ùå Signal analysis error: ${error.message}`, 'ERROR');
            }
        }
        
        // Calculate pattern recognition score
        function calculatePatternScore(digits) {
            if (digits.length < 5) return 50;
            
            // Look for repeating patterns
            let patternScore = 50; // Base score
            
            // Check for sequences
            let sequences = 0;
            for (let i = 0; i < digits.length - 2; i++) {
                if (digits[i] + 1 === digits[i + 1] && digits[i + 1] + 1 === digits[i + 2]) {
                    sequences++;
                }
                if (digits[i] - 1 === digits[i + 1] && digits[i + 1] - 1 === digits[i + 2]) {
                    sequences++;
                }
            }
            
            patternScore += Math.min(sequences * 5, 30);
            
            // Check for alternation patterns
            let alternations = 0;
            for (let i = 0; i < digits.length - 2; i++) {
                if (digits[i] === digits[i + 2] && digits[i] !== digits[i + 1]) {
                    alternations++;
                }
            }
            
            patternScore += Math.min(alternations * 3, 20);
            
            return Math.min(Math.max(patternScore, 0), 100);
        }
        
        // Calculate frequency analysis score
        function calculateFrequencyScore(digits) {
            if (digits.length < 10) return 50;
            
            const freq = Array(10).fill(0);
            digits.forEach(d => {
                if (d >= 0 && d <= 9) freq[d]++;
            });
            
            // Find least frequent digits (higher probability of appearing next)
            const totalDigits = digits.length;
            const avgFrequency = totalDigits / 10;
            
            let score = 50;
            let missingCount = 0;
            
            for (let i = 0; i < 10; i++) {
                if (freq[i] === 0) missingCount++;
            }
            
            // More missing digits = higher confidence
            score += missingCount * 5;
            
            // Check frequency distribution
            const variance = freq.reduce((sum, f) => sum + Math.pow(f - avgFrequency, 2), 0) / 10;
            score += Math.max(0, 30 - variance * 2);
            
            return Math.min(Math.max(Math.round(score), 0), 100);
        }
        
        // Calculate trend analysis score
        function calculateTrendScore(digits) {
            if (digits.length < 15) return 50;
            
            // Analyze trends in digit movements
            let trendScore = 50;
            
            // Calculate digit average movement
            let totalMovement = 0;
            for (let i = 1; i < digits.length; i++) {
                totalMovement += Math.abs(digits[i] - digits[i - 1]);
            }
            const avgMovement = totalMovement / (digits.length - 1);
            
            // Low movement = higher confidence in current trends
            if (avgMovement < 2) {
                trendScore += 20;
            } else if (avgMovement < 4) {
                trendScore += 10;
            }
            
            // Check for convergence (digits getting closer to a range)
            const recentDigits = digits.slice(-10);
            const minDigit = Math.min(...recentDigits);
            const maxDigit = Math.max(...recentDigits);
            const range = maxDigit - minDigit;
            
            if (range < 5) {
                trendScore += 15;
            } else if (range < 7) {
                trendScore += 8;
            }
            
            return Math.min(Math.max(trendScore, 0), 100);
        }
        
        // Predict next digit based on analysis
        function predictDigit(recentDigits, signalStrength) {
            const freq = Array(10).fill(0);
            recentDigits.forEach(d => {
                if (d >= 0 && d <= 9) freq[d]++;
            });
            
            // Strategy 1: Missing digits (most reliable)
            const missingDigits = [];
            for (let i = 0; i < 10; i++) {
                if (freq[i] === 0) missingDigits.push(i);
            }
            
            if (missingDigits.length > 0 && signalStrength > 70) {
                // Choose random missing digit
                return missingDigits[Math.floor(Math.random() * missingDigits.length)];
            }
            
            // Strategy 2: Least frequent digits
            let leastFrequent = [];
            let minFreq = Infinity;
            for (let i = 0; i < 10; i++) {
                if (freq[i] < minFreq) {
                    minFreq = freq[i];
                    leastFrequent = [i];
                } else if (freq[i] === minFreq) {
                    leastFrequent.push(i);
                }
            }
            
            if (leastFrequent.length > 0 && signalStrength > 60) {
                return leastFrequent[Math.floor(Math.random() * leastFrequent.length)];
            }
            
            // Strategy 3: Analyze recent patterns
            if (recentDigits.length >= 3) {
                const lastThree = recentDigits.slice(-3);
                
                // Check for simple patterns
                if (lastThree[0] === lastThree[1]) {
                    // If two same, predict different
                    let candidate;
                    do {
                        candidate = Math.floor(Math.random() * 10);
                    } while (candidate === lastThree[0]);
                    return candidate;
                }
                
                // Check for alternation
                if (lastThree[0] === lastThree[2] && lastThree[0] !== lastThree[1]) {
                    return lastThree[1]; // Continue alternation
                }
            }
            
            // Fallback: Choose digit opposite to last digit
            const lastDigit = recentDigits[recentDigits.length - 1];
            return (lastDigit + 5) % 10;
        }
        
        // Update signal display
        function updateSignalDisplay(signalStrength, predictedDigit) {
            const signalElem = document.getElementById('signalStrength');
            const labelElem = document.getElementById('signalLabel');
            const barElem = document.getElementById('signalBar');
            const confidenceElem = document.getElementById('signalConfidence');
            const digitElem = document.getElementById('predictedDigitDisplay');
            
            signalElem.textContent = `${signalStrength}%`;
            confidenceElem.textContent = `${signalStrength}%`;
            
            // Update signal bar and color
            barElem.style.width = `${signalStrength}%`;
            
            if (signalStrength >= 85) {
                signalElem.className = 'text-3xl font-bold high-signal';
                labelElem.textContent = 'STRONG SIGNAL üéØ';
                labelElem.className = 'text-xs text-green-400 mt-1';
                barElem.className = 'signal-bar bg-green-500 h-3 rounded-full';
                digitElem.classList.add('signal-glow');
            } else if (signalStrength >= 70) {
                signalElem.className = 'text-3xl font-bold medium-signal';
                labelElem.textContent = 'MEDIUM SIGNAL üìà';
                labelElem.className = 'text-xs text-yellow-400 mt-1';
                barElem.className = 'signal-bar bg-yellow-500 h-3 rounded-full';
                digitElem.classList.remove('signal-glow');
            } else {
                signalElem.className = 'text-3xl font-bold low-signal';
                labelElem.textContent = 'WEAK SIGNAL üìâ';
                labelElem.className = 'text-xs text-red-400 mt-1';
                barElem.className = 'signal-bar bg-red-500 h-3 rounded-full';
                digitElem.classList.remove('signal-glow');
            }
            
            // Update predicted digit
            digitElem.textContent = predictedDigit;
            document.getElementById('digitSource').textContent = 'Based on signal analysis';
            
            // If manual digit is set, use it instead
            const manualDigit = document.getElementById('manualDigit').value;
            if (manualDigit !== '' && signalStrength >= window.signalState.signalThreshold) {
                const manualDigitNum = parseInt(manualDigit);
                if (!isNaN(manualDigitNum) && manualDigitNum >= 0 && manualDigitNum <= 9) {
                    digitElem.textContent = manualDigitNum;
                    document.getElementById('digitSource').textContent = 'Manual override (strong signal)';
                }
            }
        }
        
        // Execute trade based on signal
        function executeSignalTrade(predictedDigit, signalStrength) {
            if (window.signalState.executionLock || window.signalState.stopAfterTrade) {
                return;
            }
            
            // Check if we've reached max trades
            if (window.signalState.totalTrades >= window.signalState.maxTradesPerSession) {
                log(`üõë Maximum trades per session reached (${window.signalState.maxTradesPerSession})`, 'CRITICAL');
                stopBot();
                return;
            }
            
            // Use manual digit if set
            const manualDigit = document.getElementById('manualDigit').value;
            let tradeDigit = predictedDigit;
            
            if (manualDigit !== '') {
                const manualDigitNum = parseInt(manualDigit);
                if (!isNaN(manualDigitNum) && manualDigitNum >= 0 && manualDigitNum <= 9) {
                    tradeDigit = manualDigitNum;
                    log(`üîÑ Using manual digit override: ${tradeDigit}`, 'TRADE');
                }
            }
            
            window.signalState.executionLock = true;
            window.signalState.ticksSinceLastTrade = 0;
            window.signalState.lastTradeTime = Date.now();
            
            // Update UI
            document.getElementById('tradeStatusBadge').textContent = 'EXECUTING TRADE';
            document.getElementById('tradeStatusBadge').className = 'px-3 py-1 bg-yellow-600 text-white text-xs font-bold rounded-full';
            document.getElementById('sessionStatus').textContent = 'Trading';
            document.getElementById('nextTradeTime').textContent = 'Executing...';
            
            log(`‚ö° Executing trade: Digit ${tradeDigit}, Signal: ${signalStrength}%, Stake: $${window.stakeAmount.toFixed(2)}`, 'TRADE');
            
            // Add to trade log
            addTradeLog(`Signal ${signalStrength}% ‚Üí Digit ${tradeDigit} ‚Üí $${window.stakeAmount.toFixed(2)}`, 'EXECUTING');
            
            // Track investment
            trackTradeInvestment(window.stakeAmount);
            
            // Execute the trade
            executeTrade(tradeDigit, signalStrength);
        }
        
        // ============================================================================
        // TRADING FUNCTIONS
        // ============================================================================
        
        // Execute trade via Deriv API
        function executeTrade(digit, signalStrength) {
            const contractType = document.getElementById('contractType').value;
            const symbol = document.getElementById('symbol').value;
            
            const proposalRequest = {
                proposal: 1,
                amount: window.stakeAmount.toFixed(2),
                basis: "stake",
                contract_type: contractType,
                currency: "USD",
                duration: 1,
                duration_unit: "t",
                symbol: symbol,
                barrier: digit.toString(),
                req_id: getNextReqId()
            };
            
            window.signalState.pendingProposals.set(proposalRequest.req_id, {
                digit: digit,
                stake: window.stakeAmount,
                contractType: contractType,
                signalStrength: signalStrength,
                startTime: Date.now()
            });
            
            sendRequest(proposalRequest);
        }
        
        // Handle trade result
        function handleTradeResult(wasWin, digit, stake, signalStrength) {
            window.signalState.executionLock = false;
            window.signalState.totalTrades++;
            
            // Update trade stats
            document.getElementById('totalTrades').textContent = window.signalState.totalTrades;
            
            if (wasWin) {
                window.stats.wins++;
                window.signalState.totalWins++;
                
                const payout = stake * (contractType === 'DIGITMATCH' ? 9 : 0.95);
                trackTradePayout(payout);
                
                // Update UI
                document.getElementById('totalWins').textContent = window.signalState.totalWins;
                const winRate = window.signalState.totalTrades > 0 ? 
                    Math.round((window.signalState.totalWins / window.signalState.totalTrades) * 100) : 0;
                document.getElementById('winRate').textContent = `${winRate}%`;
                
                log(`üéØ WIN! Digit ${digit} matched! Payout: $${payout.toFixed(2)}`, 'WIN');
                addTradeLog(`WIN! Digit ${digit} ‚Üí Payout: $${payout.toFixed(2)}`, 'WIN');
                
                // Update status
                document.getElementById('tradeStatusBadge').textContent = 'WIN! STOPPING';
                document.getElementById('tradeStatusBadge').className = 'px-3 py-1 bg-green-600 text-white text-xs font-bold rounded-full';
                document.getElementById('sessionStatus').textContent = 'Win - Stopping';
                
                // Stop bot after win (as requested)
                setTimeout(() => {
                    if (window.isBotRunning) {
                        stopBot();
                    }
                }, 1000);
                
                window.signalState.stopAfterTrade = true;
                
            } else {
                window.stats.losses++;
                
                log(`‚ùå LOSS! Digit ${digit} did not match`, 'LOSS');
                addTradeLog(`Loss: Digit ${digit} ‚Üí Lost: $${stake.toFixed(2)}`, 'LOSS');
                
                // Update status
                document.getElementById('tradeStatusBadge').textContent = 'LOSS - WAITING';
                document.getElementById('tradeStatusBadge').className = 'px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full';
                document.getElementById('sessionStatus').textContent = 'Loss - Waiting';
                
                // Check if we should continue
                if (window.signalState.totalTrades >= window.signalState.maxTradesPerSession) {
                    log(`üõë Maximum trades per session reached (${window.signalState.maxTradesPerSession})`, 'CRITICAL');
                    setTimeout(() => {
                        if (window.isBotRunning) {
                            stopBot();
                        }
                    }, 1000);
                    window.signalState.stopAfterTrade = true;
                }
            }
            
            // Update next trade time
            document.getElementById('nextTradeTime').textContent = `${window.signalState.minTicksBetweenTrades} ticks`;
            
            // Play audio feedback
            playAudioFeedback(wasWin ? 'WIN' : 'LOSS');
            
            // Update PnL
            updatePnL();
        }
        
        // Add trade to log
        function addTradeLog(message, type) {
            const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            const logEntry = document.createElement('div');
            logEntry.className = 'text-xs p-2 rounded';
            
            let bgColor = 'bg-gray-800';
            let textColor = 'text-gray-300';
            
            switch(type) {
                case 'EXECUTING':
                    bgColor = 'bg-yellow-900/30';
                    textColor = 'text-yellow-300';
                    break;
                case 'WIN':
                    bgColor = 'bg-green-900/30';
                    textColor = 'text-green-300';
                    break;
                case 'LOSS':
                    bgColor = 'bg-red-900/30';
                    textColor = 'text-red-300';
                    break;
            }
            
            logEntry.className = `text-xs p-2 rounded ${bgColor} ${textColor} border-l-4 ${type === 'WIN' ? 'border-green-500' : type === 'LOSS' ? 'border-red-500' : 'border-yellow-500'}`;
            logEntry.innerHTML = `<span class="font-bold">[${timestamp}]</span> ${message}`;
            
            tradeLog.insertBefore(logEntry, tradeLog.firstChild);
            
            // Keep only last 20 entries
            while (tradeLog.children.length > 20) {
                tradeLog.removeChild(tradeLog.lastChild);
            }
            
            // Update last action
            document.getElementById('lastAction').textContent = message.substring(0, 40) + '...';
        }
        
        // Clear trade log
        function clearTradeLog() {
            tradeLog.innerHTML = '<div class="text-xs text-gray-500 italic">No trades executed yet. Waiting for strong signals...</div>';
            document.getElementById('lastAction').textContent = 'Idle';
        }
        
        // ============================================================================
        // CORE BOT FUNCTIONS
        // ============================================================================
        
        // Check for authentication token
        function checkAuthToken() {
            const token = localStorage.getItem('active_token') || localStorage.getItem('derivToken');
            if (!token) {
                log('‚ö†Ô∏è No API token found. Please authenticate first.', 'WARNING');
                return false;
            }
            return true;
        }
        
        // Initialize account toggle
        function initializeToggleState() {
            const token = localStorage.getItem('active_token');
            const allAccounts = JSON.parse(localStorage.getItem('deriv_accounts')) || [];
            
            if (token && allAccounts.length > 0) {
                const currentAccount = allAccounts.find(acc => acc.token === token);
                if (currentAccount) {
                    const isReal = !currentAccount.account.startsWith('VR');
                    document.getElementById('accTypeToggle').checked = isReal;
                    log(`Account: ${isReal ? 'REAL' : 'DEMO'} (${currentAccount.account})`, 'SYSTEM');
                }
            }
        }
        
        // Switch account
        function switchAccount() {
            const isRealRequested = document.getElementById('accTypeToggle').checked;
            const allAccounts = JSON.parse(localStorage.getItem('deriv_accounts')) || [];
            
            const targetAccount = allAccounts.find(acc => 
                isRealRequested ? !acc.account.startsWith('VR') : acc.account.startsWith('VR')
            );
        
            if (targetAccount) {
                localStorage.setItem('active_token', targetAccount.token);
                log(`Switched to ${isRealRequested ? 'REAL' : 'DEMO'} account`, 'SYSTEM');
                
                if (window.isBotRunning) {
                    stopBot();
                    setTimeout(() => startBot(), 1000);
                }
            } else {
                alert(`No ${isRealRequested ? 'Real' : 'Demo'} account found`);
                document.getElementById('accTypeToggle').checked = !isRealRequested;
            }
        }
        
        // Update PnL
        function updatePnL() {
            const pnlElem = document.getElementById('metricTotalProfit');
            
            if (window.startingBalance > 0 && window.currentBalance > 0) {
                window.netProfit = window.currentBalance - window.startingBalance;
                const formattedProfit = window.netProfit.toFixed(2);
                const isPositive = window.netProfit > 0;
                const isNegative = window.netProfit < 0;
                
                pnlElem.textContent = `${isPositive ? '+' : ''}$${formattedProfit}`;
                pnlElem.classList.remove('profit-positive', 'profit-negative', 'profit-neutral');
                
                if (isPositive) pnlElem.classList.add('profit-positive');
                else if (isNegative) pnlElem.classList.add('profit-negative');
                else pnlElem.classList.add('profit-neutral');
                
                return window.netProfit;
            }
            
            if (window.pnlTracker.totalPayout > 0 || window.pnlTracker.totalInvestment > 0) {
                window.netProfit = window.pnlTracker.totalPayout - window.pnlTracker.totalInvestment;
                const formattedProfit = window.netProfit.toFixed(2);
                const isPositive = window.netProfit > 0;
                const isNegative = window.netProfit < 0;
                
                pnlElem.textContent = `${isPositive ? '+' : ''}$${formattedProfit}`;
                pnlElem.classList.remove('profit-positive', 'profit-negative', 'profit-neutral');
                
                if (isPositive) pnlElem.classList.add('profit-positive');
                else if (isNegative) pnlElem.classList.add('profit-negative');
                else pnlElem.classList.add('profit-neutral');
                
                return window.netProfit;
            }
            
            pnlElem.textContent = '$0.00';
            pnlElem.classList.remove('profit-positive', 'profit-negative');
            pnlElem.classList.add('profit-neutral');
            return 0;
        }
        
        function trackTradeInvestment(amount) {
            window.pnlTracker.totalInvestment += parseFloat(amount);
            window.pnlTracker.trades.push({
                type: 'investment',
                amount: parseFloat(amount),
                timestamp: Date.now()
            });
            updatePnL();
        }
        
        function trackTradePayout(amount) {
            window.pnlTracker.totalPayout += parseFloat(amount);
            window.pnlTracker.trades.push({
                type: 'payout',
                amount: parseFloat(amount),
                timestamp: Date.now()
            });
            updatePnL();
        }
        
        function resetPnL() {
            window.pnlTracker = { totalInvestment: 0.0, totalPayout: 0.0, netProfit: 0.0, trades: [] };
            window.startingBalance = 0.0;
            window.currentBalance = 0.0;
            window.netProfit = 0.0;
            updatePnL();
        }
        
        // START/STOP BOT
        function startBot() {
            if (window.isBotRunning) {
                stopBot();
                return;
            }
            
            if (!checkAuthToken()) {
                log('‚ùå No API token found. Please authenticate first.', 'CRITICAL');
                return;
            }
            
            // Update settings from UI
            updateSettingsFromUI();
            
            // Reset state
            resetAllState();
            
            window.isBotRunning = true;
            updateButtonState();
            
            log('üöÄ Starting Signal-Based Bot...', 'SYSTEM');
            log(`üìä Signal threshold: ${window.signalState.signalThreshold}% (STRONG required)`, 'SYSTEM');
            log(`üìä Analysis window: ${window.signalState.analysisWindow} ticks`, 'SYSTEM');
            log(`üéØ Bot will stop automatically after win`, 'SYSTEM');
            log(`üí∞ Stake amount: $${window.stakeAmount.toFixed(2)}`, 'SYSTEM');
            
            // Update UI
            document.getElementById('tradeStatusBadge').textContent = 'ANALYZING';
            document.getElementById('tradeStatusBadge').className = 'px-3 py-1 bg-blue-600 text-white text-xs font-bold rounded-full';
            document.getElementById('sessionStatus').textContent = 'Analyzing';
            document.getElementById('nextTradeTime').textContent = `${window.signalState.minTicksBetweenTrades} ticks`;
            document.getElementById('metricCurrentStake').textContent = `$${window.stakeAmount.toFixed(2)}`;
            
            // Disable controls
            document.querySelectorAll('#symbol, #contractType, #stakeAmount, #manualDigit, #signalThreshold, #analysisWindow, #minTicksBetween, #maxTradesPerSession').forEach(control => {
                control.disabled = true;
                control.classList.add('opacity-50', 'cursor-not-allowed');
            });
            
            // Initialize audio and connect
            initTone();
            connectWebSocket();
        }
        
        function stopBot() {
            if (!window.isBotRunning) return;
            
            window.isBotRunning = false;
            updateButtonState();
            
            log('‚èπÔ∏è Bot stopped', 'SYSTEM');
            
            if (window.ws) {
                window.ws.close();
                window.ws = null;
            }
            
            // Enable controls
            document.querySelectorAll('#symbol, #contractType, #stakeAmount, #manualDigit, #signalThreshold, #analysisWindow, #minTicksBetween, #maxTradesPerSession').forEach(control => {
                control.disabled = false;
                control.classList.remove('opacity-50', 'cursor-not-allowed');
            });
            
            // Update UI
            document.getElementById('tradeStatusBadge').textContent = 'STOPPED';
            document.getElementById('tradeStatusBadge').className = 'px-3 py-1 bg-gray-600 text-white text-xs font-bold rounded-full';
            document.getElementById('sessionStatus').textContent = 'Stopped';
            document.getElementById('nextTradeTime').textContent = '--';
            
            // Update connection status
            updateConnectionStatus();
            
            // Final PnL update
            const finalPnL = updatePnL();
            log(`üí∞ Final PnL: ${finalPnL >= 0 ? '+' : ''}$${finalPnL.toFixed(2)}`, 'PNL');
        }
        
        function toggleBot() {
            if (window.isBotRunning) {
                stopBot();
            } else {
                startBot();
            }
        }
        
        // Update settings from UI
        function updateSettingsFromUI() {
            window.signalState.signalThreshold = parseInt(document.getElementById('signalThreshold').value);
            window.signalState.analysisWindow = parseInt(document.getElementById('analysisWindow').value);
            window.signalState.minTicksBetweenTrades = parseInt(document.getElementById('minTicksBetween').value);
            window.signalState.maxTradesPerSession = parseInt(document.getElementById('maxTradesPerSession').value);
            window.stakeAmount = parseFloat(document.getElementById('stakeAmount').value) || 1.0;
            
            // Update weights
            window.signalState.signalWeights.pattern = parseInt(document.getElementById('patternWeightSlider').value);
            window.signalState.signalWeights.frequency = parseInt(document.getElementById('frequencyWeightSlider').value);
            window.signalState.signalWeights.trend = parseInt(document.getElementById('trendWeightSlider').value);
            
            // Update display
            document.getElementById('thresholdValue').textContent = `${window.signalState.signalThreshold}%`;
            document.getElementById('patternWeight').textContent = `${window.signalState.signalWeights.pattern}%`;
            document.getElementById('frequencyWeight').textContent = `${window.signalState.signalWeights.frequency}%`;
            document.getElementById('trendWeight').textContent = `${window.signalState.signalWeights.trend}%`;
        }
        
        // Update analysis window
        function updateAnalysisWindow() {
            const newWindow = parseInt(document.getElementById('analysisWindow').value);
            if (newWindow >= 10 && newWindow <= 100) {
                window.signalState.analysisWindow = newWindow;
                log(`üìä Analysis window updated to ${newWindow} ticks`, 'SETTINGS');
            }
        }
        
        // Reset all state
        function resetAllState() {
            window.signalState.tickHistory = [];
            window.signalState.ticksSinceLastTrade = 0;
            window.signalState.lastTradeTime = 0;
            window.signalState.totalTrades = 0;
            window.signalState.totalWins = 0;
            window.signalState.sessionActive = false;
            window.signalState.waitingForSignal = true;
            window.signalState.executionLock = false;
            window.signalState.stopAfterTrade = false;
            window.signalState.totalSignals = 0;
            window.signalState.strongSignals = 0;
            window.signalState.signalHistory = [];
            window.signalState.currentSignal = null;
            window.signalState.lastSignalTime = 0;
            window.signalState.pendingProposals.clear();
            
            resetPnL();
            
            window.startingBalance = 0.0;
            window.currentBalance = 0.0;
            window.netProfit = 0.0;
            
            window.stats = { totalTicks: 0, tradesExecuted: 0, wins: 0, losses: 0 };
            window.botTickTimestamps = [];
            window.tickTimestamps = [];
            window.totalTicksReceived = 0;
            window.lastTickTime = 0;
            
            // Reset UI
            document.getElementById('totalTrades').textContent = '0';
            document.getElementById('totalWins').textContent = '0';
            document.getElementById('winRate').textContent = '0%';
            document.getElementById('avgSignal').textContent = '0%';
            document.getElementById('totalSignals').textContent = '0';
            document.getElementById('strongSignals').textContent = '0';
            document.getElementById('lastSignalTime').textContent = '--';
            document.getElementById('metricAccountBalance').textContent = '$---';
            document.getElementById('metricLiveTick').textContent = '---';
            document.getElementById('metricLastDigit').textContent = 'Digit: ?';
            
            updateSignalDisplay(0, '?');
            
            log('üîÑ Bot state reset', 'SYSTEM');
        }
        
        // HELPER FUNCTIONS
        function toggleSound() {
            window.soundEnabled = !window.soundEnabled;
            localStorage.setItem('soundEnabled', window.soundEnabled);
            updateSoundButton();
            log(`üîä Sound ${window.soundEnabled ? 'ON' : 'OFF'}`, 'SYSTEM');
        }
        
        function updateSoundButton() {
            if (soundToggleButton) {
                soundToggleButton.textContent = window.soundEnabled ? 'üîä Sound ON' : 'üîá Sound OFF';
                soundToggleButton.className = window.soundEnabled ? 
                    'px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700 transition' :
                    'px-4 py-2 bg-gray-600 text-white font-bold rounded-lg shadow hover:bg-gray-700 transition';
            }
        }
        
        async function initTone() {
            if (!window.soundEnabled) return;
            
            if (typeof Tone === 'undefined') {
                console.error("Tone.js not loaded");
                return;
            }
            
            try {
                await Tone.start();
                window.synth = new Tone.Synth().toDestination();
                window.ToneInitialized = true;
            } catch (e) {
                console.error("Audio init error:", e);
            }
        }
        
        function playAudioFeedback(type) {
            if (!window.soundEnabled || !window.ToneInitialized || !window.synth) return;
            
            try {
                if (type === 'WIN') {
                    window.synth.triggerAttackRelease("C5", "8n");
                    setTimeout(() => window.synth.triggerAttackRelease("E5", "8n"), 100);
                    setTimeout(() => window.synth.triggerAttackRelease("G5", "8n"), 200);
                } else if (type === 'TICK') {
                    window.synth.triggerAttackRelease("C4", "32n", Tone.now(), 0.1);
                } else if (type === 'LOSS') {
                    window.synth.triggerAttackRelease("C3", "8n", Tone.now(), 0.5);
                }
            } catch (e) {
                console.error("Audio error:", e);
            }
        }
        
        function log(message, type = 'INFO') {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            let color = 'text-lime-400';
            if (type === 'ERROR') color = 'text-red-500 font-bold'; 
            if (type === 'WARNING') color = 'text-yellow-400';
            if (type === 'TRADE') color = 'text-green-300';
            if (type === 'WIN') color = 'text-green-400 font-bold';
            if (type === 'LOSS') color = 'text-red-400 font-bold';
            if (type === 'TICK') color = 'text-cyan-300';
            if (type === 'SYSTEM') color = 'text-white';
            if (type === 'SIGNAL') color = 'text-purple-300 font-bold';
            if (type === 'SETTINGS') color = 'text-blue-300 font-bold';
            
            logArea.innerHTML += `\n[${timestamp}] <span class="${color}">${message}</span>`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function updateButtonState() {
            if (!toggleButton) return;
            
            if (window.isBotRunning) {
                toggleButton.innerHTML = '<span class="flex items-center justify-center"><span class="mr-2">‚èπÔ∏è</span> STOP BOT</span>';
                toggleButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'start-button-active');
                toggleButton.classList.add('stop-button-active', 'hover:bg-red-700');
            } else {
                toggleButton.innerHTML = '<span class="flex items-center justify-center"><span class="mr-2">üöÄ</span> START SIGNAL BOT</span>';
                toggleButton.classList.remove('stop-button-active', 'hover:bg-red-700');
                toggleButton.classList.add('bg-green-600', 'hover:bg-green-700', 'start-button-active');
            }
        }
        
        function updateConnectionStatus() {
            const isConnected = window.ws && window.ws.readyState === WebSocket.OPEN;
            const isConnecting = window.isConnecting || false;
            
            if (isConnected) {
                document.getElementById('status-badge').textContent = 'üü¢ CONNECTED';
                document.getElementById('status-badge').className = 'ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full connection-badge-connected text-white shadow-md';
            } else if (isConnecting) {
                document.getElementById('status-badge').textContent = 'üü° CONNECTING';
                document.getElementById('status-badge').className = 'ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full connection-badge-connecting text-white shadow-md';
            } else {
                document.getElementById('status-badge').textContent = 'üî¥ DISCONNECTED';
                document.getElementById('status-badge').className = 'ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full connection-badge-disconnected text-white shadow-md';
            }
        }
        
        // WEBSOCKET CONNECTION
        function connectWebSocket() {
            if (window.ws) {
                try {
                    window.ws.close();
                } catch (e) {}
            }
            
            window.isConnecting = true;
            updateConnectionStatus();
            
            const wsUrl = 'wss://ws.binaryws.com/websockets/v3?app_id=118332';
            log('üîó Connecting to Deriv API...', 'SYSTEM');
            
            window.ws = new WebSocket(wsUrl);
            
            window.ws.onopen = () => {
                window.isConnecting = false;
                log('‚úÖ WebSocket connected', 'SYSTEM');
                updateConnectionStatus();
                
                const token = localStorage.getItem('active_token') || localStorage.getItem('derivToken');
                if (!token) {
                    log('‚ùå No API token found in storage', 'ERROR');
                    stopBot();
                    return;
                }
                
                sendRequest({ 
                    authorize: token, 
                    req_id: getNextReqId() 
                });
            };
            
            window.ws.onmessage = (msg) => {
                try {
                    const data = JSON.parse(msg.data);
                    handleAPIResponse(data);
                } catch (e) {
                    console.error('WebSocket message error:', e);
                }
            };
            
            window.ws.onclose = () => {
                window.isConnecting = false;
                updateConnectionStatus();
                log('üîå WebSocket disconnected', 'SYSTEM');
                
                if (window.isBotRunning) {
                    log('üîÑ Attempting to reconnect...', 'SYSTEM');
                    setTimeout(() => {
                        if (window.isBotRunning) {
                            connectWebSocket();
                        }
                    }, 2000);
                }
            };
            
            window.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                log('‚ùå WebSocket connection error', 'ERROR');
            };
        }
        
        function sendRequest(request) {
            if (window.ws && window.ws.readyState === WebSocket.OPEN) {
                const message = JSON.stringify(request);
                window.ws.send(message);
                return request.req_id;
            }
            return null;
        }
        
        function getNextReqId() {
            return ++window.req_id;
        }
        
        function handleAPIResponse(data) {
            if (data.error) {
                log(`API Error: ${data.error.message}`, 'ERROR');
                if (data.error.code === 'InvalidToken') {
                    log('‚ùå Invalid API Token. Please check your authentication.', 'CRITICAL');
                    stopBot();
                }
                return;
            }
        
            if (data.msg_type === 'authorize') {
                if (data.authorize) {
                    log(`üîê Authorized as ${data.authorize.loginid}`, 'SYSTEM');
                    subscribeToTicks(document.getElementById('symbol').value);
                    subscribeToBalance();
                }
            } else if (data.msg_type === 'tick') {
                processTickForSignalAnalysis(data.tick);
            } else if (data.msg_type === 'proposal') {
                handleProposalResponse(data.proposal, data.req_id);
            } else if (data.msg_type === 'buy') {
                handleBuyResponse(data.buy);
            } else if (data.msg_type === 'balance') {
                handleBalanceUpdate(data.balance);
            }
        }
        
        function subscribeToBalance() {
            sendRequest({ balance: 1, subscribe: 1, req_id: getNextReqId() });
            log('üí∞ Subscribed to balance', 'SYSTEM');
        }
        
        function handleBalanceUpdate(balanceData) {
            const newBalance = parseFloat(balanceData.balance);
            
            if (window.startingBalance === 0) {
                window.startingBalance = newBalance;
                log(`üí∞ Starting Balance: $${window.startingBalance.toFixed(2)}`, 'PNL');
            }
            
            window.currentBalance = newBalance;
            const balanceElem = document.getElementById('metricAccountBalance');
            balanceElem.textContent = `$${window.currentBalance.toFixed(2)}`;
            balanceElem.className = 'text-lg font-bold balance-green';
            updatePnL();
        }
        
        function subscribeToTicks(symbol) {
            sendRequest({ ticks: symbol, subscribe: 1, req_id: getNextReqId() });
            log(`‚úÖ Subscribed to ${symbol} ticks`, 'SYSTEM');
        }
        
        function handleProposalResponse(proposal, req_id) {
            if (!proposal || !proposal.id) {
                log(`‚ùå Proposal failed`, 'ERROR');
                addTradeLog('Proposal failed - Retrying...', 'LOSS');
                window.signalState.executionLock = false;
                return;
            }
        
            const pending = window.signalState.pendingProposals.get(req_id);
            if (!pending) return;
        
            window.signalState.pendingProposals.delete(req_id);
            executeBuy(proposal.id, proposal.ask_price, pending);
        }
        
        function executeBuy(proposal_id, ask_price, pending) {
            const buyRequest = {
                buy: proposal_id,
                price: ask_price,
                req_id: getNextReqId()
            };
            
            log(`‚úÖ Buying: $${pending.stake.toFixed(2)} on digit ${pending.digit}`, 'TRADE');
            
            window.signalState.pendingProposals.set(buyRequest.req_id, {
                ...pending,
                proposal_id: proposal_id,
                buyStartTime: Date.now()
            });
            
            sendRequest(buyRequest);
        }
        
        function handleBuyResponse(buyData) {
            if (buyData.contract_id) {
                log(`‚úÖ Trade executed successfully`, 'TRADE');
                
                // Check if this was a win or loss
                const wasWin = buyData.longcode && buyData.longcode.includes("win");
                
                const pending = window.signalState.pendingProposals.get(buyData.req_id);
                if (pending) {
                    window.signalState.pendingProposals.delete(buyData.req_id);
                    handleTradeResult(wasWin, pending.digit, pending.stake, pending.signalStrength);
                }
            } else {
                log(`‚ùå Trade failed`, 'ERROR');
                addTradeLog('Trade execution failed', 'LOSS');
                window.signalState.executionLock = false;
            }
        }
        
        // DOM Ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ü§ñ Signal-Based Bot Initialized');
            initializeToggleState();
            
            // Initialize settings
            updateSettingsFromUI();
            
            // Add event listeners for sliders
            document.getElementById('signalThreshold').addEventListener('input', function() {
                document.getElementById('thresholdValue').textContent = `${this.value}%`;
                window.signalState.signalThreshold = parseInt(this.value);
            });
            
            document.getElementById('patternWeightSlider').addEventListener('input', function() {
                document.getElementById('patternWeight').textContent = `${this.value}%`;
                window.signalState.signalWeights.pattern = parseInt(this.value);
            });
            
            document.getElementById('frequencyWeightSlider').addEventListener('input', function() {
                document.getElementById('frequencyWeight').textContent = `${this.value}%`;
                window.signalState.signalWeights.frequency = parseInt(this.value);
            });
            
            document.getElementById('trendWeightSlider').addEventListener('input', function() {
                document.getElementById('trendWeight').textContent = `${this.value}%`;
                window.signalState.signalWeights.trend = parseInt(this.value);
            });
            
            // Update next check timer
            setInterval(() => {
                if (window.signalState.lastSignalTime > 0) {
                    const nextCheck = Math.max(0, window.signalState.minTicksBetweenTrades - window.signalState.ticksSinceLastTrade);
                    document.getElementById('nextCheck').textContent = nextCheck > 0 ? `${nextCheck} ticks` : 'Ready';
                } else {
                    document.getElementById('nextCheck').textContent = '--';
                }
            }, 1000);
            
            log('ü§ñ Signal-Based DigitMatch Bot Ready', 'SYSTEM');
            log('üéØ Bot will execute trades only on STRONG signals (>85%)', 'SYSTEM');
            log('‚èπÔ∏è Bot will stop automatically after a win', 'SYSTEM');
        });
    </script>
</body>
</html>
